<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Migrating Oracle ASM storage - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="Oracle memoranda">



<meta name="keywords" content="oracle, database">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Migrating Oracle ASM storage
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-07-31T00:44:10.000Z" itemprop="datePublished">Jul 31 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
                    <span id="busuanzi_container_page_pv" style='display:none'>
Viewd <span id="busuanzi_value_page_pv"></span> times.
</span>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>This post is about how to migrate Oracle asm data to another storage, for my environment, is migrating from HHD storage to SSD storage, the redo blocksize also need to be modified to 4K for good performance.</p>
<a id="more"></a>
<h1 id="1-Preparation-for-migration"><a href="#1-Preparation-for-migration" class="headerlink" title="1. Preparation for migration"></a>1. Preparation for migration</h1><h1 id="1-1-Backup-whole-database"><a href="#1-1-Backup-whole-database" class="headerlink" title="1.1 Backup whole database"></a>1.1 Backup whole database</h1><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RMAN&gt;</span><br><span class="line"><span class="hljs-keyword">backup</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">format</span> <span class="hljs-string">'/backup/rman_full_%U'</span> tag=<span class="hljs-string">'db_full_bak'</span></span><br><span class="line"><span class="hljs-keyword">including</span> <span class="hljs-keyword">archive</span> <span class="hljs-keyword">log</span> all;</span><br></pre></td></tr></table></figure>
<h1 id="1-2-Verify-file-types-and-numbers-in-the-ASM"><a href="#1-2-Verify-file-types-and-numbers-in-the-ASM" class="headerlink" title="1.2 Verify file types and numbers in the ASM"></a>1.2 Verify file types and numbers in the ASM</h1><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">-- grid user</span></span><br><span class="line">sqlplus "/as sysasm"</span><br><span class="line"><span class="hljs-keyword">select</span> d.name group_name,f.type,<span class="hljs-keyword">count</span>(*) cnt <span class="hljs-keyword">from</span> v$asm_file f</span><br><span class="line">    <span class="hljs-keyword">join</span> v$asm_diskgroup d <span class="hljs-keyword">on</span> f.group_number=d.group_number</span><br><span class="line">    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">rollup</span> (d.name,f.type);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--output example</span></span><br><span class="line">GROUP_NAME                  TYPE                              CNT</span><br><span class="line"><span class="hljs-comment">--------------------------- -------------------------- ----------</span></span><br><span class="line">CRS                         OCRFILE                             1</span><br><span class="line">CRS                         DATAFILE                           11</span><br><span class="line">CRS                         PASSWORD                            1</span><br><span class="line">CRS                         TEMPFILE                            3</span><br><span class="line">CRS                         ONLINELOG                           3</span><br><span class="line">CRS                         CONTROLFILE                         1</span><br><span class="line">CRS                         PARAMETERFILE                       1</span><br><span class="line">CRS                         ASMPARAMETERFILE                    1</span><br><span class="line">CRS                                                            22</span><br><span class="line">FRA                         ONLINELOG                           8</span><br><span class="line">FRA                         ARCHIVELOG                          9</span><br><span class="line">FRA                         CONTROLFILE                         1</span><br><span class="line">FRA                                                            18</span><br><span class="line">DBDATA                      DATAFILE                           25</span><br><span class="line">DBDATA                      PASSWORD                            1</span><br><span class="line">DBDATA                      TEMPFILE                            6</span><br><span class="line">DBDATA                      PARAMETERFILE                       1</span><br><span class="line">DBDATA                                                         33</span><br><span class="line">                                                               73</span><br></pre></td></tr></table></figure>
<h1 id="1-3-Verify-asm-diskstrings-parameter"><a href="#1-3-Verify-asm-diskstrings-parameter" class="headerlink" title="1.3 Verify asm_diskstrings parameter"></a>1.3 Verify asm_diskstrings parameter</h1><p>Must include new storage path in the asm_diskstrings.</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--grid user</span></span><br><span class="line"><span class="hljs-keyword">show</span> parameter asm_diskstring</span><br></pre></td></tr></table></figure>
<h1 id="1-4-Verify-current-ASM-disks-and-diskgroups-mapping-information"><a href="#1-4-Verify-current-ASM-disks-and-diskgroups-mapping-information" class="headerlink" title="1.4 Verify current ASM disks and diskgroups mapping information"></a>1.4 Verify current ASM disks and diskgroups mapping information</h1><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--grid user</span></span><br><span class="line">sqlplus "/as sysasm"</span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span> pagesize <span class="hljs-number">200</span></span><br><span class="line"><span class="hljs-keyword">col</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">for</span> a10</span><br><span class="line"><span class="hljs-keyword">col</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">for</span> a40</span><br><span class="line"><span class="hljs-keyword">select</span> group_number,<span class="hljs-keyword">name</span>,OS_MB ,TOTAL_MB,FREE_MB ,HOT_USED_MB,COLD_USED_MB,<span class="hljs-keyword">PATH</span> ,SECTOR_SIZE <span class="hljs-keyword">from</span> v$asm_disk <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">col PATH for a30</span><br><span class="line">col DG_NAME for a10</span><br><span class="line">col DG_STATE for a10</span><br><span class="line">col FAILGROUP for a15</span><br><span class="line">col name for a20</span><br><span class="line"><span class="hljs-keyword">set</span> <span class="hljs-keyword">lines</span> <span class="hljs-number">200</span> pages <span class="hljs-number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">select</span> dg.name dg_name, dg.state dg_state, dg.type, d.disk_number dsk_no,</span><br><span class="line">d.path, d.mount_status, d.FAILGROUP,d.name, d.state</span><br><span class="line"><span class="hljs-keyword">from</span> v$asm_diskgroup dg, v$asm_disk d</span><br><span class="line"><span class="hljs-keyword">where</span> dg.group_number=d.group_number</span><br><span class="line"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> dg_name, dsk_no;</span><br></pre></td></tr></table></figure>
<h2 id="1-5-Backup-ASM-diskgroup-metadata-and-OCR-Voting-disk-information"><a href="#1-5-Backup-ASM-diskgroup-metadata-and-OCR-Voting-disk-information" class="headerlink" title="1.5 Backup ASM diskgroup metadata and OCR/Voting disk information"></a>1.5 Backup ASM diskgroup metadata and OCR/Voting disk information</h2><ul>
<li>Query OCR and voting disk information</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--root user</span></span><br><span class="line">/u01/app/12.1.0/grid/bin/crsctl query css votedisk</span><br><span class="line">/u01/app/12.1.0/grid/bin/ocrcheck</span><br><span class="line">cat /etc/oracle/ocr.loc</span><br></pre></td></tr></table></figure>
<ul>
<li>Backup OLR and OCR</li>
</ul>
<p>Because voting disk is backed up by Oracle automatically, no need to backup again.<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--root user</span></span><br><span class="line"><span class="hljs-comment">--check the backup</span></span><br><span class="line">/u01/app/12.1.0/grid/bin/ocrconfig -showbackup</span><br><span class="line"><span class="hljs-comment">--backup olr</span></span><br><span class="line">/u01/app/12.1.0/grid/bin/ocrconfig -local -manualbackup</span><br><span class="line"><span class="hljs-comment">--backup ocr</span></span><br><span class="line">/u01/app/12.1.0/grid/bin/ocrconfig -manualbackup</span><br></pre></td></tr></table></figure></p>
<ul>
<li>Backup asm diskgroup metadata</li>
</ul>
<figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ASMCMD [+] &gt; md_backup /home/grid/ocrvote.bak -G OCR</span><br><span class="line">ASMCMD [+] &gt; md_backup /home/grid/datadg.bak -G DBDATA</span><br><span class="line">ASMCMD [+] &gt; md_backup /home/grid/fradg.bak -G FRA</span><br><span class="line">srvctl config asm &gt; /home/grid/ocr_config.bak</span><br></pre></td></tr></table></figure>
<ul>
<li>Backup ASM spfile</li>
</ul>
<figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--grid user</span></span><br><span class="line">$ORACLE_HOME/bin/gpnptool get -o- | xmllint <span class="hljs-comment">--format - | grep -i spfile</span></span><br><span class="line">asmcmd spget</span><br><span class="line">sqlplus / as sysasm</span><br><span class="line">SQL&gt; create pfile = '/home/grid/pfile_asm.txt' from spfile;</span><br></pre></td></tr></table></figure>
<h1 id="2-Migrating-ASM-diskgroups"><a href="#2-Migrating-ASM-diskgroups" class="headerlink" title="2. Migrating ASM diskgroups"></a>2. Migrating ASM diskgroups</h1><h2 id="2-1-Adding-new-disk-to-diskgroups"><a href="#2-1-Adding-new-disk-to-diskgroups" class="headerlink" title="2.1 Adding new disk to diskgroups"></a>2.1 Adding new disk to diskgroups</h2><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--grid user</span></span><br><span class="line">sqlplus / as sysasm</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DISKGROUP</span> fra <span class="hljs-keyword">ADD</span> DISK   <span class="hljs-string">'/dev/mapper/fra_new_01'</span>, <span class="hljs-string">'/dev/mapper/fra_new_02'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--Monitoring rebalance progress</span></span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">3000</span></span><br><span class="line"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> gv$asm_operation;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--Speed up rebalance</span></span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">diskgroup</span> fra rebalance <span class="hljs-keyword">power</span> <span class="hljs-number">48</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--Put rebalance power back to 1 after rebalancing</span></span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">diskgroup</span> fra rebalance <span class="hljs-keyword">power</span> <span class="hljs-number">1</span>;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-Dropping-old-disk"><a href="#2-2-Dropping-old-disk" class="headerlink" title="2.2 Dropping old disk"></a>2.2 Dropping old disk</h2><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--grid user</span></span><br><span class="line">sqlplus / as sysasm</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--It's better to drop disk one by one</span></span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DISKGROUP</span> fra <span class="hljs-keyword">drop</span> DISK <span class="hljs-string">'FRA_0000'</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DISKGROUP</span> fra <span class="hljs-keyword">drop</span> DISK <span class="hljs-string">'FRA_0001'</span>;</span><br></pre></td></tr></table></figure>
<p>Also, monitor and adjust rebalance power if needed.</p>
<p>For all the diskgroups in ASM, repeat step 2.1 - 2.2 one diskgroup by one diskgroup.</p>
<h2 id="2-3-Verify-migration-result"><a href="#2-3-Verify-migration-result" class="headerlink" title="2.3 Verify migration result"></a>2.3 Verify migration result</h2><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sqlplus "/as sysasm"</span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span> pagesize <span class="hljs-number">200</span></span><br><span class="line"><span class="hljs-keyword">col</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">for</span> a10</span><br><span class="line"><span class="hljs-keyword">col</span> <span class="hljs-keyword">path</span> <span class="hljs-keyword">for</span> a40</span><br><span class="line"><span class="hljs-keyword">select</span> group_number,<span class="hljs-keyword">name</span>,OS_MB ,TOTAL_MB,FREE_MB ,HOT_USED_MB,</span><br><span class="line">COLD_USED_MB,<span class="hljs-keyword">PATH</span> ,SECTOR_SIZE <span class="hljs-keyword">from</span> v$asm_disk <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>;</span><br><span class="line"></span><br><span class="line">col PATH for a30</span><br><span class="line">col DG_NAME for a10</span><br><span class="line">col DG_STATE for a10</span><br><span class="line">col FAILGROUP for a15</span><br><span class="line">col name for a20</span><br><span class="line"><span class="hljs-keyword">set</span> <span class="hljs-keyword">lines</span> <span class="hljs-number">200</span> pages <span class="hljs-number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">select</span> dg.name dg_name, dg.state dg_state, dg.type, d.disk_number dsk_no,</span><br><span class="line">d.path, d.mount_status, d.FAILGROUP,d.name, d.state</span><br><span class="line"><span class="hljs-keyword">from</span> v$asm_diskgroup dg, v$asm_disk d</span><br><span class="line"><span class="hljs-keyword">where</span> dg.group_number=d.group_number</span><br><span class="line"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> dg_name, dsk_no;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">select</span> d.name group_name,f.type,<span class="hljs-keyword">count</span>(*) cnt <span class="hljs-keyword">from</span> v$asm_file f</span><br><span class="line">    <span class="hljs-keyword">join</span> v$asm_diskgroup d <span class="hljs-keyword">on</span> f.group_number=d.group_number</span><br><span class="line">    <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">rollup</span> (d.name,f.type);</span><br></pre></td></tr></table></figure>
<h1 id="3-Modify-redo-log-file-39-s-blocksize"><a href="#3-Modify-redo-log-file-39-s-blocksize" class="headerlink" title="3. Modify redo log file&#39;s blocksize"></a>3. Modify redo log file&#39;s blocksize</h1><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--oracle user</span></span><br><span class="line"><span class="hljs-comment">--query current log info</span></span><br><span class="line">col member for a80</span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span> pagesize <span class="hljs-number">999</span></span><br><span class="line"><span class="hljs-keyword">select</span> a.inst_id,<span class="hljs-keyword">thread</span>#,a.status, a.bytes/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>,a.group#,b.type,<span class="hljs-keyword">member</span>, a.blocksize</span><br><span class="line"><span class="hljs-keyword">from</span> gv$<span class="hljs-keyword">log</span> a,gv$<span class="hljs-keyword">logfile</span> b</span><br><span class="line"><span class="hljs-keyword">where</span> a.group#=b.group#</span><br><span class="line"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">5</span>;</span><br></pre></td></tr></table></figure>
<p>We need to add hidden parameter <code>_disk_sector_size_override</code> for modifing redo blocksize, this parameter is dynamic, no instance recycle needed.</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> <span class="hljs-string">"_disk_sector_size_override"</span>=<span class="hljs-literal">TRUE</span> <span class="hljs-keyword">scope</span>=<span class="hljs-keyword">both</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Add new redo log</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">1</span> <span class="hljs-keyword">group</span> <span class="hljs-number">9</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">1</span> <span class="hljs-keyword">group</span> <span class="hljs-number">10</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">1</span> <span class="hljs-keyword">group</span> <span class="hljs-number">11</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">1</span> <span class="hljs-keyword">group</span> <span class="hljs-number">12</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">2</span> <span class="hljs-keyword">group</span> <span class="hljs-number">13</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">2</span> <span class="hljs-keyword">group</span> <span class="hljs-number">14</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">2</span> <span class="hljs-keyword">group</span> <span class="hljs-number">15</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">add</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">thread</span> <span class="hljs-number">2</span> <span class="hljs-keyword">group</span> <span class="hljs-number">16</span> (<span class="hljs-string">'+FRA'</span>) <span class="hljs-keyword">size</span> <span class="hljs-number">2048</span>M <span class="hljs-keyword">blocksize</span> <span class="hljs-number">4096</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Drop old redo groups</li>
</ul>
<p>Ensure the log groups need to be dropped are in <code>inactive</code> status, by switching log, and checkpoint, we can put target redo groups in <code>inactive</code> state</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">ARCHIVE</span> <span class="hljs-keyword">LOG</span> <span class="hljs-keyword">CURRENT</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">ARCHIVE</span> <span class="hljs-keyword">LOG</span> <span class="hljs-keyword">CURRENT</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> checkpoint;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> checkpoint;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--Confirm target redo group is in inactive status</span></span><br><span class="line">col member for a80</span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span></span><br><span class="line"><span class="hljs-keyword">select</span> a.inst_id,<span class="hljs-keyword">thread</span>#,a.status, a.bytes/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>,a.group#,b.type,<span class="hljs-keyword">member</span>, a.blocksize</span><br><span class="line"><span class="hljs-keyword">from</span> gv$<span class="hljs-keyword">log</span> a,gv$<span class="hljs-keyword">logfile</span> b</span><br><span class="line"><span class="hljs-keyword">where</span> a.group#=b.group#</span><br><span class="line"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--Drop old group</span></span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">1</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">2</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">3</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">4</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">5</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">6</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">7</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--Backup controlfile</span></span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">backup</span> <span class="hljs-keyword">controlfile</span>;</span><br></pre></td></tr></table></figure>
<h1 id="4-Risk-assessment"><a href="#4-Risk-assessment" class="headerlink" title="4. Risk assessment"></a>4. Risk assessment</h1><ul>
<li>If ASM diskgroup is too large, rebalance maybe can&#39;t complete in the change window</li>
<li>Setting rebalance power too high would cause bad performance</li>
</ul>
<p>It&#39;s recommended to schedule multiple change window if data amount is too large.</p>
<h1 id="5-Backout"><a href="#5-Backout" class="headerlink" title="5. Backout"></a>5. Backout</h1><p>Adding disks is a low risk operation, except rebalance power set to high and impact the performance. Under such circumstance, lower down rebalance power speed:</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">diskgroup</span> DG_NAME rebalance <span class="hljs-keyword">power</span> <span class="hljs-number">1</span>;</span><br></pre></td></tr></table></figure>
<p>If something wrong with dropping disks, stop dropping operation by below command, only available for status = dropping in <code>v$asm_disk</code>:</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DISKGROUP</span> data1 UNDROP DISKS;</span><br></pre></td></tr></table></figure>
<p>If something wrong with OCR or voting disk during migrating or RAC can&#39;t be started after migrating, follow below steps to restore OCR:</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--root user, stop crs resource on all nodes</span></span><br><span class="line">crsctl <span class="hljs-keyword">stop</span> crs -f</span><br><span class="line">crsctl <span class="hljs-keyword">stop</span> <span class="hljs-keyword">resource</span> ora.crsd -init</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--root user, start crs in one node only in exclusive mode</span></span><br><span class="line">crsctl <span class="hljs-keyword">start</span> crs -excl -nocrs</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--restore OCR</span></span><br><span class="line">ocrconfig -<span class="hljs-keyword">restore</span> OCR_BACKUP_FILENAME</span><br><span class="line"><span class="hljs-comment">--check the status</span></span><br><span class="line">ocrcheck</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--restore voting disk</span></span><br><span class="line">crsctl <span class="hljs-keyword">replace</span> votedisk +asm_disk_group</span><br><span class="line"><span class="hljs-comment">--check the status</span></span><br><span class="line">crsctl <span class="hljs-keyword">query</span> css votedisk</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--restart RAC cluster</span></span><br><span class="line">crsctl <span class="hljs-keyword">stop</span> crs -f</span><br><span class="line"></span><br><span class="line">crsctl <span class="hljs-keyword">stop</span> cluster -all</span><br><span class="line">crsctl <span class="hljs-keyword">start</span> cluster -all</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--check all nodes OCR with CVU tool</span></span><br><span class="line">cluvfy comp ocr -n all -verbose</span><br><span class="line">crsctl <span class="hljs-keyword">check</span> cluster -all</span><br></pre></td></tr></table></figure>
<h1 id="6-Alternative-way-of-migrating"><a href="#6-Alternative-way-of-migrating" class="headerlink" title="6. Alternative way of migrating"></a>6. Alternative way of migrating</h1><p>Previous steps are available for online migration, we also can use rman copy to migrate, which need to stop database.</p>
<p>Assume we&#39;ve create a new diskgroup named DATA_NEW, our purpose is to restore the whole database to DATA_NEW diskgroup.</p>
<ul>
<li>Backup database as copy into new diskgroup</li>
</ul>
<figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">run &#123;</span><br><span class="line">allocate channel c1 type disk;</span><br><span class="line">allocate channel c2 type disk;</span><br><span class="line"><span class="hljs-keyword">backup</span> <span class="hljs-keyword">as</span> copy <span class="hljs-keyword">database</span> <span class="hljs-keyword">format</span> <span class="hljs-string">'+data_new'</span>;</span><br><span class="line"><span class="hljs-keyword">release</span> channel c1;</span><br><span class="line"><span class="hljs-keyword">release</span> channel c2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RMAN&gt; list copy;</span><br></pre></td></tr></table></figure>
<ul>
<li>After backing up, restart database to mount status</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">srvctl <span class="hljs-keyword">stop</span> <span class="hljs-keyword">database</span> -d DB_NAME</span><br><span class="line">srvctl <span class="hljs-keyword">start</span> <span class="hljs-keyword">database</span> -d DB_NAME -startoptions <span class="hljs-keyword">mount</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Switch database to copy</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RMAN&gt;</span><br><span class="line">switch database to copy;</span><br><span class="line">RMAN&gt;</span><br><span class="line">recover database;</span><br></pre></td></tr></table></figure>
<ul>
<li>Restart database in normal mode</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">srvctl <span class="hljs-keyword">stop</span> <span class="hljs-keyword">database</span> -d DB_NAME</span><br><span class="line">srvctl <span class="hljs-keyword">start</span> <span class="hljs-keyword">database</span> -d DB_NAME</span><br></pre></td></tr></table></figure>
<p>Reference:<br><a href="https://blog.pythian.com/recreate-disk-group-crs/" target="_blank" rel="noopener">How To A Recreate Disk Group Used By CRS</a><br><a href="https://support.oracle.com/epmos/faces/SearchDocDisplay?_adf.ctrl-state=to8u2zc4y_4&amp;_afrLoop=141918262651330#aref_section216" target="_blank" rel="noopener">OCR / Vote disk Maintenance Operations: (ADD/REMOVE/REPLACE/MOVE) (Doc ID 428681.1)</a><br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=142118453601784&amp;parent=DOCUMENT&amp;sourceId=428681.1&amp;id=1558920.1&amp;_afrWindowMode=0&amp;_adf.ctrl-state=to8u2zc4y_144" target="_blank" rel="noopener">Software Patch Level and 12c Grid Infrastructure OCR Backup/Restore (Doc ID 1558920.1)</a><br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_adf.ctrl-state=to8u2zc4y_193&amp;id=2331776.1&amp;_afrLoop=142433806199044" target="_blank" rel="noopener">Linux/Unix 平台，在CRS 磁盘组完全丢失后，如何恢复基于 ASM 的 OCR (Doc ID 2331776.1)</a></p>
<p><strong>EOF</strong></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/how-to/">#how to</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/OCR-Voting-disk-replace-or-move.html">OCR Voting disk replacement or movement</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/Updating-Global-Indexes-Automatically.html">Updating Global Indexes Automatically</a>
            
        </span>
    </div>
    
</article>





    </div>
</section>

    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy;  <a href="/">Kyun Kong&nbsp;</a>
                2013 - 2019
            </div>
    </div>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>
-->

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>