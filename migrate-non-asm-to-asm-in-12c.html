<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Migrate non-ASM to ASM in 12c - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="Migrate non-ASM to ASM">



<meta name="keywords" content="ASM,Standalone">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//fonts.lug.ustc.edu.cn/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Migrate non-ASM to ASM in 12c
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2016-04-01T08:12:09.000Z" itemprop="datePublished">Apr 1 2016</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>There are many approaches can convert file system to ASM, such as RMAn copy database image, as of 12c, you can move datafiles online, that feature enables you minimize the downtime.<br><a id="more"></a></p>
<h3 id="1-Abstract"><a href="#1-Abstract" class="headerlink" title="1. Abstract"></a>1. Abstract</h3><p>My CDB named ora12c contain one PDB named pdb1 with local file system datafiles. I have my GI standalone installed with diffenert owner GRID contains two asm disk groups, I need to migrate the whole CDB to ASM. Below is the current environment before migration. </p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#GI already installed with 2 disk groups </span><br><span class="line">[grid@linora:/home/grid]$ crsctl stat res -t</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Name           Target  State        Server                   State details       </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.DATA.dg</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.LISTENER.lsnr</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.asm</span><br><span class="line">               ONLINE  ONLINE       linora                   Started,STABLE</span><br><span class="line">ora.ons</span><br><span class="line">               OFFLINE OFFLINE      linora                   STABLE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Cluster Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.cssd</span><br><span class="line">      1        ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.diskmon</span><br><span class="line">      1        OFFLINE OFFLINE                               STABLE</span><br><span class="line">ora.evmd</span><br><span class="line">      1        ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">SQL&gt; select NAME,STATE from v$asm_diskgroup;</span><br><span class="line">NAME			       STATE</span><br><span class="line">------------------------------ -----------</span><br><span class="line">FRA			       MOUNTED</span><br><span class="line">DATA			       MOUNTED</span><br></pre></td></tr></table></figure>
<h3 id="2-Find-out-the-datafiles-to-be-converted"><a href="#2-Find-out-the-datafiles-to-be-converted" class="headerlink" title="2. Find out the datafiles to be converted"></a>2. Find out the datafiles to be converted</h3><p>Connect to CDB ROOT container via RMAN, use <code>report schema</code> which can show you all the datafiles and tempfiles that inlcuding PDBs and CDB.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">RMAN&gt; report schema;</span><br><span class="line">using target database control file instead of recovery catalog</span><br><span class="line">Report of database schema for database with db_unique_name ORA12C</span><br><span class="line">List of Permanent Datafiles</span><br><span class="line">===========================</span><br><span class="line">File Size(MB) Tablespace           RB segs Datafile Name</span><br><span class="line">---- -------- -------------------- ------- ------------------------</span><br><span class="line">1    790      SYSTEM               YES     /oradata/ora12c/system01.dbf</span><br><span class="line">2    260      PDB$SEED:SYSTEM      NO      /oradata/ora12c/pdbseed/system01.dbf</span><br><span class="line">3    690      SYSAUX               NO      /oradata/ora12c/sysaux01.dbf</span><br><span class="line">4    595      PDB$SEED:SYSAUX      NO      /oradata/ora12c/pdbseed/sysaux01.dbf</span><br><span class="line">5    1480     UNDOTBS1             YES     /oradata/ora12c/undotbs01.dbf</span><br><span class="line">6    5        USERS                NO      /oradata/ora12c/users01.dbf</span><br><span class="line">7    260      PDB1:SYSTEM          NO      /oradata/ora12c/pdb1/system01.dbf</span><br><span class="line">8    605      PDB1:SYSAUX          NO      /oradata/ora12c/pdb1/sysaux01.dbf</span><br><span class="line">9    5        PDB1:USERS           NO      /oradata/ora12c/pdb1/pdb1_users01.dbf</span><br><span class="line">10   100      PDB1:FUNG            NO      /oradata/ora12c/pdb1/fung01.dbf</span><br><span class="line">List of Temporary Files</span><br><span class="line">=======================</span><br><span class="line">File Size(MB) Tablespace           Maxsize(MB) Tempfile Name</span><br><span class="line">---- -------- -------------------- ----------- --------------------</span><br><span class="line">1    67       TEMP                 32767       /oradata/ora12c/temp01.dbf</span><br><span class="line">2    62       PDB$SEED:TEMP        32767       /oradata/ora12c/pdbseed/temp01.dbf</span><br><span class="line">3    20       PDB1:TEMP            32767       /oradata/ora12c/pdb1/temp01.dbf</span><br></pre></td></tr></table></figure></p>
<h3 id="3-Moving-the-datafiles-online-to-ASM-disk-group"><a href="#3-Moving-the-datafiles-online-to-ASM-disk-group" class="headerlink" title="3. Moving the datafiles online to ASM disk group"></a>3. Moving the datafiles online to ASM disk group</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; set lines 200</span><br><span class="line">set pages 50</span><br><span class="line">set feed off</span><br><span class="line">set head off</span><br><span class="line">spool /home/oracle/move_dbfiles.sql</span><br><span class="line">select &apos;ALTER DATABASE MOVE DATAFILE &apos;&apos;&apos;||name||&apos;&apos;&apos; TO &apos;&apos;+DATA&apos;&apos;;&apos; from v$datafile order by con_id;</span><br><span class="line">spool off</span><br></pre></td></tr></table></figure>
<p>Because there are multiple PDBs in the CDB, I need to change the session to the PDB container. I adjust the spooled file like below:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[oracle@linora:/home/oracle]$ cat move_dbfiles.sql </span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/system01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/undotbs01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/users01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/sysaux01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER SESSION SET CONTAINER=pdb$seed;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/pdbseed/sysaux01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/pdbseed/system01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER SESSION SET CONTAINER=pdb1;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/pdb1/fung01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/pdb1/pdb1_users01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/pdb1/system01.dbf&apos; TO &apos;+DATA&apos;;</span><br><span class="line">ALTER DATABASE MOVE DATAFILE &apos;/oradata/ora12c/pdb1/sysaux01.dbf&apos; TO &apos;+DATA&apos;;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-Moving-the-tempfile-to-ASM-disk-group"><a href="#4-Moving-the-tempfile-to-ASM-disk-group" class="headerlink" title="4. Moving the tempfile to ASM disk group"></a>4. Moving the tempfile to ASM disk group</h3><p>We can add the new tempfile and drop the old one to migrate the tempfile.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#Moving CDB tempfiles</span><br><span class="line">SQL&gt; alter tablespace TEMP add tempfile &apos;+DATA&apos;;</span><br><span class="line">SQL&gt; alter tablespace TEMP drop tempfile &apos;/oradata/ora12c/temp01.dbf&apos;;</span><br><span class="line">#Moving PDB tempfiles</span><br><span class="line">SQL&gt; alter session set container=pdb1;</span><br><span class="line">SQL&gt; alter tablespace TEMP add tempfile &apos;+DATA&apos;;</span><br><span class="line">SQL&gt;  alter tablespace TEMP drop tempfile &apos;/oradata/ora12c/pdb1/temp01.dbf&apos;;</span><br><span class="line">#Moving PDB$SEED tempfiles </span><br><span class="line">SQL&gt; alter session set container=CDB$ROOT;</span><br><span class="line">SQL&gt; alter session set &quot;_oracle_script&quot;=TRUE;</span><br><span class="line">SQL&gt; alter pluggable database pdb$seed close;</span><br><span class="line">SQL&gt; alter pluggable database pdb$seed open read write;</span><br><span class="line">SQL&gt; alter session set container=pdb$seed;</span><br><span class="line">SQL&gt; alter tablespace temp add tempfile &apos;+DATA&apos;;</span><br><span class="line">SQL&gt; alter tablespace temp drop tempfile &apos;/oradata/ora12c/pdbseed/temp01.dbf&apos;;</span><br><span class="line">SQL&gt; alter session set container=CDB$ROOT;</span><br><span class="line">SQL&gt; alter pluggable database pdb$seed close;</span><br><span class="line">SQL&gt; alter pluggable database pdb$seed open read only;</span><br></pre></td></tr></table></figure></p>
<p>Query the modified result in RMAN:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">RMAN&gt; report schema;</span><br><span class="line">using target database control file instead of recovery catalog</span><br><span class="line">Report of database schema for database with db_unique_name ORA12C</span><br><span class="line">List of Permanent Datafiles</span><br><span class="line">===========================</span><br><span class="line">File Size(MB) Tablespace           RB segs Datafile Name</span><br><span class="line">---- -------- -------------------- ------- ------------------------</span><br><span class="line">1    790      SYSTEM               YES     +DATA/ORA12C/DATAFILE/system.257.908042629</span><br><span class="line">2    260      PDB$SEED:SYSTEM      NO      +DATA/ORA12C/2F64B9185F472450E0534638A8C061D3/DATAFILE/system.262.908042885</span><br><span class="line">3    690      SYSAUX               NO      +DATA/ORA12C/DATAFILE/sysaux.260.908042811</span><br><span class="line">4    595      PDB$SEED:SYSAUX      NO      +DATA/ORA12C/2F64B9185F472450E0534638A8C061D3/DATAFILE/sysaux.261.908042849</span><br><span class="line">5    1480     UNDOTBS1             YES     +DATA/ORA12C/DATAFILE/undotbs1.258.908042721</span><br><span class="line">6    5        USERS                NO      +DATA/ORA12C/DATAFILE/users.259.908042809</span><br><span class="line">7    260      PDB1:SYSTEM          NO      +DATA/ORA12C/2F659BBCFD612D6DE0534638A8C0AEF9/DATAFILE/system.265.908042909</span><br><span class="line">8    605      PDB1:SYSAUX          NO      +DATA/ORA12C/2F659BBCFD612D6DE0534638A8C0AEF9/DATAFILE/sysaux.266.908042925</span><br><span class="line">9    5        PDB1:USERS           NO      +DATA/ORA12C/2F659BBCFD612D6DE0534638A8C0AEF9/DATAFILE/users.264.908042907</span><br><span class="line">10   100      PDB1:FUNG            NO      +DATA/ORA12C/2F659BBCFD612D6DE0534638A8C0AEF9/DATAFILE/fung.263.908042901</span><br><span class="line">List of Temporary Files</span><br><span class="line">=======================</span><br><span class="line">File Size(MB) Tablespace           Maxsize(MB) Tempfile Name</span><br><span class="line">---- -------- -------------------- ----------- --------------------</span><br><span class="line">4    100      TEMP                 32767       +DATA/ORA12C/TEMPFILE/temp.267.908047665</span><br><span class="line">5    100      PDB1:TEMP            32767       +DATA/ORA12C/2F659BBCFD612D6DE0534638A8C0AEF9/TEMPFILE/temp.268.908047759</span><br><span class="line">6    100      PDB$SEED:TEMP        32767       +DATA/ORA12C/2F64B9185F472450E0534638A8C061D3/TEMPFILE/temp.269.908047875</span><br></pre></td></tr></table></figure></p>
<h3 id="5-Moving-redo-log-files"><a href="#5-Moving-redo-log-files" class="headerlink" title="5. Moving redo log files"></a>5. Moving redo log files</h3><p>Redo log files only exisit in CDB, because all PDBs share the same redo, so when crash recovery needed, only can CDB do it.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select member from v$logfile;</span><br><span class="line">MEMBER</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">/oradata/ora12c/redo01.log</span><br><span class="line">/oradata/ora12c/redo02.log</span><br><span class="line">/oradata/ora12c/redo03.log</span><br><span class="line">SQL&gt; select group#, status from v$log;</span><br><span class="line"></span><br><span class="line">    GROUP# STATUS</span><br><span class="line">---------- --------------------------------</span><br><span class="line">	 1 INACTIVE</span><br><span class="line">	 2 INACTIVE</span><br><span class="line">	 3 CURRENT</span><br></pre></td></tr></table></figure></p>
<p>I dropped a group member and re-create it in ASM disk group to migrate the redo log files.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter database drop logfile group 1;</span><br><span class="line">SQL&gt; alter database add logfile group 1 &apos;+DATA&apos;;</span><br><span class="line">SQL&gt; alter database drop logfile group 2;</span><br><span class="line">SQL&gt; alter database add logfile group 2 &apos;+DATA&apos;;</span><br><span class="line">#Log group 3 is current log, switch it first </span><br><span class="line">SQL&gt; alter system switch logfile;</span><br><span class="line">SQL&gt; alter system checkpoint;</span><br><span class="line">SQL&gt; alter database drop logfile group 3;</span><br><span class="line">SQL&gt;  alter database add logfile group 3 &apos;+DATA&apos;;</span><br></pre></td></tr></table></figure></p>
<p>Query the result from the dynamic view:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select member from v$logfile;</span><br><span class="line">MEMBER</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">+DATA/ORA12C/ONLINELOG/group_1.270.908048777</span><br><span class="line">+DATA/ORA12C/ONLINELOG/group_2.271.908048801</span><br><span class="line">+DATA/ORA12C/ONLINELOG/group_3.272.908048857</span><br><span class="line">SQL&gt; select group#, status from v$log;</span><br><span class="line">    GROUP# STATUS</span><br><span class="line">---------- --------------------------------</span><br><span class="line">	 1 CURRENT</span><br><span class="line">	 2 UNUSED</span><br><span class="line">	 3 UNUSED</span><br></pre></td></tr></table></figure></p>
<h3 id="6-Moving-control-files-and-spfile-to-ASM-disk-group"><a href="#6-Moving-control-files-and-spfile-to-ASM-disk-group" class="headerlink" title="6. Moving control files and spfile to ASM disk group"></a>6. Moving control files and spfile to ASM disk group</h3><p>Activate the control files new location needs to bring down the database, this is the only step which need to downtime in non-ASM to ASM migration in 12c.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; show parameter control_files</span><br><span class="line">NAME				     TYPE		    VALUE</span><br><span class="line">------------------------------------ ---------------------- ------------------------------</span><br><span class="line">control_files			     string		    /oradata/ora12c/control01.ctl,</span><br><span class="line">							     /FRA/ora12c/control02.ctl</span><br></pre></td></tr></table></figure></p>
<p>Shutdown the instance, bring the database in nomount mode, restore current controfiles to ASM, and modify the location of controlfiles in spfile/initial file.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; shutdown immediate</span><br><span class="line">SQL&gt; startup nomount;</span><br><span class="line">#Restoring the current control files to ASM via RMAN</span><br><span class="line">RMAN&gt; restore controlfile to &apos;+DATA&apos; from &apos;/oradata/ora12c/control01.ctl&apos;;</span><br><span class="line">RMAN&gt; restore controlfile to &apos;+FRA&apos; from &apos;/FRA/ora12c/control02.ctl&apos;;</span><br><span class="line">#Query the control files restored to ASM via asmcmd</span><br><span class="line">ASMCMD [+] &gt; find --type CONTROLFILE +DATA *</span><br><span class="line">+DATA/ORA12C/CONTROLFILE/current.273.908049269</span><br><span class="line">ASMCMD [+] &gt; find --type CONTROLFILE +FRA *</span><br><span class="line">+FRA/ORA12C/CONTROLFILE/current.256.908049303</span><br><span class="line">#Modify the controlfiles location in spfile</span><br><span class="line">SQL&gt; alter system set control_files=&apos;+DATA/ORA12C/CONTROLFILE/current.273.908049269&apos;,&apos;+FRA/ORA12C/CONTROLFILE/current.256.908049303&apos; scope=spfile;</span><br><span class="line">#Change the FRA to ASM</span><br><span class="line">SQL&gt; alter system set db_recovery_file_dest=&apos;+FRA&apos; scope=spfile;</span><br><span class="line">#Modify archive log destination to FRA </span><br><span class="line">SQL&gt; alter system reset log_archive_dest_1;</span><br><span class="line">#Modify local listener</span><br><span class="line">SQL&gt; alter system set local_listener=&apos;(ADDRESS=(PROTOCOL=TCP)(HOST=LINORA)(PORT=1522))&apos; scope=spfile;</span><br></pre></td></tr></table></figure></p>
<p>Now, the spfile still in file system, I need to move it to ASM, and create a legacy initial file point to the spfile location in ASM.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#Restoring the spfile to ASM via RMAN</span><br><span class="line">RMAN&gt; alter database mount ;</span><br><span class="line">RMAN&gt; run</span><br><span class="line">&#123;</span><br><span class="line">BACKUP AS BACKUPSET SPFILE;</span><br><span class="line">RESTORE SPFILE TO &quot;+DATA/ORA12C/spfileora12c.ora&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Rename or remove the old initial file or spfile in $ORACLE_HOME/dbs, edit a new initial file with below contents:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#delete the old spfile/initial file </span><br><span class="line">[oracle@linora:/u01/app/oracle/product/12.0.1/db1/dbs]$ rm -rf initora12c.ora </span><br><span class="line">[oracle@linora:/u01/app/oracle/product/12.0.1/db1/dbs]$ rm -rf spfileora12c.ora</span><br><span class="line">[oracle@linora:/u01/app/oracle/product/12.0.1/db1/dbs]$ cat &gt;&gt;initora12c.ora&lt;&lt;EOF</span><br><span class="line">&gt; SPFILE=&apos;+DATA/ORA12C/spfileora12c.ora&apos;</span><br><span class="line">&gt; EOF</span><br><span class="line">[oracle@linora:/u01/app/oracle/product/12.0.1/db1/dbs]$ cat initora12c.ora </span><br><span class="line">SPFILE=&apos;+DATA/ORA12C/spfileora12c.ora&apos;</span><br></pre></td></tr></table></figure></p>
<p>Start the database with the new spfile in ASM:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; shutdown immediate</span><br><span class="line">SQL&gt; startup</span><br><span class="line">SQL&gt; show parameter pfile </span><br><span class="line">NAME				     TYPE		    VALUE</span><br><span class="line">------------------------------------ ---------------------- ------------------------------</span><br><span class="line">spfile				     string		    +DATA/ORA12C/spfileora12c.ora</span><br><span class="line">SQL&gt; show parameter control_files</span><br><span class="line">NAME				     TYPE		    VALUE</span><br><span class="line">------------------------------------ ---------------------- ------------------------------</span><br><span class="line">control_files			     string		    +DATA/ORA12C/CONTROLFILE/curre</span><br><span class="line">							    nt.273.908049269, +FRA/ORA12C/</span><br><span class="line">							    CONTROLFILE/current.256.908049</span><br><span class="line">							    303</span><br></pre></td></tr></table></figure></p>
<h3 id="7-Post-migration-tasks"><a href="#7-Post-migration-tasks" class="headerlink" title="7. Post-migration tasks"></a>7. Post-migration tasks</h3><p>The rest tasks will be add the service to the standalone grid infrastructure, including the database, the listener. </p>
<h4 id="7-1-Adding-the-database-resource-to-GI"><a href="#7-1-Adding-the-database-resource-to-GI" class="headerlink" title="7.1 Adding the database resource to GI"></a>7.1 Adding the database resource to GI</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#Add the database resource</span><br><span class="line">[oracle@linora:/home/oracle]$ srvctl add database -d ora12c -o $ORACLE_HOME -startoption OPEN -policy AUTOMATIC -v</span><br><span class="line">#Add the spfile to new location </span><br><span class="line">[oracle@linora:/home/oracle]$ srvctl modify database -db ora12c -o $ORACLE_HOME -spfile &apos;+DATA/ORA12C/spfileora12c.ora&apos; -diskgroup &quot;DATA,FRA&quot;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-Adding-the-database-listener-resource-to-GI"><a href="#7-2-Adding-the-database-listener-resource-to-GI" class="headerlink" title="7.2 Adding the database listener resource to GI"></a>7.2 Adding the database listener resource to GI</h4><p>After you installed and created GI instance, the listener will create automatically, but it cannot listen the database. The database listener cannot manage by the GI too. This step is listener migration from database to GI.</p>
<ul>
<li>Remove the GI listener resource  </li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[grid@linora:/home/grid]$ crsctl stat res -t</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Name           Target  State        Server                   State details       </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.DATA.dg</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.FRA.dg</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.LISTENER.lsnr</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.asm</span><br><span class="line">               ONLINE  ONLINE       linora                   Started,STABLE</span><br><span class="line">ora.ons</span><br><span class="line">               OFFLINE OFFLINE      linora                   STABLE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Cluster Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.cssd</span><br><span class="line">      1        ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.diskmon</span><br><span class="line">      1        OFFLINE OFFLINE                               STABLE</span><br><span class="line">ora.evmd</span><br><span class="line">      1        ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.ora12c.db</span><br><span class="line">      1        ONLINE  ONLINE       linora                   Open,STABLE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">[grid@linora:/home/grid]$ srvctl stop listener -listener listener</span><br><span class="line">[grid@linora:/home/grid]$ srvctl remove listener -all</span><br><span class="line">[grid@linora:/home/grid]$ pgrep -lf tns</span><br><span class="line">15 netns</span><br><span class="line">2442 /u01/app/oracle/product/12.0.1/db1/bin/tnslsnr LISTENER -inherit</span><br></pre></td></tr></table></figure>
<ul>
<li>Copy the database listener  configuration to GI HOME </li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[oracle@linora:/home/oracle]$ lsnrctl stop</span><br><span class="line">[grid@linora:/home/grid]$ cd $ORACLE_HOME/network/admin/</span><br><span class="line">[grid@linora:/u02/app/grid/12.1.0/grid/network/admin]$ cp /u01/app/oracle/product/12.0.1/db1/network/admin/listener.ora ./</span><br><span class="line">[grid@linora:/u02/app/grid/12.1.0/grid/network/admin]$ cp /u01/app/oracle/product/12.0.1/db1/network/admin/tnsnames.ora ./</span><br><span class="line">[grid@linora:/u02/app/grid/12.1.0/grid/network/admin]$ cp /u01/app/oracle/product/12.0.1/db1/network/admin/sqlnet.ora ./</span><br><span class="line">[grid@linora:/u02/app/grid/12.1.0/grid/network/admin]$ cat &gt;&gt; listener.ora &lt;&lt;EOF </span><br><span class="line">ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON</span><br><span class="line">EOF</span><br><span class="line">[grid@linora:/u02/app/grid/12.1.0/grid/network/admin]$ sed -i &apos;/ADR_BASE_LISTENER/s/\/u01\/app\/oracle/\/u02\/app\/grid/g&apos; listener.ora</span><br></pre></td></tr></table></figure>
<ul>
<li>Add the new listener to GI </li>
</ul>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[grid@linora:/home/grid]$ srvctl add listener -l LISTENER -p &quot;TCP:1522&quot; -o $ORACLE_HOME</span><br><span class="line">[grid@linora:/home/grid]$ srvctl start listener -listener LISTENER</span><br><span class="line">[grid@linora:/home/grid]$ pgrep -lf tns</span><br><span class="line">15 netns</span><br><span class="line">7429 /u02/app/grid/12.1.0/grid/bin/tnslsnr LISTENER -no_crs_notify -inherit</span><br><span class="line">[grid@linora:/home/grid]$ crsctl stat res -t</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Name           Target  State        Server                   State details       </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.DATA.dg</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.FRA.dg</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.LISTENER.lsnr</span><br><span class="line">               ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.asm</span><br><span class="line">               ONLINE  ONLINE       linora                   Started,STABLE</span><br><span class="line">ora.ons</span><br><span class="line">               OFFLINE OFFLINE      linora                   STABLE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Cluster Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.cssd</span><br><span class="line">      1        ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.diskmon</span><br><span class="line">      1        OFFLINE OFFLINE                               STABLE</span><br><span class="line">ora.evmd</span><br><span class="line">      1        ONLINE  ONLINE       linora                   STABLE</span><br><span class="line">ora.ora12c.db</span><br><span class="line">      1        ONLINE  ONLINE       linora                   Open,STABLE</span><br></pre></td></tr></table></figure>
<p>Connect to the database via TCP/IP, if possible, reboot the OS to see if the database can autostart with the GI or not. </p>
<h3 id="8-Trouble-shooting"><a href="#8-Trouble-shooting" class="headerlink" title="8. Trouble shooting"></a>8. Trouble shooting</h3><p>When I tried to start the database, encountered the below errors:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ORA-15025: could not open disk &quot;/dev/asm-diskb&quot;</span><br><span class="line">ORA-27041: unable to open file</span><br><span class="line">Linux-x86_64 Error: 13: Permission denied</span><br><span class="line">Additional information: 3</span><br></pre></td></tr></table></figure></p>
<p>Solutions:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@linora ~]# su - grid</span><br><span class="line">[grid@linora:/home/grid]$ cd $ORACLE_HOME/bin</span><br><span class="line">[grid@linora:/u02/app/grid/12.1.0/grid/bin]$  ./setasmgidwrap o=/u01/app/oracle/product/12.0.1/db1/bin/oracle</span><br></pre></td></tr></table></figure></p>
<p>If you need the database autostart with the GI, don’t forget to add dba group to grid user:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[grid@linora:/home/grid]$ id</span><br><span class="line">uid=501(grid) gid=500(oinstall) groups=500(oinstall),501(dba),502(asmadmin),503(asmdba)</span><br></pre></td></tr></table></figure></p>
<p><b>EOF</b><br></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/12c/">#12c</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/setup-dns-server-in-rhel6.html">Setup DNS Server in RHEL6</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/part-of-12c-new-features.html">Part of 12c New Features</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy; 2013 - 2018
                <a href="/">Fung Kong&nbsp;
                </a>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>