<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>HADR in DB2 - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="A Briefly Introduction of HADR in DB2">



<meta name="keywords" content="HADR">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            HADR in DB2
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2016-03-09T09:36:03.000Z" itemprop="datePublished">Mar 9 2016</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/db2/">db2</a>
                    <span id="busuanzi_container_page_pv" style='display:none'>
Viewd <span id="busuanzi_value_page_pv"></span> times.
</span>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>HADR is an abbrevation of High Avaiablity Disaster Recovery, as it&#39;s names implies, HADR is a software solution providing high avaiablity and disaster recovery for databases, expecially for 24*7 mission critical systems. The technology can be classified as a replication solution. Basically, it replicates data by sending and replaying logs from a source database called primary database to a target database called standby database. HADR is currently avaliable for single-partitioned databases only.<br><a id="more"></a></p>
<h3 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h3><h4 id="1-1-Requirements"><a href="#1-1-Requirements" class="headerlink" title="1.1 Requirements"></a>1.1 Requirements</h4><p><li>OS should be the same version including patches. If rolling update happening, you can violate this rules for a short time</li></p>
<p><li>DB2 version and the level must be identical on both servers, including the bit size. (32bit or 64bit)</li></p>
<p><li>Nerwork interface must be available on both server</li></p>
<p><li>Bufferpool size should be the same</li></p>
<p><li>The database name should be identical, that means they must be in different instances if they reside in a same server</li></p>
<p><li>Tablespace must be identical</li></p>
<p><li>The log file space also should be the same on both server</li></p>
<p><li>The system clock must be sychronized on both servers</li></p>
<h4 id="1-2-Drawback-of-HADR"><a href="#1-2-Drawback-of-HADR" class="headerlink" title="1.2 Drawback of HADR"></a>1.2 Drawback of HADR</h4><p><li>Backup operations are not supported on standby databases</li></p>
<p><li>Not support infinite logging</li></p>
<p><li>Not support no logging transaction</li></p>
<p><li>Not support for DPF</li></p>
<p><li>Not support in DB2 pureScale environments (v10.5 support)</li></p>
<h4 id="1-3-What-HADR-can-do"><a href="#1-3-What-HADR-can-do" class="headerlink" title="1.3 What HADR can do"></a>1.3 What HADR can do</h4><p><li>Read on standby (supported db2 v9.7.1 and above)</li><br>Read on standby can enable you to run read-only operations on standby.</p>
<p><li>Rolling update without any downtime for running applications</li><br>Enable you rolling update the database with minimal downtime or zero downtime when updating a fix pack version, but not supported upgrade from major version to a high major version, for example, it&#39;s supported update from 9.7.5 to 9.7.10, but not supported upgrade from 9.7 to 10.1. The main reason that HADR rolling update cannot cross major version boundary is that DB2 transaction logs from the new release may not be compatible with the old release, but HADR requires log compatibility on primary and standby.</p>
<p><li>Delayed reply, new feature in 10.1</li><br>This feature helps prevent data loss due to errant transactions. When standby server set the <code>hadr_replay_delay</code> database configuration parameter,it will keep standby database at a point in time that is earlier than primary database, if someone deleted some database by accidentally in primary, because standby didn&#39;t replay this errant transaction, so you can only copy the deleted data from standby to primary, or just take over in standby as primary.</p>
<p><li>Log Spooling, new feature in 10.1</li><br>This feature allows transactions on primary to make progress without having to wait for the log replay on the standby. When this feature is enabled, log data sent by the primary is spooled, or written, to disk on the standby, and that log data is later read by log replay.</p>
<p><li>Mutilple standby, new feature in 10.1</li><br>Before 10.1, HADR only supported one standby database, but from 10.1 and above, it&#39;s supported multiple standby database. For example, you can deploy a standby for delayed replying, and another standby for normal purpose.</p>
<h3 id="2-Setup-HADR-with-command-line"><a href="#2-Setup-HADR-with-command-line" class="headerlink" title="2. Setup HADR with command line"></a>2. Setup HADR with command line</h3><p>Summary of testing information:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server name 		|instance name 			|hadr port				|database name</span><br><span class="line">hadr01  		  db2v10i 			  DB2_HADR01_P/51000				mysample</span><br><span class="line">hadr02		  db2v10i			  DB2_HADR02_S/51001</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-Prepare-for-the-environment"><a href="#2-1-Prepare-for-the-environment" class="headerlink" title="2.1 Prepare for the environment"></a>2.1 Prepare for the environment</h4><p>If it&#39;s a totally new build env, you can install and create DB2 database as <a href="/db2/install-db2-in-linux.html">Install DB2 in Linux</a>. As in standby server, only install software and create instance, no need to create database.  Also you need an identical env as primary, so do not forget to create necessery directories in standby server, set permissions on the new directories.</p>
<h4 id="2-2-Setup-the-requirement-of-primary"><a href="#2-2-Setup-the-requirement-of-primary" class="headerlink" title="2.2 Setup the requirement of primary"></a>2.2 Setup the requirement of primary</h4><p><li>turn on the archival log mode</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db2 update db cfg for mysample using LOGARCHMETH1 disk:/db2/arch/mysample</span><br></pre></td></tr></table></figure></p>
<p><li>enable LOGINDEXBUILD</li><br>Set the parameter <code>LOGINDEXBUILD</code> to ON so that index creation, recreation, or reorgnization operations are logged. If the parameter is set to OFF, then there&#39;s not enough logging information for building the indexes on the standby, therefore, the new indexes created or rebuilt are marked as invalid on the standby. Also will increase time consume when standby activate because of rebuilding the invalid indexes.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db2 update database configuration for mysample using LOGINDEXBUILD ON</span><br></pre></td></tr></table></figure></p>
<p><li>configure INDEXREC parameater</li><br>This parameter controls the rebuild of invalid indexes on database startup, in HADR, this parameter should be set to RESTART on both servers.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db2 update dbm cfg using INDEXREC RESTART</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-Take-an-offline-backup-of-primary"><a href="#2-3-Take-an-offline-backup-of-primary" class="headerlink" title="2.3 Take an offline backup of primary"></a>2.3 Take an offline backup of primary</h4><p>Take an offline backup and send the backup image to the standby, restore to rollforward pending status, DO NOT issue rollforward command. Because standby database needs in rollforward pending state for replaying logs.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--on primary</span><br><span class="line">db2 backup db mysample to /db2/backup/</span><br><span class="line">scp /db2/backup/MYSAMPLE.0.db2v10i.NODE0000.CATN0000.20160308233246.001 hadr02:/db2/backup/</span><br><span class="line">--on standby</span><br><span class="line">[db2v10i@hadr02 ~]$ mkdir -p /db2/arch/mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ mkdir -p /db2/data/db2v10i</span><br><span class="line">[db2v10i@hadr02 ~]$ mkdir -p /db2/log/mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 restore db mysample from /db2/backup taken at 20160308233246 DBPATH ON &apos;/db2/data/db2v10i&apos; redirect</span><br><span class="line">[db2v10@node2 ~]$ db2 restore db mysample continue</span><br><span class="line">--do not forget set LOGINDEXBUILD to ON in standby server</span><br><span class="line">db2 update database configuration for mysample using LOGINDEXBUILD ON</span><br></pre></td></tr></table></figure></p>
<h4 id="2-4-Configure-database-parameters-of-HADR-on-primary"><a href="#2-4-Configure-database-parameters-of-HADR-on-primary" class="headerlink" title="2.4 Configure database parameters of HADR on primary"></a>2.4 Configure database parameters of HADR on primary</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db2 update db cfg for mysample using HADR_LOCAL_HOST hadr01 	--should be primary ip addr or hostname</span><br><span class="line">db2 update db cfg for mysample using HADR_LOCAL_SVC  DB2_HADR01_P  	--should be primary hadr service port</span><br><span class="line">db2 update db cfg for mysample using HADR_REMOTE_HOST hadr02 	--should be standby ip add or hostname</span><br><span class="line">db2 update db cfg for mysample using HADR_REMOTE_SVC DB2_HADR02_S	--should be standby hadr service port</span><br><span class="line">db2 update db cfg for mysample using HADR_REMOTE_INST db2v10i   --should be standy server&apos;s instance</span><br><span class="line">db2 update db cfg for mySAMPLE using HADR_SYNCMODE nearsync	--sychronization mode</span><br></pre></td></tr></table></figure>
<h4 id="2-5-Configure-database-parameters-of-HADR-on-standby"><a href="#2-5-Configure-database-parameters-of-HADR-on-standby" class="headerlink" title="2.5 Configure database parameters of HADR on standby"></a>2.5 Configure database parameters of HADR on standby</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db2 update db cfg for mysample using HADR_LOCAL_HOST hadr02 	--should be standby ip addr or hostname</span><br><span class="line">db2 update db cfg for mysample using HADR_LOCAL_SVC DB2_HADR02_S	--should be standby hadr service port</span><br><span class="line">db2 update db cfg for mysample using HADR_REMOTE_HOST hadr01	--should be primary ip addr or hostname</span><br><span class="line">db2 update db cfg for mysample using HADR_REMOTE_SVC DB2_HADR01_P	--should be primary hadr service port</span><br><span class="line">db2 update db cfg for mysample using HADR_REMOTE_INST db2v10i</span><br><span class="line">db2 update db cfg for mySAMPLE using HADR_SYNCMODE nearsync</span><br></pre></td></tr></table></figure>
<p>Be aware, the value for <code>hadr_local_svc</code> on the primary or standby database systems cannot be the same as the value of svcename or svcename +1 on their corresponding hosts. For instance,my instance SVCENAME is 50000, then you cannot use 50000 or 50001 for the HADR service port.</p>
<h4 id="2-6-Start-HADR-on-primary-and-standby"><a href="#2-6-Start-HADR-on-primary-and-standby" class="headerlink" title="2.6 Start HADR on primary and standby"></a>2.6 Start HADR on primary and standby</h4><p>Recommend startup standby first.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--on standy</span><br><span class="line">db2 start hadr on database mysample as standby</span><br><span class="line">--on primary</span><br><span class="line">db2 start hadr on database mysample as primary</span><br></pre></td></tr></table></figure></p>
<p>If maintenance tasks hanppened, such as OS upgrade, fix pack need to restart the HADR, do not issue any db2 stop hadr on db command at any host.</p>
<p><li>Stop HADR</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--First on standby</span><br><span class="line">db2 deactivate db mysample</span><br><span class="line">db2stop</span><br><span class="line">--Then on primary</span><br><span class="line">db2 deactivate database mysample</span><br><span class="line">db2stop</span><br></pre></td></tr></table></figure></p>
<p><li>Start HADR</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--First on the primary</span><br><span class="line">db2start</span><br><span class="line">db2 activate db mysample</span><br><span class="line">--Then on standby</span><br><span class="line">db2start</span><br><span class="line">db2 activate db mysample</span><br></pre></td></tr></table></figure></p>
<h3 id="3-RoS-in-HADR"><a href="#3-RoS-in-HADR" class="headerlink" title="3. RoS in HADR"></a>3. RoS in HADR</h3><p>From DB2 version v9.7.1, standby database is supported enable read on standby feature, this feature is enable query statements with UR isolation level in standby while log reply is happening simultaneously.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--enable RoS in standby</span><br><span class="line">[db2v10i@hadr02 ~]$ db2set DB2_HADR_ROS=ON</span><br><span class="line">[db2v10i@hadr02 ~]$ db2set DB2_STANDBY_ISO=UR</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 terminate</span><br><span class="line">DB20000I  The TERMINATE command completed successfully.</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 deactivate db mysample</span><br><span class="line">DB20000I  The DEACTIVATE DATABASE command completed successfully.</span><br><span class="line">[db2v10i@hadr02 ~]$ db2stop &amp;&amp; db2start</span><br><span class="line">03/09/2016 18:42:53     0   0   SQL1064N  DB2STOP processing was successful.</span><br><span class="line">SQL1064N  DB2STOP processing was successful.</span><br><span class="line">03/09/2016 18:42:54     0   0   SQL1063N  DB2START processing was successful.</span><br><span class="line">SQL1063N  DB2START processing was successful.</span><br></pre></td></tr></table></figure></p>
<p>Let&#39;s start HADR and have a test.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2 start hadr on db mysample as standby</span><br><span class="line">DB20000I  The START HADR ON DATABASE command completed successfully.</span><br></pre></td></tr></table></figure></p>
<p>In primary, we create a new table, and insert some records into the table, see if it can be queried or not in standby.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;create table t like syscat.tables&quot;</span><br><span class="line">DB20000I  The SQL command completed successfully.</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;insert into t select * from syscat.tables&quot;</span><br><span class="line">DB20000I  The SQL command completed successfully.</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;select count(*) from t&quot;</span><br><span class="line">        438</span><br></pre></td></tr></table></figure></p>
<p>Finding the result of standby server.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2 connect to mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 &quot;select count(*) from t with ur&quot;</span><br><span class="line">        438</span><br></pre></td></tr></table></figure></p>
<p>There are till some restrictions on RoS, standby database only support UR isolation level, Automatic Client Reroute not supported in RoS, when DDL replaying on standby, user cannot access to the standby in RoS, also with some maintenance tasks such as <code>runstats</code>, <code>reorg</code>, so, it&#39;s recommended when doing maintenance tasks, choose a maintenance window to accomplish it.</p>
<h3 id="4-Planned-takeover"><a href="#4-Planned-takeover" class="headerlink" title="4. Planned takeover"></a>4. Planned takeover</h3><p>Takeover also call switch roles, when planning some maintenance tasks in primary server, to minimize the downtime, standby can takeover as a primary role. Switching roles only be avaliable when databases are in peer state. And do not forget to rerouter the clients either manually or by ACR after takeover.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--monitoring the states of HADR by db2pd or get snapshot command</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 get snapshot for database on mysample |grep -i hadr -A 6</span><br><span class="line">HADR Status</span><br><span class="line">  Role                   = Primary</span><br><span class="line">  State                  = Peer</span><br><span class="line">  Synchronization mode   = Nearsync</span><br><span class="line">  Connection status      = Connected, 03/09/2016 18:44:10.197363</span><br><span class="line">  Heartbeats missed      = 0</span><br><span class="line">  Local host             = hadr01</span><br><span class="line">  Local service          = HADR01</span><br><span class="line">  Remote host            = hadr02</span><br><span class="line">  Remote service         = HADR02</span><br><span class="line">  Remote instance        = db2v10i</span><br><span class="line">  timeout(seconds)       = 120</span><br><span class="line">  Primary log position(file, page, LSN) = S0000004.LOG, 654, 000000000355638A</span><br><span class="line">  Standby log position(file, page, LSN) = S0000004.LOG, 654, 000000000355638A</span><br><span class="line">  Log gap running average(bytes) = 158</span><br></pre></td></tr></table></figure></p>
<p>If the state is in peer, we can takeover now.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--on standby</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 takeover hadr on db mysample</span><br><span class="line">DB20000I  The TAKEOVER HADR ON DATABASE command completed successfully.</span><br><span class="line">--finding the roles by using get snapshot command, you will find the roles are changed</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 get snapshot for database on mysample |grep -i hadr -A 6</span><br><span class="line">HADR Status</span><br><span class="line">  Role                   = Standby</span><br><span class="line">  State                  = Peer</span><br><span class="line">  Synchronization mode   = Nearsync</span><br><span class="line">  Connection status      = Connected, 03/09/2016 18:44:10.197363</span><br><span class="line">  Heartbeats missed      = 0</span><br><span class="line">  Local host             = hadr01</span><br><span class="line">  Local service          = HADR01</span><br><span class="line">  Remote host            = hadr02</span><br><span class="line">  Remote service         = HADR02</span><br><span class="line">  Remote instance        = db2v10i</span><br><span class="line">  timeout(seconds)       = 120</span><br><span class="line">  Primary log position(file, page, LSN) = S0000004.LOG, 654, 0000000003556527</span><br><span class="line">  Standby log position(file, page, LSN) = S0000004.LOG, 654, 0000000003556527</span><br><span class="line">  Log gap running average(bytes) = 864220</span><br></pre></td></tr></table></figure></p>
<p>When the maintenance jobs are done, you can switch over the roles.<br>Besides switch over, there&#39;s a takeover called takeover by force, it means failover, if the primary not functional, you should use takeover by force. When failover happened, it means the HADR not functional anymore, you need re-build the HADR by backup image.</p>
<h3 id="5-HADR-monitoring"><a href="#5-HADR-monitoring" class="headerlink" title="5. HADR monitoring"></a>5. HADR monitoring</h3><p>You can monitor HADR status by <code>db2pd</code> or db2 get snapshot command.</p>
<h4 id="5-1-db2pd"><a href="#5-1-db2pd" class="headerlink" title="5.1 db2pd"></a>5.1 db2pd</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2pd -d mysample -hadr show detail</span><br><span class="line">Database Member 0 -- Database MYSAMPLE -- Active -- Up 0 days 00:00:33 -- Date 03/14/2016 15:48:38</span><br><span class="line">                            HADR_ROLE = PRIMARY</span><br><span class="line">                          REPLAY_TYPE = PHYSICAL</span><br><span class="line">                        HADR_SYNCMODE = NEARSYNC</span><br><span class="line">                           STANDBY_ID = 1</span><br><span class="line">                        LOG_STREAM_ID = 0</span><br><span class="line">                           HADR_STATE = PEER</span><br><span class="line">                  PRIMARY_MEMBER_HOST = hadr01</span><br><span class="line">                     PRIMARY_INSTANCE = db2v10i</span><br><span class="line">                       PRIMARY_MEMBER = 0</span><br><span class="line">                  STANDBY_MEMBER_HOST = hadr02</span><br><span class="line">                     STANDBY_INSTANCE = db2v10i</span><br><span class="line">                       STANDBY_MEMBER = 0</span><br><span class="line">                  HADR_CONNECT_STATUS = CONNECTED</span><br><span class="line">             HADR_CONNECT_STATUS_TIME = 03/14/2016 15:48:06.525597 (1457941686)</span><br><span class="line">          HEARTBEAT_INTERVAL(seconds) = 30</span><br><span class="line">                HADR_TIMEOUT(seconds) = 120</span><br><span class="line">        TIME_SINCE_LAST_RECV(seconds) = 3</span><br><span class="line">             PEER_WAIT_LIMIT(seconds) = 0</span><br><span class="line">           LOG_HADR_WAIT_CUR(seconds) = 0.000</span><br><span class="line">    LOG_HADR_WAIT_RECENT_AVG(seconds) = 0.000000</span><br><span class="line">   LOG_HADR_WAIT_ACCUMULATED(seconds) = 0.000</span><br><span class="line">                  LOG_HADR_WAIT_COUNT = 0</span><br><span class="line">SOCK_SEND_BUF_REQUESTED,ACTUAL(bytes) = 0, 19800</span><br><span class="line">SOCK_RECV_BUF_REQUESTED,ACTUAL(bytes) = 0, 87380</span><br><span class="line">            PRIMARY_LOG_FILE,PAGE,POS = S0000001.LOG, 0, 44836001</span><br><span class="line">            STANDBY_LOG_FILE,PAGE,POS = S0000001.LOG, 0, 44836001</span><br><span class="line">                  HADR_LOG_GAP(bytes) = 0</span><br><span class="line">     STANDBY_REPLAY_LOG_FILE,PAGE,POS = S0000001.LOG, 0, 44836001</span><br><span class="line">       STANDBY_RECV_REPLAY_GAP(bytes) = 0</span><br><span class="line">                     PRIMARY_LOG_TIME = 03/10/2016 15:55:08.000000 (1457596508)</span><br><span class="line">                     STANDBY_LOG_TIME = 03/10/2016 15:55:08.000000 (1457596508)</span><br><span class="line">              STANDBY_REPLAY_LOG_TIME = 03/10/2016 15:55:08.000000 (1457596508)</span><br><span class="line">         STANDBY_RECV_BUF_SIZE(pages) = 512</span><br><span class="line">             STANDBY_RECV_BUF_PERCENT = 0</span><br><span class="line">           STANDBY_SPOOL_LIMIT(pages) = 0</span><br><span class="line">                 PEER_WINDOW(seconds) = 0</span><br><span class="line">             READS_ON_STANDBY_ENABLED = N</span><br></pre></td></tr></table></figure>
<h4 id="5-2-db2-get-snapshot"><a href="#5-2-db2-get-snapshot" class="headerlink" title="5.2 db2 get snapshot"></a>5.2 db2 get snapshot</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2 get snapshot for database on mysample |grep -i hadr -A 6</span><br><span class="line">Catalog network node name                  = hadr01</span><br><span class="line">Operating system running at database server= LINUXAMD64</span><br><span class="line">Location of the database                   = Local</span><br><span class="line">First database connect timestamp           = 03/14/2016 15:48:05.953771</span><br><span class="line">Last reset timestamp                       =</span><br><span class="line">Last backup timestamp                      = 03/10/2016 15:50:28.000000</span><br><span class="line">Snapshot timestamp                         = 03/14/2016 15:56:55.513115</span><br><span class="line">--</span><br><span class="line">HADR Status</span><br><span class="line">  Role                   = Primary</span><br><span class="line">  State                  = Peer</span><br><span class="line">  Synchronization mode   = Nearsync</span><br><span class="line">  Connection status      = Connected, 03/14/2016 15:48:06.525597</span><br><span class="line">  Heartbeats missed      = 0</span><br><span class="line">  Local host             = hadr01</span><br><span class="line">  Local service          = 57000</span><br><span class="line">  Remote host            = hadr02</span><br><span class="line">  Remote service         = 58000</span><br><span class="line">  Remote instance        = db2v10i</span><br><span class="line">  timeout(seconds)       = 120</span><br><span class="line">  Primary log position(file, page, LSN) = S0000001.LOG, 0, 0000000002AC24A1</span><br><span class="line">  Standby log position(file, page, LSN) = S0000001.LOG, 0, 0000000002AC24A1</span><br><span class="line">  Log gap running average(bytes) = 0</span><br></pre></td></tr></table></figure>
<h4 id="5-3-by-catalog-view"><a href="#5-3-by-catalog-view" class="headerlink" title="5.3 by catalog view"></a>5.3 by catalog view</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;select substr(DB_NAME,1,10) as DBNAME,substr(HADR_CONNECT_STATUS,1,10) as connect_stat, \</span><br><span class="line">substr(HADR_ROLE,1,10) as ROLE,substr(HADR_STATE,1,10) as state,substr(HADR_SYNCMODE,1,10) as syncmode, \</span><br><span class="line">substr(HADR_HEARTBEAT,1,10) as heartbeat,substr(HADR_LOCAL_HOST,1,10) as local,\</span><br><span class="line">substr(HADR_REMOTE_HOST,1,10) as remote, SNAPSHOT_TIMESTAMP from sysibmadm.snaphadr&quot;</span><br><span class="line"></span><br><span class="line">DBNAME     CONNECT_STAT ROLE       STATE      SYNCMODE   HEARTBEAT  LOCAL      REMOTE     SNAPSHOT_TIMESTAMP</span><br><span class="line">---------- ------------ ---------- ---------- ---------- ---------- ---------- ---------- --------------------------</span><br><span class="line">MYSAMPLE   CONNECTED    PRIMARY    PEER       NEARSYNC   0          hadr01     hadr02     2016-03-14-15.58.03.220468</span><br></pre></td></tr></table></figure>
<h3 id="6-ACR"><a href="#6-ACR" class="headerlink" title="6. ACR"></a>6. ACR</h3><p>Automatic Client Reroute is a feature that enables a DB2 client to recover from a loss of connection to the DB2 server by rerouting the connection to an alternate server.This automatic connection rerouting occurs automatically.</p>
<h4 id="6-1-Catalog-primary-DB-on-clients"><a href="#6-1-Catalog-primary-DB-on-clients" class="headerlink" title="6.1 Catalog primary DB on clients"></a>6.1 Catalog primary DB on clients</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[db2cae@db2client ~]$ db2 catalog tcpip node hadr01 remote 192.168.56.101 server 50000</span><br><span class="line">DB20000I  The CATALOG TCPIP NODE command completed successfully.</span><br><span class="line">[db2cae@db2client ~]$ db2 catalog database mysample as mysample at node hadr01</span><br><span class="line">DB20000I  The CATALOG DATABASE command completed successfully.</span><br></pre></td></tr></table></figure>
<h5 id="6-2-Configure-ACR-in-primary-and-standby"><a href="#6-2-Configure-ACR-in-primary-and-standby" class="headerlink" title="6.2 Configure ACR in primary and standby"></a>6.2 Configure ACR in primary and standby</h5><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--on primary</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 update alternate server for database mysample using hostname hadr02 port 50000</span><br><span class="line">DB20000I  The UPDATE ALTERNATE SERVER FOR DATABASE command completed successfully.</span><br><span class="line">--on standby</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 update alternate server for database mysample using hostname hadr01 port 50000</span><br><span class="line">DB20000I  The UPDATE ALTERNATE SERVER FOR DATABASE command completed successfully.</span><br></pre></td></tr></table></figure>
<h4 id="6-3-Running-query-in-client-while-takeover-occur"><a href="#6-3-Running-query-in-client-while-takeover-occur" class="headerlink" title="6.3 Running query in client while takeover occur"></a>6.3 Running query in client while takeover occur</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[db2cae@db2client ~]$ db2 connect to mysample user db2v10i</span><br><span class="line">[db2cae@db2client ~]$ db2 &quot;select count(*) from t&quot;</span><br><span class="line">1</span><br><span class="line">-----------</span><br><span class="line">        438</span><br><span class="line">  1 record(s) selected.</span><br></pre></td></tr></table></figure>
<p>Let the standby takeover as primary, do not disconnect client&#39;s connection by manually.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2 takeover hadr on db mysample</span><br><span class="line">DB20000I  The TAKEOVER HADR ON DATABASE command completed successfully.</span><br><span class="line">--query continue while takeover occur</span><br><span class="line">[db2cae@db2client ~]$ db2 &quot;select count(*) from t&quot;</span><br><span class="line">SQL30108N  A connection failed in an automatic client reroute environment. Any</span><br><span class="line">associated transaction was rolled back. Host name or IP address: &quot;hadr02&quot;.</span><br><span class="line">Service name or port number: &quot;50000&quot;. Reason code: &quot;1&quot;. Connection failure</span><br><span class="line">code: &quot;2&quot;. Underlying error: &quot;*&quot;.  SQLSTATE=08506</span><br><span class="line">[db2cae@db2client ~]$ db2 &quot;select count(*) from t&quot;</span><br><span class="line">1</span><br><span class="line">-----------</span><br><span class="line">        438</span><br><span class="line">  1 record(s) selected.</span><br></pre></td></tr></table></figure></p>
<p>You cannot use the automatic client reroute (ACR) if you enable the read on standby feature.</p>
<h3 id="7-New-feature-on-HADR-examples"><a href="#7-New-feature-on-HADR-examples" class="headerlink" title="7. New feature on HADR examples"></a>7. New feature on HADR examples</h3><h4 id="7-1-Delayed-reply-and-log-spooling"><a href="#7-1-Delayed-reply-and-log-spooling" class="headerlink" title="7.1 Delayed reply and log spooling"></a>7.1 Delayed reply and log spooling</h4><p>The database configuration parameter <code>HADR_REPLAY_DELAY</code> define the amount time of delayed replay in seconds (this parameter should only be configured in standby), value zero means turn off this feature, which is the default value. Log delayed replay is depend on the following rules, it&#39;s important to sychronize the system clock between primary and standby system.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--log replay occurred follow below rules</span><br><span class="line">(current time on the standby - value of the hadr_replay_delay configuration parameter) &gt;=</span><br><span class="line">	timestamp of the committed log record</span><br></pre></td></tr></table></figure></p>
<p>It&#39;s recommended to configure log spooling feature when enabling delayed replay. For the convience of query on the standby, I also enable the RoS on the standby.<br>Restrictions on delayed relay:</p>
<p><li>Only support superasync synchronization mode</li></p>
<p><li>Not support take over while enable this feature</li></p>
<h4 id="7-2-examples-for-delayed-reply-and-log-spooling"><a href="#7-2-examples-for-delayed-reply-and-log-spooling" class="headerlink" title="7.2 examples for delayed reply and log spooling"></a>7.2 examples for delayed reply and log spooling</h4><p>Modify sychronization mode, the database configuration parameter <code>HADR_SYNCMODE</code> is not dynamic, every change to the sychronization mode requires a database restart for both primary and standby databases.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--change sync mode to super-async</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 update db cfg for mysample using HADR_SYNCMODE  superasync</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 update db cfg for mysample using HADR_SYNCMODE  superasync</span><br><span class="line">--enable log spooling in standby</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 update db cfg using HADR_SPOOL_LIMIT 25600</span><br><span class="line">DB20000I  The UPDATE DATABASE CONFIGURATION command completed successfully.</span><br></pre></td></tr></table></figure></p>
<p>Enable RoS on standby:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2set DB2_STANDBY_ISO=UR</span><br><span class="line">[db2v10i@hadr02 ~]$ db2set DB2_HADR_ROS=ON</span><br><span class="line">[db2v10i@hadr02 ~]$ db2set</span><br><span class="line">DB2_STANDBY_ISO=UR</span><br><span class="line">DB2_HADR_ROS=ON</span><br><span class="line">--recycle the instance to enable RoS</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 deactivate db mysample</span><br><span class="line">DB20000I  The DEACTIVATE DATABASE command completed successfully.</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 stop hadr on db mysample</span><br><span class="line">DB20000I  The STOP HADR ON DATABASE command completed successfully.</span><br><span class="line">[db2v10i@hadr02 ~]$ db2stop &amp;&amp; db2start</span><br><span class="line">03/14/2016 16:48:26     0   0   SQL1064N  DB2STOP processing was successful.</span><br><span class="line">SQL1064N  DB2STOP processing was successful.</span><br><span class="line">03/14/2016 16:48:28     0   0   SQL1063N  DB2START processing was successful.</span><br><span class="line">SQL1063N  DB2START processing was successful.</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 start hadr on db mysample as standby</span><br><span class="line">DB20000I  The START HADR ON DATABASE command completed successfully.</span><br><span class="line">[db2v10i@hadr01 ~]$ db2pd -d mysample -hadr|grep -i read</span><br><span class="line">             READS_ON_STANDBY_ENABLED = Y</span><br></pre></td></tr></table></figure></p>
<p>Enable delayed replay feature:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--configure delay replay parameter on standby</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 update db cfg for mysample using HADR_REPLAY_DELAY 600</span><br><span class="line">--restart hadr on both servers</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 deactivate db mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 stop hadr on db mysample</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 stop hadr on db mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 start hadr on db mysample as standby</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 start hadr on db mysample as primary</span><br></pre></td></tr></table></figure></p>
<p>Now the HADR status should be catchup:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2pd -d mysample -hadr|grep -i state</span><br><span class="line">                           HADR_STATE = REMOTE_CATCHUP</span><br></pre></td></tr></table></figure></p>
<p>Create a test table and insert one rows in primary:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;create table t(id int, name char(20))&quot;</span><br><span class="line">DB20000I  The SQL command completed successfully.</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;insert into t values(51369,&apos;FUNG&apos;)&quot;</span><br><span class="line">DB20000I  The SQL command completed successfully.</span><br></pre></td></tr></table></figure></p>
<p>Even if we enabled RoS on standby now, but because of RoS restrictions on DDL, when replaying DDL happened on standby, cannot access to the standby,<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2 connect to mysample</span><br><span class="line">SQL1776N  The command cannot be issued on an HADR standby database. Reason  code = &quot;4&quot;.</span><br><span class="line">[db2v10i@hadr01 ~]$ db2pd -d mysample -hadr |grep -i replay_only</span><br><span class="line">    STANDBY_REPLAY_ONLY_WINDOW_ACTIVE = Y                   #replay only window is active</span><br><span class="line">     STANDBY_REPLAY_ONLY_WINDOW_START = 03/14/2016 16:56:19.000000 (1457945779)</span><br><span class="line">STANDBY_REPLAY_ONLY_WINDOW_TRAN_COUNT = 1</span><br></pre></td></tr></table></figure></p>
<p>Trying to connect in standby 10 mins later:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2 connect to mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ date</span><br><span class="line">Mon Mar 14 17:06:27 CST 2016</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 &quot;select * from t&quot;</span><br><span class="line"></span><br><span class="line">ID          NAME</span><br><span class="line">----------- --------------------</span><br><span class="line">      51369 FUNG</span><br><span class="line"></span><br><span class="line">  1 record(s) selected.</span><br></pre></td></tr></table></figure></p>
<p>Now we insert another rows and delete first rows in primary, and query the table from standby:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;insert into t values(111,&apos;KONG&apos;)&quot;</span><br><span class="line">DB20000I  The SQL command completed successfully.</span><br><span class="line">[db2v10i@hadr01 ~]$ db2 &quot;delete from t where name=&apos;FUNG&apos;&quot;</span><br><span class="line">DB20000I  The SQL command completed successfully.</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 &quot;select * from t&quot;</span><br><span class="line">ID          NAME</span><br><span class="line">----------- --------------------</span><br><span class="line">      51369 FUNG</span><br><span class="line">        111 KONG</span><br><span class="line"></span><br><span class="line">  2 record(s) selected.</span><br></pre></td></tr></table></figure></p>
<p>What happened? The deleted data still in the standby with inserted data? If delayed replay works, we should only see the first rows in the table. Actually, in the DB2, not all operations in the log recorded the timestamp, the automatic committed operation contains 2 operations: insert and commit, when insert operation is transferred to standby, this insert operation is replayed first,but not committed.So you can query this row by UR isolation. Next, I stop the HADR on the standby, and rollforward it as complete:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr02 ~]$ db2 terminate</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 deactivate db mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 stop hadr on db mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 rollforward db mysample complete</span><br><span class="line">                                 Rollforward Status</span><br><span class="line"> Input database alias                   = mysample</span><br><span class="line"> Number of members have returned status = 1</span><br><span class="line"> Member ID                              = 0</span><br><span class="line"> Rollforward status                     = not pending</span><br><span class="line"> Next log file to be read               =</span><br><span class="line"> Log files processed                    = S0000000.LOG - S0000001.LOG</span><br><span class="line"> Last committed transaction             = 2016-03-14-08.58.44.000000 UTC</span><br><span class="line">DB20000I  The ROLLFORWARD command completed successfully.</span><br><span class="line"></span><br><span class="line">[db2v10i@hadr02 ~]$ db2 connect to mysample</span><br><span class="line">[db2v10i@hadr02 ~]$ db2 &quot;select * from t&quot;</span><br><span class="line">ID          NAME</span><br><span class="line">----------- --------------------</span><br><span class="line">      51369 FUNG</span><br><span class="line">  1 record(s) selected.</span><br></pre></td></tr></table></figure></p>
<p>The query result is what we expects, insert and delete operations are all delayed replay, so the only data we can see in the table is the original rows. but remember, if you issue rollforward command to the standby database, you should rebuild the HADR via backup image. Never do that in a production environment.</p>
<h3 id="8-Conclusions"><a href="#8-Conclusions" class="headerlink" title="8. Conclusions"></a>8. Conclusions</h3><p>The mechanism of HADR is primary database sends the log contents to be replayed on standby. There are 2 special euds processes to handle the log transmission,<code>db2hadrp</code> on primary and <code>db2hadrs</code> on standby.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[db2v10i@hadr01 ~]$ db2pd -edus|grep -i hadr</span><br><span class="line">30        139899399300864      3405                 db2hadrp (MYSAMPLE) 0                  0.000000     0.020000</span><br><span class="line">[db2v10i@hadr02 ~]$ db2pd -edus |grep -i hadr</span><br><span class="line">30        140435959834368      3299                 db2hadrs (MYSAMPLE) 0                  0.010000     0.040000</span><br></pre></td></tr></table></figure></p>
<p>There are 2 important parameters:<br><code>HADR_TIMEOUT</code>: Specified the amount of time (in seconds) to wait before HADR considers the communication lost between database pairs.If an HADR database does not receive any communication from its partner database for longer than the length of time specified by the hadr_timeout database configuration parameter, then the database concludes that the connection with the partner database is lost.<br><code>HADR_PEER_WINDOW</code>: Specified the amount of time (in seconds) in which the primary database suspends a transaction after the database pairs have entered disconnect state.</p>
<p>Next topic will be how to rolling update (fix pack) in HADR.<br><br><br><b>EOF</b><br></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/hadr/">#hadr</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/rolling-update-and-upgrade-in-hadr.html">Rolling Update and Upgrade in HADR</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/recovering-a-dropped-table-in-oracle-and-db2.html">Recovering a dropped table in Oracle and DB2</a>
            
        </span>
    </div>
    
</article>





    </div>
</section>

    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy;  <a href="/">Kyun Kong&nbsp;</a>
                2013 - 2019
            </div>
    </div>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>
-->

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>