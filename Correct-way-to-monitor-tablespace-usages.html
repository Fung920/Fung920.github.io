<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Correct way to monitor tablespace usages via SQLs - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">










<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Correct way to monitor tablespace usages via SQLs
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2018-10-08T23:26:05.000Z" itemprop="datePublished">Oct 9 2018</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>There are many ways to monitor Oracle tablespace usages. OEM, SQL Developer, ect,. But in some cases, we have no handy GUI tools, which require us to use SQLs for monitoring tablespace usages.<br>Some v$ views and dictionaries are useful while monitoring tablespace.<br><a id="more"></a></p>
<h1 id="1-Permanent-tablespace"><a href="#1-Permanent-tablespace" class="headerlink" title="1. Permanent tablespace"></a>1. Permanent tablespace</h1><ul>
<li><code>DBA_TABLESPACE_USAGE_METRICS</code></li>
</ul>
<p>Describes tablespace usage metrics for all types of tablespaces, including permanent, temporary, and undo tablespaces. Not suitable for autoextend data files.</p>
<blockquote>
<p>TABLESPACE_SIZE is the maximum possible size if AUTO extended on, not the current size. The same applies to USED_PERCENT.<br>USED_SPACE and TABLESPACE_SIZE are in blocks.</p>
</blockquote>
<p>see MOS: <a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=239212711068322&amp;id=455715.1&amp;_adf.ctrl-state=uz8pga6j_119" target="_blank" rel="noopener">Difference in Tablespace Size Values From dba_data_files and dba_tablespace_usage_metrics/V$filespace_usage (Doc ID 455715.1)</a></p>
<p>For the usage of tablespace(must exclude autoextensible data files):<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span></span><br><span class="line"><span class="hljs-keyword">col</span> tablespace_name <span class="hljs-keyword">for</span> a30</span><br><span class="line"><span class="hljs-keyword">SELECT</span> a.tablespace_name,</span><br><span class="line">  <span class="hljs-keyword">ROUND</span>((a.used_space * b.block_size)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"USED_SPACE(MB)"</span>,</span><br><span class="line">  <span class="hljs-keyword">ROUND</span>((a.tablespace_size * b.block_size)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"TABLESPACE_SIZE(MB)"</span>,</span><br><span class="line">  <span class="hljs-keyword">ROUND</span>(a.used_percent, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> <span class="hljs-string">"USED_PERCENT"</span></span><br><span class="line">  <span class="hljs-keyword">FROM</span> DBA_TABLESPACE_USAGE_METRICS a <span class="hljs-keyword">JOIN</span></span><br><span class="line">  DBA_TABLESPACES b</span><br><span class="line">  <span class="hljs-keyword">ON</span> a.tablespace_name = b.tablespace_name;</span><br><span class="line">ABLESPACE_NAME            USED_SPACE(MB) TABLESPACE_SIZE(MB) USED_PERCENT</span><br><span class="line"><span class="hljs-comment">------------------------------ -------------- ------------------- ------------</span></span><br><span class="line">SYSTEM                       828.13          4741.98     17.46    <span class="hljs-comment">--autoextend on, not real</span></span><br><span class="line">SYSAUX                       645.94          4741.98     13.62    <span class="hljs-comment">--autoextend on, not real</span></span><br><span class="line">TEMP                              3          4741.98       .06</span><br><span class="line">USERS                        7920.25         8322.5      95.17    <span class="hljs-comment">--auto extend off, real usages</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>v$filespace_usage</code><br> Summarizes space allocation information of each datafile and tempfile. This view is the basic view of <code>DBA_TABLESPACE_USAGE_METRICS</code>.</li>
<li><code>DBA_HIST_TBSPC_SPACE_USAGE</code><br> Displays historical tablespace usage statistics, deponds on AWR retention</li>
</ul>
<p>Below shows the examples:</p>
<h2 id="1-1-Monitoring-real-tablespace-usage"><a href="#1-1-Monitoring-real-tablespace-usage" class="headerlink" title="1.1 Monitoring real tablespace usage"></a>1.1 Monitoring real tablespace usage</h2><p>Non-CDB:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">col dbname for a10</span><br><span class="line">col tbs_name for a30</span><br><span class="line">col sum_size for a30</span><br><span class="line">col free_size for a30</span><br><span class="line">col usage_pct for a30</span><br><span class="line"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> (</span><br><span class="line">    <span class="hljs-keyword">SELECT</span>  <span class="hljs-keyword">substr</span> (d.NAME || <span class="hljs-string">'                                                '</span>, <span class="hljs-number">1</span>, <span class="hljs-number">15</span>) <span class="hljs-keyword">AS</span> DBNAME,</span><br><span class="line">    <span class="hljs-keyword">SUBSTR</span> (a.tablespace_name || <span class="hljs-string">'                                     '</span>, <span class="hljs-number">1</span>, <span class="hljs-number">30</span>) <span class="hljs-keyword">AS</span> TBS_NAME,</span><br><span class="line">    <span class="hljs-keyword">SUBSTR</span> (a.BYTES ||<span class="hljs-string">'                                                '</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>) <span class="hljs-keyword">AS</span> SUM_SIZE,</span><br><span class="line">    <span class="hljs-keyword">SUBSTR</span> (TO_CHAR(<span class="hljs-keyword">decode</span>(<span class="hljs-keyword">ROUND</span>(c.BYTES,<span class="hljs-number">1</span>),<span class="hljs-literal">null</span>,<span class="hljs-number">0</span>,<span class="hljs-keyword">ROUND</span>(c.bytes,<span class="hljs-number">1</span>)))||<span class="hljs-string">'              '</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>) <span class="hljs-keyword">AS</span> FREE_SIZE,</span><br><span class="line">    <span class="hljs-keyword">substr</span> (<span class="hljs-keyword">ROUND</span> (<span class="hljs-number">100</span> * (<span class="hljs-number">1</span> - (NVL (c.BYTES, <span class="hljs-number">0</span>)</span><br><span class="line">                    / NVL (a.BYTES, <span class="hljs-number">0</span>))), <span class="hljs-number">2</span>)||<span class="hljs-string">'   '</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>) <span class="hljs-keyword">AS</span> USAGE_PCT</span><br><span class="line">    <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> tablespace_name,<span class="hljs-keyword">SUM</span> (<span class="hljs-keyword">BYTES</span>) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">BYTES</span></span><br><span class="line">        <span class="hljs-keyword">FROM</span> dba_data_files</span><br><span class="line">        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> tablespace_name) a,</span><br><span class="line">    (<span class="hljs-keyword">SELECT</span> f.tablespace_name,<span class="hljs-keyword">SUM</span> (f.BYTES) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">BYTES</span></span><br><span class="line">        <span class="hljs-keyword">FROM</span> dba_free_space f</span><br><span class="line">        <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> f.tablespace_name) c,</span><br><span class="line">    v$<span class="hljs-keyword">database</span> d</span><br><span class="line">    <span class="hljs-keyword">WHERE</span> a.tablespace_name = c.tablespace_name(+)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>CDB:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">LINES</span> <span class="hljs-number">132</span> PAGES <span class="hljs-number">100</span></span><br><span class="line"><span class="hljs-keyword">COL</span> con_name        <span class="hljs-keyword">FORM</span> A15 <span class="hljs-keyword">HEAD</span> <span class="hljs-string">"Container|Name"</span></span><br><span class="line"><span class="hljs-keyword">COL</span> tablespace_name <span class="hljs-keyword">FORM</span> A15</span><br><span class="line"><span class="hljs-keyword">COL</span> fsm             <span class="hljs-keyword">FORM</span> <span class="hljs-number">999</span>,<span class="hljs-number">999</span>,<span class="hljs-number">999</span>,<span class="hljs-number">999</span> <span class="hljs-keyword">HEAD</span> <span class="hljs-string">"Free|Space Meg."</span></span><br><span class="line"><span class="hljs-keyword">COL</span> apm             <span class="hljs-keyword">FORM</span> <span class="hljs-number">999</span>,<span class="hljs-number">999</span>,<span class="hljs-number">999</span>,<span class="hljs-number">999</span> <span class="hljs-keyword">HEAD</span> <span class="hljs-string">"Alloc|Space Meg."</span></span><br><span class="line"><span class="hljs-keyword">COL</span> usage_pct       <span class="hljs-keyword">form</span> a10             <span class="hljs-keyword">head</span> <span class="hljs-string">"Used|Percent%"</span></span><br><span class="line"><span class="hljs-comment">--</span></span><br><span class="line"><span class="hljs-keyword">COMPUTE</span> <span class="hljs-keyword">SUM</span> <span class="hljs-keyword">OF</span> fsm apm <span class="hljs-keyword">ON</span> REPORT</span><br><span class="line">BREAK <span class="hljs-keyword">ON</span> REPORT <span class="hljs-keyword">ON</span> con_id <span class="hljs-keyword">ON</span> con_name <span class="hljs-keyword">ON</span> tablespace_name</span><br><span class="line"><span class="hljs-comment">--</span></span><br><span class="line"><span class="hljs-keyword">WITH</span> x <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> c1.con_id, cf1.tablespace_name, <span class="hljs-keyword">SUM</span>(cf1.bytes)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span> fsm</span><br><span class="line">           <span class="hljs-keyword">FROM</span> cdb_free_space cf1</span><br><span class="line">               ,v$containers c1</span><br><span class="line">           <span class="hljs-keyword">WHERE</span> cf1.con_id = c1.con_id</span><br><span class="line">           <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c1.con_id, cf1.tablespace_name),</span><br><span class="line">     y <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">SELECT</span> c2.con_id, cd.tablespace_name, <span class="hljs-keyword">SUM</span>(cd.bytes)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span> apm</span><br><span class="line">           <span class="hljs-keyword">FROM</span> cdb_data_files cd</span><br><span class="line">               ,v$containers c2</span><br><span class="line">           <span class="hljs-keyword">WHERE</span> cd.con_id = c2.con_id</span><br><span class="line">           <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> c2.con_id</span><br><span class="line">                   ,cd.tablespace_name)</span><br><span class="line"><span class="hljs-keyword">SELECT</span> x.con_id, v.name con_name, x.tablespace_name, x.fsm, y.apm</span><br><span class="line"><span class="hljs-keyword">LPAD</span>(<span class="hljs-keyword">ROUND</span>((<span class="hljs-number">1</span> - x.fsm / y.apm ) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)||<span class="hljs-string">'%'</span>, <span class="hljs-number">10</span>, <span class="hljs-string">' '</span>) <span class="hljs-keyword">as</span> usage_pct</span><br><span class="line"><span class="hljs-keyword">FROM</span> x, y, v$containers v</span><br><span class="line"><span class="hljs-keyword">WHERE</span> x.con_id          = y.con_id</span><br><span class="line"><span class="hljs-keyword">AND</span>   x.tablespace_name = y.tablespace_name</span><br><span class="line"><span class="hljs-keyword">AND</span>   v.con_id          = y.con_id</span><br><span class="line"><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>, <span class="hljs-number">3</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-Monitoring-tablespace-growth-rate"><a href="#1-2-Monitoring-tablespace-growth-rate" class="headerlink" title="1.2 Monitoring tablespace growth rate"></a>1.2 Monitoring tablespace growth rate</h2><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">SELECT</span> A.NAME, B.TABLESPACE_ID,B.DATETIME,B.USED_SIZE_MB,B.INC_MB,</span><br><span class="line">       <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUBSTR</span>(INC_RATE,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)=<span class="hljs-string">'.'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'0'</span>||INC_RATE</span><br><span class="line">            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">SUBSTR</span>(INC_RATE,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)=<span class="hljs-string">'-.'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'-0'</span>||<span class="hljs-keyword">SUBSTR</span>(INC_RATE,<span class="hljs-number">2</span>,<span class="hljs-keyword">LENGTH</span>(INC_RATE))</span><br><span class="line">            <span class="hljs-keyword">ELSE</span> INC_RATE</span><br><span class="line">       <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> INC_RATEX</span><br><span class="line">  <span class="hljs-keyword">FROM</span> V$<span class="hljs-keyword">TABLESPACE</span> A,</span><br><span class="line">       (</span><br><span class="line">           <span class="hljs-keyword">SELECT</span> TABLESPACE_ID,DATETIME,</span><br><span class="line">                  USED_SIZE_MB,</span><br><span class="line">                  (<span class="hljs-keyword">DECODE</span>(PREV_USE_MB,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,USED_SIZE_MB)-PREV_USE_MB) <span class="hljs-keyword">AS</span>  INC_MB,</span><br><span class="line">                  TO_CHAR(<span class="hljs-keyword">ROUND</span>((<span class="hljs-keyword">DECODE</span>(PREV_USE_MB,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,USED_SIZE_MB)-PREV_USE_MB)/<span class="hljs-keyword">DECODE</span>(PREV_USE_MB,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,PREV_USE_MB)*<span class="hljs-number">100</span>,<span class="hljs-number">2</span>))||<span class="hljs-string">'%'</span> <span class="hljs-keyword">AS</span> INC_RATE</span><br><span class="line">         <span class="hljs-keyword">FROM</span></span><br><span class="line">         (</span><br><span class="line">           <span class="hljs-keyword">SELECT</span> TABLESPACE_ID,</span><br><span class="line">                  TRUNC(<span class="hljs-keyword">TO_DATE</span>(RTIME, <span class="hljs-string">'mm/dd/yyyy hh24:mi:ss'</span>)) DATETIME,</span><br><span class="line">                  <span class="hljs-keyword">MAX</span>(TABLESPACE_USEDSIZE * <span class="hljs-number">8</span> / <span class="hljs-number">1024</span>) USED_SIZE_MB,</span><br><span class="line">                  LAG(<span class="hljs-keyword">MAX</span>(TABLESPACE_USEDSIZE * <span class="hljs-number">8</span> / <span class="hljs-number">1024</span>),<span class="hljs-number">1</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> TABLESPACE_ID <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> TRUNC(<span class="hljs-keyword">TO_DATE</span>(RTIME, <span class="hljs-string">'mm/dd/yyyy hh24:mi:ss'</span>)) ) <span class="hljs-keyword">AS</span> PREV_USE_MB</span><br><span class="line">             <span class="hljs-keyword">FROM</span> DBA_HIST_TBSPC_SPACE_USAGE</span><br><span class="line">            <span class="hljs-keyword">WHERE</span> TRUNC(<span class="hljs-keyword">TO_DATE</span>(RTIME, <span class="hljs-string">'mm/dd/yyyy hh24:mi:ss'</span>)) &gt; TRUNC(<span class="hljs-keyword">SYSDATE</span> - <span class="hljs-number">30</span>)</span><br><span class="line">            <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> TABLESPACE_ID, TRUNC(<span class="hljs-keyword">TO_DATE</span>(RTIME, <span class="hljs-string">'mm/dd/yyyy hh24:mi:ss'</span>))</span><br><span class="line">         )</span><br><span class="line">       ) B</span><br><span class="line"> <span class="hljs-keyword">WHERE</span> A.TS# = B.TABLESPACE_ID</span><br><span class="line"> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> B.TABLESPACE_ID,DATETIME;</span><br></pre></td></tr></table></figure>
<h1 id="2-Temporary-tablespace"><a href="#2-Temporary-tablespace" class="headerlink" title="2. Temporary tablespace"></a>2. Temporary tablespace</h1><ul>
<li><code>GV_$TEMP_SPACE_HEADER</code><br> The views <code>v$sort_usage</code> or <code>v$tempseg_usage</code> ( and <code>v$sort_segment</code>) give the correct information regarding the allocation of sort segments. The view <code>v$temp_space_header</code> shows that these many blocks were touched in each temp file at some point when temp usage was at its highest,in essence, it shows the number of initialized blocks for each tempfile, not the actual allocated blocks.</li>
</ul>
<p>See MOS: <a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=240558702386283&amp;id=2095211.1&amp;_adf.ctrl-state=uz8pga6j_527" target="_blank" rel="noopener">Mismatch Between V$TEMP_SPACE_HEADER and V$TEMPSEG_USAGE/V$SORT_USAGE (Doc ID 2095211.1)</a>.</p>
<ul>
<li>Correct way to show TEMP tablespace usage</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">select</span> tablespace_name,</span><br><span class="line">tablespace_size/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span> <span class="hljs-string">"Total Space"</span>,</span><br><span class="line">allocated_space/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span> <span class="hljs-string">"Alloc Space"</span>,</span><br><span class="line">free_space/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span> <span class="hljs-string">"Free Space"</span></span><br><span class="line"><span class="hljs-keyword">from</span> dba_temp_free_space;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">select</span> tablespace_name, total_blocks*<span class="hljs-number">8</span>/<span class="hljs-number">1024</span> total_mb, used_blocks*<span class="hljs-number">8</span>/<span class="hljs-number">1024</span> used_mb, free_blocks*<span class="hljs-number">8</span>/<span class="hljs-number">1024</span> free_mb</span><br><span class="line"><span class="hljs-keyword">from</span> v$sort_segment;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">SELECT</span> D.tablespace_name,</span><br><span class="line">       <span class="hljs-keyword">SPACE</span> <span class="hljs-string">"SUM_SPACE(M)"</span>,</span><br><span class="line">       blocks <span class="hljs-string">"SUM_BLOCKS"</span>,</span><br><span class="line">       used_space <span class="hljs-string">"USED_SPACE(M)"</span>,</span><br><span class="line">       <span class="hljs-keyword">Round</span>(Nvl(used_space, <span class="hljs-number">0</span>) / <span class="hljs-keyword">SPACE</span> * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-string">"USED_RATE(%)"</span>,</span><br><span class="line">       <span class="hljs-keyword">SPACE</span> - used_space <span class="hljs-string">"FREE_SPACE(M)"</span></span><br><span class="line">  <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> tablespace_name,</span><br><span class="line">               <span class="hljs-keyword">Round</span>(<span class="hljs-keyword">SUM</span>(<span class="hljs-keyword">bytes</span>) / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>), <span class="hljs-number">2</span>) <span class="hljs-keyword">SPACE</span>,</span><br><span class="line">               <span class="hljs-keyword">SUM</span>(blocks) BLOCKS</span><br><span class="line">          <span class="hljs-keyword">FROM</span> dba_temp_files</span><br><span class="line">         <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> tablespace_name) D,</span><br><span class="line">       (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">tablespace</span>,</span><br><span class="line">               <span class="hljs-keyword">Round</span>(<span class="hljs-keyword">SUM</span>(blocks * <span class="hljs-number">8192</span>) / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>), <span class="hljs-number">2</span>) USED_SPACE</span><br><span class="line">          <span class="hljs-keyword">FROM</span> v$sort_usage</span><br><span class="line">         <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">tablespace</span>) F</span><br><span class="line"> <span class="hljs-keyword">WHERE</span> D.tablespace_name = F.tablespace(+)</span><br></pre></td></tr></table></figure>
<h1 id="3-Get-table-segment-growth-history"><a href="#3-Get-table-segment-growth-history" class="headerlink" title="3. Get table/segment growth history"></a>3. Get table/segment growth history</h1><p>MOS: <a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=320948395693558&amp;parent=EXTERNAL_SEARCH&amp;sourceId=HOWTO&amp;id=1395195.1&amp;_afrWindowMode=0&amp;_adf.ctrl-state=tc5cvv4es_4" target="_blank" rel="noopener">How To Get Table Growth History Information? (Doc ID 1395195.1)</a></p>
<ul>
<li><code>DBA_HIST_SEG_STAT</code><br>  DBA_HIST_SEG_STAT displays historical information about segment-level statistics. This view captures the top segments based on a set of criteria and captures information from V$SEGSTAT.</li>
</ul>
<p>View the object (segment) growth in blocks:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">column owner format a16</span><br><span class="line">column object_name format a36</span><br><span class="line">column start_day format a11</span><br><span class="line">column block_increase format 9999999999</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">select</span>   obj.owner, obj.object_name,</span><br><span class="line">         to_char(sn.BEGIN_INTERVAL_TIME,<span class="hljs-string">'RRRR-MON-DD'</span>) start_day,</span><br><span class="line">         <span class="hljs-keyword">sum</span>(a.SPACE_USED_DELTA) block_increase_bytes</span><br><span class="line"><span class="hljs-keyword">from</span>     dba_hist_seg_stat a,</span><br><span class="line">         dba_hist_snapshot sn,</span><br><span class="line">         dba_objects obj</span><br><span class="line"><span class="hljs-keyword">where</span>    sn.snap_id = a.snap_id</span><br><span class="line"><span class="hljs-keyword">and</span>      obj.object_id = a.obj#</span><br><span class="line"><span class="hljs-keyword">and</span>      obj.owner <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> (<span class="hljs-string">'SYS'</span>,<span class="hljs-string">'SYSTEM'</span>)</span><br><span class="line"><span class="hljs-keyword">and</span>      end_interval_time <span class="hljs-keyword">between</span> to_timestamp(<span class="hljs-string">'01-JAN-2012'</span>,<span class="hljs-string">'DD-MON-RRRR'</span>)</span><br><span class="line">         <span class="hljs-keyword">and</span> to_timestamp(<span class="hljs-string">'02-FEB-2012'</span>,<span class="hljs-string">'DD-MON-RRRR'</span>)</span><br><span class="line"><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> obj.owner, obj.object_name,</span><br><span class="line">         to_char(sn.BEGIN_INTERVAL_TIME,<span class="hljs-string">'RRRR-MON-DD'</span>)</span><br><span class="line"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> obj.owner, obj.object_name</span><br><span class="line">/</span><br></pre></td></tr></table></figure></p>
<p>Segments with highest growth (Top n):<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">SELECT</span> o.OWNER , o.OBJECT_NAME , o.SUBOBJECT_NAME , o.OBJECT_TYPE ,</span><br><span class="line">    t.NAME <span class="hljs-string">"Tablespace Name"</span>, s.growth/(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>) <span class="hljs-string">"Growth in MB"</span>,</span><br><span class="line">    (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">bytes</span>)/(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>)</span><br><span class="line">    <span class="hljs-keyword">FROM</span> dba_segments</span><br><span class="line">    <span class="hljs-keyword">WHERE</span> segment_name=o.object_name) <span class="hljs-string">"Total Size(MB)"</span></span><br><span class="line"><span class="hljs-keyword">FROM</span> DBA_OBJECTS o,</span><br><span class="line">    ( <span class="hljs-keyword">SELECT</span> TS#,OBJ#,</span><br><span class="line">        <span class="hljs-keyword">SUM</span>(SPACE_USED_DELTA) growth</span><br><span class="line">    <span class="hljs-keyword">FROM</span> DBA_HIST_SEG_STAT</span><br><span class="line">    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> TS#,OBJ#</span><br><span class="line">    <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">SUM</span>(SPACE_USED_DELTA) &gt; <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span> ) s,</span><br><span class="line">    v$<span class="hljs-keyword">tablespace</span> t</span><br><span class="line"><span class="hljs-keyword">WHERE</span> s.OBJ# = o.OBJECT_ID</span><br><span class="line"><span class="hljs-keyword">AND</span> s.TS#=t.TS#</span><br><span class="line"><span class="hljs-keyword">AND</span> <span class="hljs-keyword">rownum</span> &lt; <span class="hljs-number">51</span></span><br><span class="line"><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">6</span> <span class="hljs-keyword">DESC</span></span><br><span class="line">/</span><br></pre></td></tr></table></figure></p>
<p>Script to display table size changes between two periods:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">column "Percent of Total Disk Usage" justify right format 999.99</span><br><span class="line">column "Space Used (MB)" justify right format 9,999,999.99</span><br><span class="line">column "Total Object Size (MB)" justify right format 9,999,999.99</span><br><span class="line"><span class="hljs-keyword">set</span> linesize <span class="hljs-number">150</span></span><br><span class="line"><span class="hljs-keyword">set</span> pages <span class="hljs-number">80</span></span><br><span class="line"><span class="hljs-keyword">set</span> feedback <span class="hljs-keyword">off</span></span><br><span class="line"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> to_char(end_interval_time, <span class="hljs-string">'MM/DD/YY'</span>) mydate,</span><br><span class="line"><span class="hljs-keyword">sum</span>(space_used_delta) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> <span class="hljs-string">"Space used (MB)"</span>,</span><br><span class="line"><span class="hljs-keyword">avg</span>(c.bytes) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> <span class="hljs-string">"Total Object Size (MB)"</span>,</span><br><span class="line"><span class="hljs-keyword">round</span>(<span class="hljs-keyword">sum</span>(space_used_delta) / <span class="hljs-keyword">sum</span>(c.bytes) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-string">"Percent of Total Disk Usage"</span></span><br><span class="line"><span class="hljs-keyword">from</span></span><br><span class="line">   dba_hist_snapshot sn,</span><br><span class="line">   dba_hist_seg_stat a,</span><br><span class="line">   dba_objects b,</span><br><span class="line">   dba_segments c</span><br><span class="line"><span class="hljs-keyword">where</span> begin_interval_time &gt; trunc(<span class="hljs-keyword">sysdate</span>) - &amp;days_back</span><br><span class="line"><span class="hljs-keyword">and</span> sn.snap_id = a.snap_id</span><br><span class="line"><span class="hljs-keyword">and</span> b.object_id = a.obj#</span><br><span class="line"><span class="hljs-keyword">and</span> b.owner = c.owner</span><br><span class="line"><span class="hljs-keyword">and</span> b.object_name = c.segment_name</span><br><span class="line"><span class="hljs-keyword">and</span> c.segment_name = <span class="hljs-string">'&amp;segment_name'</span></span><br><span class="line"><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> to_char(end_interval_time, <span class="hljs-string">'MM/DD/YY'</span>))</span><br><span class="line"><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">to_date</span>(mydate, <span class="hljs-string">'MM/DD/YY'</span>);</span><br></pre></td></tr></table></figure></p>
<p>With above information, it&#39;s easier to ask application owner if the growth is normal or not.</p>
<p><strong>EOF</strong></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/scripts/">#scripts</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/Hugepage-setting-on-Linux-AIX.html">Hugepage setting on Linux/AIX</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/db2-runstats-and-reorgs.html">DB2 Runstats and Reorgs</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy;  <a href="/">Kyun Kong&nbsp;</a>
                2013 - 2018
            </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>