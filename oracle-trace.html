<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Oracle追踪SQL的方法 - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="how to trace sql or others in oracle">



<meta name="keywords" content="trace,tkprof,10046,10053">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Oracle追踪SQL的方法
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2014-07-24T07:15:11.000Z" itemprop="datePublished">Jul 24 2014</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>Oracle提供了几种方法可以使得DBA针对某些session或者语句进行trace跟踪。<br><a id="more"></a><br>从9i开始，官方文档开始记载了如何激活SQL追踪的方法，初始化参数SQL_TRACE,dbms_session.set_sql_trace和dbms_system.set_sql_trace_in_session。然而，这三种方法都只能追踪到10046事件的1级别，10046级别如下图所示（不完全，11g有新增10046级别）：</p>
<center>Table 1-1 10046 event level</center>

<table>
<thead>
<tr>
<th>level</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>禁止trace</td>
</tr>
<tr>
<td>1</td>
<td>激活trace，提供SQL语句，响应时间，服务时间，处理行数，逻辑读，物理读写，执行计划及额外的一些信息</td>
</tr>
<tr>
<td>4</td>
<td>包括1级别，同时提供绑定变量信息</td>
</tr>
<tr>
<td>8</td>
<td>包括1级别，同时提供等待事件信息：等待事件名字、持续时间等</td>
</tr>
<tr>
<td>12</td>
<td>同时启动4和8</td>
</tr>
</tbody>
</table>
<p>由于官方文档提及的三种追踪方法都无法更详细的信息，因此，有如下几种方式可提供对SQL或者其他事件的追踪。</p>
<h3 id="1-event事件"><a href="#1-event事件" class="headerlink" title="1. event事件"></a>1. event事件</h3><p>对SQL的追踪主要有10046及10053事件，这两个事件都是不公开的，解析分别如下(10053仅有两个级别，一般会使用level 1，属于最高级别)：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[oracle@linora:/home/oracle]$ oerr ora 10046</span><br><span class="line">10046, 00000, &quot;enable SQL statement timing&quot;</span><br><span class="line">// *Cause:</span><br><span class="line">// *Action:</span><br><span class="line">[oracle@linora:/home/oracle]$ oerr ora 10053</span><br><span class="line">10053, 00000, &quot;CBO Enable optimizer trace&quot;</span><br><span class="line">// *Cause:</span><br><span class="line">// *Action:</span><br></pre></td></tr></table></figure></p>
<p>10046显示SQL执行计划如何运行， 10053显示优化器为何选择这个执行计划。通过设置Event对SQL进行追踪，可以有两种方法，一种是alter session/alter system方法，或者使用oradebug工具。</p>
<h4 id="1-1-alter-session-alter-system"><a href="#1-1-alter-session-alter-system" class="headerlink" title="1.1 alter session/alter system"></a>1.1 alter session/alter system</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--开启session级别事件追踪</span><br><span class="line">alter session set events &apos;10046 trace name context forever,level 12&apos;;</span><br><span class="line">alter session set events &apos;10053 trace name context forever,level 1&apos;;</span><br><span class="line">--关闭事件</span><br><span class="line">ALTER SESSION SET EVENTS &apos;10053 trace name context off&apos;;</span><br></pre></td></tr></table></figure>
<p>查找trace文件：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#for 11g</span><br><span class="line">SELECT s.sql_trace, s.sql_trace_waits, s.sql_trace_binds,</span><br><span class="line">traceid, tracefile</span><br><span class="line">FROM v$session s JOIN v$process p ON (p.addr = s.paddr)</span><br><span class="line">WHERE audsid = USERENV (&apos;SESSIONID&apos;);</span><br><span class="line">#for 10g</span><br><span class="line">SELECT   s.sid,</span><br><span class="line">         s.serial#,</span><br><span class="line">            pa.VALUE</span><br><span class="line">         || &apos;/&apos;</span><br><span class="line">         || LOWER (SYS_CONTEXT (&apos;userenv&apos;, &apos;instance_name&apos;))</span><br><span class="line">         || &apos;_ora_&apos;</span><br><span class="line">         || p.spid</span><br><span class="line">         || &apos;.trc&apos;</span><br><span class="line">            AS trace_file</span><br><span class="line">  FROM   v$session s, v$process p, v$parameter pa</span><br><span class="line"> WHERE       pa.name = &apos;user_dump_dest&apos;</span><br><span class="line">         AND s.paddr = p.addr</span><br><span class="line">         AND s.audsid = SYS_CONTEXT (&apos;USERENV&apos;, &apos;SESSIONID&apos;);</span><br></pre></td></tr></table></figure></p>
<h4 id="1-2-oradebug"><a href="#1-2-oradebug" class="headerlink" title="1.2 oradebug"></a>1.2 oradebug</h4><p>#####oradebug追踪本session<br>oradebug的用法可用oradebug help查看，关于oradebug其他功能，本文暂不予讨论。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; oradebug setmypid</span><br><span class="line">Statement processed.</span><br><span class="line">SYS@linora&gt; oradebug event 10053 trace name context forever,level 1; </span><br><span class="line">Statement processed.</span><br><span class="line">SYS@linora&gt; oradebug event 10053 trace name context off</span><br><span class="line">Statement processed.</span><br><span class="line">SYS@linora&gt; oradebug tracefile_name</span><br><span class="line">/u01/app/oracle/diag/rdbms/linora/linora/trace/linora_ora_2293.trc</span><br><span class="line">SYS@linora&gt; oradebug CLOSE_TRACE</span><br></pre></td></tr></table></figure></p>
<p>#####oradebug追踪其他session<br>如果是OS系统进程ID，可使用oradebug setospid spid 。如果是Oracle ID可使用oradebug setorapid pid 进行追踪。SPID(system process id),表示該server process在OS层面的Porcess ID 即操作系统进程ID,PID(Oracle process id) 可以理解为Oracle自己用的，Oracle进程ID,SID(SESSION)标识，常用于连接其它列。首先通过v$session和v$process查找相关的pid或者spid：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; SELECT  a.sid,a.serial#,b.spid,a.username,a.machine,a.OSUSER,a.PROGRAM</span><br><span class="line">FROM   v$session a,v$process b</span><br><span class="line">WHERE   a.TYPE != &apos;BACKGROUND&apos; and a.paddr=b.addr;</span><br><span class="line"></span><br><span class="line">       SID    SERIAL# SPID       USERNAME   MACHINE              OSUSER          PROGRAM</span><br><span class="line">---------- ---------- ---------- ---------- -------------------- --------------- ------------------------------------------------</span><br><span class="line">        26         37 2552       FUNG       linora               oracle          sqlplus@linora (TNS V1-V3)</span><br><span class="line">       147        195 3316       SYS        linora               oracle          sqlplus@linora (TNS V1-V3)</span><br><span class="line">       144        179 3318                  linora               oracle          oracle@linora (J000)</span><br><span class="line">        20        101 3192       FUNG       WORKGROUP\PC0920     Administrator   sqlplus.exe</span><br><span class="line">        22         23 3320                  linora               oracle          oracle@linora (J001)</span><br></pre></td></tr></table></figure></p>
<p>比如，要对sid=20,serial#=101,spid=3192的进程进行跟踪<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; oradebug setospid 3192</span><br><span class="line">Oracle pid: 30, Unix process pid: 3192, image: oracle@linora</span><br><span class="line">#或者oradebug setorapid 20</span><br><span class="line">SYS@linora&gt; oradebug event 10046 trace name context forever,level 12; </span><br><span class="line">Statement processed.</span><br><span class="line">SYS@linora&gt; oradebug event 10046 trace name context off</span><br><span class="line">Statement processed.</span><br><span class="line">SYS@linora&gt; oradebug tracefile_name</span><br><span class="line">/u01/app/oracle/diag/rdbms/linora/linora/trace/linora_ora_3192.trc</span><br><span class="line">SYS@linora&gt; oradebug CLOSE_TRACE</span><br><span class="line">Statement processed.</span><br></pre></td></tr></table></figure></p>
<h3 id="2-dbms-system-set-ev"><a href="#2-dbms-system-set-ev" class="headerlink" title="2. dbms_system.set_ev"></a>2. dbms_system.set_ev</h3><p>这个procedure是为10g以前提供的，在我的环境下怎么也找不到生成的trace file，以下语句使用dbms包开启SQL追踪（默认sys用户执行）：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; EXEC DBMS_SYSTEM.set_ev(si=&gt;20, se=&gt;101, ev=&gt;10046, le=&gt;12, nm=&gt;&apos; &apos;);</span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure></p>
<p>关闭只需要将le改为0即可：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; EXEC DBMS_SYSTEM.set_ev(si=&gt;20, se=&gt;101, ev=&gt;10046, le=&gt;0, nm=&gt;&apos; &apos;);</span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure></p>
<p>这个包对应的解析如下：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">si binary_integer, -- SID</span><br><span class="line">se binary_integer, -- Serial#</span><br><span class="line">ev binary_integer, -- Event code or number to set.</span><br><span class="line">le binary_integer, -- Usually level to trace</span><br><span class="line">nm varchar2 -- sets the Event Name. null = &quot;context forever&quot;.</span><br></pre></td></tr></table></figure></p>
<h3 id="3-dbms-monitor"><a href="#3-dbms-monitor" class="headerlink" title="3. dbms_monitor"></a>3. dbms_monitor</h3><p>10g提供了一个新的包dbms_monitor可以用来启停SQL的追踪。使用这个包，不只是最终有一个官方的方式来全面利用SQL追踪，而且能够根据会话属性—客户端标记、服务名、模块名及操作名，开启或者关闭SQL追踪。默认情况下，只有DBA角色才运行执行这个包提供的过程。<br>会话级别dbms_monitor分别提供了session_trace_enable和session_trace_disable两个存储过程。<br>在10gR2中，当用session_trace_enbale开启追踪的时候，v$session视图的列sql_trace, sql_trace_waits, sql_trace_binds也会被设定跟上述存储过程相应的值。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; exec dbms_monitor.session_trace_enable(session_id =&gt; 20, serial_num =&gt; 101, waits =&gt; TRUE, binds =&gt; TRUE);</span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line">SYS@linora&gt; SELECT sql_trace, sql_trace_waits, sql_trace_binds</span><br><span class="line">  2  FROM v$session</span><br><span class="line">  3  WHERE sid = 20;</span><br><span class="line">SQL_TRAC SQL_T SQL_T</span><br><span class="line">-------- ----- -----</span><br><span class="line">ENABLED  TRUE  TRUE</span><br></pre></td></tr></table></figure></p>
<p>停止trace：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; exec dbms_monitor.session_trace_disable(session_id =&gt; 20, serial_num =&gt; 101);</span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line">SYS@linora&gt; SELECT sql_trace, sql_trace_waits, sql_trace_binds</span><br><span class="line">  2  FROM v$session</span><br><span class="line">  3  WHERE sid = 20;</span><br><span class="line">SQL_TRAC SQL_T SQL_T</span><br><span class="line">-------- ----- -----</span><br><span class="line">DISABLED FALSE FALSE</span><br></pre></td></tr></table></figure></p>
<h3 id="4-tkprof"><a href="#4-tkprof" class="headerlink" title="4. tkprof"></a>4. tkprof</h3><p>tkprof是格式化trace文件的一个工具，裸trace文件，读起来会有点困难，Oracle提供tkprof工具进行更为友好的阅读trace文件.此工具用法比较简单，在无其他参数的情况下，直接敲<code>tkprof</code>会得到简略的使用说明。注意，tkprof仅仅是作为对SQL跟踪的一种格式化工具，像10053或者其他错误信息导致的trace文件，tkprof是读取不了其中的信息的。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; alter session set events &apos;10046 trace name context forever,level 12&apos;;</span><br><span class="line">Session altered.</span><br><span class="line">SCOTT@linora&gt; select ename,job,sal,dname</span><br><span class="line">  2  from emp,dept where dept.deptno = emp.deptno and not exists</span><br><span class="line">  3  (select * from salgrade where emp.sal between losal and hisal);</span><br><span class="line">no rows selected</span><br><span class="line">SCOTT@linora&gt; ALTER SESSION SET EVENTS &apos;10046 trace name context off&apos;;</span><br><span class="line">Session altered.</span><br><span class="line">[oracle@linora:/home/oracle]$ tkprof /u01/app/oracle/diag/rdbms/linora/linora/trace/linora_ora_3899.trc \</span><br><span class="line">10046.txt waits=yes aggregate=yes sys=no</span><br></pre></td></tr></table></figure></p>
<p>有几个参数有必要说明一下：</p>
<p><li><code>explain</code></li><br>explain=username/password，如果没有使用explain，在trace文件中看到的会是SQL的实际执行路径，如果使用了explain，则在trace不但输入了实际的执行路径，还会生成该SQL的执行计划。  </p>
<p><li><code>sys</code></li><br>sys=yes/no，默认为yes，表示在trace文件中输出sys用户的操作，设置sys=no后，trace文件更具有可读性。  </p>
<p><li><code>aggregate</code></li><br>aggregate=yes/no，默认设置为yes，即将所有相同的SQL在输入文件中合并，如果设置为no，则分别列出每个sql的信息。</p>
<p><li><code>waits</code></li><br>waits=yes/no，waits=yes显示等待事件及等待时间信息等。</p>
<p><li><code>sort</code></li><br>sort=option有大量的排序条件，一般对于查询的调优 常用的组合是 SYS=NO  fchela， fchela即按照fetch阶段的elapsed time按照从大到小排列，fchela也是默认的方式。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Rows (1st) Rows (avg) Rows (max)  Row Source Operation</span><br><span class="line">---------- ---------- ----------  ---------------------------------------------------</span><br><span class="line">         0          0          0  MERGE JOIN ANTI (cr=15 pr=0 pw=0 time=2769 us cost=11 size=840 card=14)</span><br><span class="line">        14         14         14   SORT JOIN (cr=8 pr=0 pw=0 time=1118 us cost=7 size=476 card=14)</span><br><span class="line">        14         14         14    MERGE JOIN  (cr=8 pr=0 pw=0 time=839 us cost=6 size=476 card=14)</span><br><span class="line">         4          4          4     TABLE ACCESS BY INDEX ROWID DEPT (cr=2 pr=0 pw=0 time=323 us cost=2 size=52 card=4)</span><br><span class="line">         4          4          4      INDEX FULL SCAN PK_DEPT (cr=1 pr=0 pw=0 time=86 us cost=1 size=0 card=4)(object id 84557)</span><br><span class="line">        14         14         14     SORT JOIN (cr=6 pr=0 pw=0 time=430 us cost=4 size=294 card=14)</span><br><span class="line">        14         14         14      TABLE ACCESS FULL EMP (cr=6 pr=0 pw=0 time=175 us cost=3 size=294 card=14)</span><br><span class="line">        14         14         14   FILTER  (cr=7 pr=0 pw=0 time=1420 us)</span><br><span class="line">        14         14         14    SORT JOIN (cr=7 pr=0 pw=0 time=699 us cost=4 size=130 card=5)</span><br><span class="line">         5          5          5     TABLE ACCESS FULL SALGRADE (cr=7 pr=0 pw=0 time=114 us cost=3 size=130 card=5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Elapsed times include waiting on following events:</span><br><span class="line">  Event waited on                             Times   Max. Wait  Total Waited</span><br><span class="line">  ----------------------------------------   Waited  ----------  ------------</span><br><span class="line">  SQL*Net message to client                       1        0.00          0.00</span><br></pre></td></tr></table></figure></p>
<p>以上为实际的执行路径，以下为带执行计划的实际执行路径：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ tkprof linora_ora_2392.trc explain_10046.txt sys=no aggregate=yes waits=yes explain=scott/oracle</span><br><span class="line">Rows (1st) Rows (avg) Rows (max)  Row Source Operation</span><br><span class="line">---------- ---------- ----------  ---------------------------------------------------</span><br><span class="line">         0          0          0  MERGE JOIN ANTI (cr=15 pr=0 pw=0 time=2769 us cost=11 size=840 card=14)</span><br><span class="line">        14         14         14   SORT JOIN (cr=8 pr=0 pw=0 time=1118 us cost=7 size=476 card=14)</span><br><span class="line">        14         14         14    MERGE JOIN  (cr=8 pr=0 pw=0 time=839 us cost=6 size=476 card=14)</span><br><span class="line">         4          4          4     TABLE ACCESS BY INDEX ROWID DEPT (cr=2 pr=0 pw=0 time=323 us cost=2 size=52 card=4)</span><br><span class="line">         4          4          4      INDEX FULL SCAN PK_DEPT (cr=1 pr=0 pw=0 time=86 us cost=1 size=0 card=4)(object id 84557)</span><br><span class="line">        14         14         14     SORT JOIN (cr=6 pr=0 pw=0 time=430 us cost=4 size=294 card=14)</span><br><span class="line">        14         14         14      TABLE ACCESS FULL EMP (cr=6 pr=0 pw=0 time=175 us cost=3 size=294 card=14)</span><br><span class="line">        14         14         14   FILTER  (cr=7 pr=0 pw=0 time=1420 us)</span><br><span class="line">        14         14         14    SORT JOIN (cr=7 pr=0 pw=0 time=699 us cost=4 size=130 card=5)</span><br><span class="line">         5          5          5     TABLE ACCESS FULL SALGRADE (cr=7 pr=0 pw=0 time=114 us cost=3 size=130 card=5)</span><br><span class="line">Rows     Execution Plan</span><br><span class="line">-------  ---------------------------------------------------</span><br><span class="line">      0  SELECT STATEMENT   MODE: ALL_ROWS</span><br><span class="line">      0   NESTED LOOPS</span><br><span class="line">     14    NESTED LOOPS</span><br><span class="line">     14     MERGE JOIN (ANTI)</span><br><span class="line">      4      SORT (JOIN)</span><br><span class="line">      4       TABLE ACCESS   MODE: ANALYZED (FULL) OF &apos;EMP&apos; (TABLE)</span><br><span class="line">     14      FILTER</span><br><span class="line">     14       SORT (JOIN)</span><br><span class="line">     14        TABLE ACCESS   MODE: ANALYZED (FULL) OF &apos;SALGRADE&apos; (TABLE)</span><br><span class="line">     14     INDEX   MODE: ANALYZED (UNIQUE SCAN) OF &apos;PK_DEPT&apos; (INDEX(UNIQUE))</span><br><span class="line">      5    TABLE ACCESS   MODE: ANALYZED (BY INDEX ROWID) OF &apos;DEPT&apos;(TABLE)</span><br><span class="line">Elapsed times include waiting on following events:</span><br><span class="line">  Event waited on                             Times   Max. Wait  Total Waited</span><br><span class="line">  ----------------------------------------   Waited  ----------  ------------</span><br><span class="line">  SQL*Net message to client                       1        0.00          0.00</span><br></pre></td></tr></table></figure></p>
<h3 id="5-10046-trace文件阅读"><a href="#5-10046-trace文件阅读" class="headerlink" title="5. 10046 trace文件阅读"></a>5. 10046 trace文件阅读</h3><p>#####经过tkprof格式化后的文件：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TKPROF: Release 11.2.0.4.0 - Development on Thu Jul 24 23:17:09 2014</span><br><span class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</span><br><span class="line">Trace file: linora_ora_2348.trc</span><br><span class="line">Sort options: default</span><br><span class="line">********************************************************************************</span><br><span class="line">count    = number of times OCI procedure was executed</span><br><span class="line">cpu      = cpu time in seconds executing </span><br><span class="line">elapsed  = elapsed time in seconds executing</span><br><span class="line">disk     = number of physical reads of buffers from disk</span><br><span class="line">query    = number of buffers gotten for consistent read</span><br><span class="line">current  = number of buffers gotten in current mode (usually for update)</span><br><span class="line">rows     = number of rows processed by the fetch or execute call</span><br><span class="line">********************************************************************************</span><br><span class="line">SQL ID: 8gt5ty6pfca35 Plan Hash: 1070587533</span><br><span class="line"></span><br><span class="line">SELECT /* OPT_DYN_SAMP */ /*+ ALL_ROWS IGNORE_WHERE_CLAUSE </span><br><span class="line">  NO_PARALLEL(SAMPLESUB) opt_param(&apos;parallel_execution_enabled&apos;, &apos;false&apos;) </span><br><span class="line">  NO_PARALLEL_INDEX(SAMPLESUB) NO_SQL_TUNE */ NVL(SUM(C1),:&quot;SYS_B_0&quot;), </span><br><span class="line">  NVL(SUM(C2),:&quot;SYS_B_1&quot;), COUNT(DISTINCT C3), NVL(SUM(CASE WHEN C3 IS NULL </span><br><span class="line">  THEN :&quot;SYS_B_2&quot; ELSE :&quot;SYS_B_3&quot; END),:&quot;SYS_B_4&quot;), COUNT(DISTINCT C4), </span><br><span class="line">  NVL(SUM(CASE WHEN C4 IS NULL THEN :&quot;SYS_B_5&quot; ELSE :&quot;SYS_B_6&quot; END),</span><br><span class="line">  :&quot;SYS_B_7&quot;) </span><br><span class="line">FROM</span><br><span class="line"> (SELECT /*+ NO_PARALLEL(&quot;SALGRADE&quot;) FULL(&quot;SALGRADE&quot;) </span><br><span class="line">  NO_PARALLEL_INDEX(&quot;SALGRADE&quot;) */ :&quot;SYS_B_8&quot; AS C1, :&quot;SYS_B_9&quot; AS C2, </span><br><span class="line">  &quot;SALGRADE&quot;.&quot;HISAL&quot; AS C3, &quot;SALGRADE&quot;.&quot;LOSAL&quot; AS C4 FROM &quot;SCOTT&quot;.&quot;SALGRADE&quot; </span><br><span class="line">  &quot;SALGRADE&quot;) SAMPLESUB</span><br></pre></td></tr></table></figure></p>
<p>上述信息包含了tkprof版本信息，trace文件名称，以及在一些图表中各个参数的解析。在上例中，我们看到有<code>/* OPT_DYN_SAMP */</code>信息，表示这个语句是CBO在做动态采样的SQL语句，也表明，我们这个SALGRADE表可能没做分析。Misses in library cache during 表示在解析及执行阶段library cache发生了miss，则说明是硬解析。<br>call: 每一个游标的行为被分成三个步骤：<br><code>Parse</code>：表示SQL的分析阶段所耗资源。<br><code>Execute</code>：表示SQL的执行阶段所耗资源。<br><code>Fetch</code>：表示数据提取阶段所耗资源。<br><code>Count</code>：表示当前的操作被执行了多少次。<br><code>Cpu</code>：表示当前操作消耗的CPU事件，单位为秒。<br><code>Elapsed</code>：表示当前操作一共用时多少秒，包括CPU事件跟等待时间。<br><code>Disk</code>：表示当前操作的物理读，即磁盘IO次数。<br><code>Query</code>：表示当前操作的一致性读方式读取的数据块，通常是查询语句使用的方式。<br><code>Current</code>：表示当前操作的逻辑读取的数据块，通常是修改数据使用的方式。<br><code>Rows</code>：表示当前操作处理的数据记录数。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">select  ename,job,sal,dname</span><br><span class="line">from emp,dept where dept.deptno = emp.deptno and not exists</span><br><span class="line">(select * from salgrade where emp.sal between losal and hisal)</span><br><span class="line">call     count       cpu    elapsed       disk      query    current        rows</span><br><span class="line">------- ------  -------- ---------- ---------- ---------- ----------  ----------</span><br><span class="line">Parse        1      0.02       0.02          0         22          0           0</span><br><span class="line">Execute      1      0.00       0.00          0          0          0           0</span><br><span class="line">Fetch        1      0.00       0.00          0         15          0           0</span><br><span class="line">------- ------  -------- ---------- ---------- ---------- ----------  ----------</span><br><span class="line">total        3      0.02       0.02          0         37          0           0</span><br><span class="line">Misses in library cache during parse: 1</span><br><span class="line">Optimizer mode: ALL_ROWS</span><br><span class="line">Parsing user id: 70  (SCOTT)</span><br><span class="line">Number of plan statistics captured: 1</span><br></pre></td></tr></table></figure></p>
<p>接下来就是上面的我们执行的相关SQL信息，可以从上面的信息看到，优化器模式使用的是ALL_ROWS，且有一次硬解析，用户为SCOTT。此条SQL语句被分析了一次，执行了一次，数据提取了一次，消耗CPU时间为0.02秒，均花在解析阶段，一致性读取了37个块，没有磁盘读。</p>
<p>#####未经tkprof格式化的文件<br>构建环境，加入一个绑定变量并生成trace<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FUNG@linora&gt; VARIABLE loc VARCHAR2(30)</span><br><span class="line">FUNG@linora&gt; EXEC :loc:=&apos;South San Francisco&apos;</span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line">FUNG@linora&gt; alter session set events &apos;10046 trace name context forever, level 12&apos;;</span><br><span class="line">Session altered.</span><br><span class="line">FUNG@linora&gt; SELECT emp.last_name, emp.first_name, j.job_title, d.department_name, l.city,</span><br><span class="line">l.state_province, l.postal_code, l.street_address, emp.email,</span><br><span class="line">emp.phone_number, emp.hire_date, emp.salary, mgr.last_name</span><br><span class="line">FROM hr.employees emp, hr.employees mgr, hr.departments d, hr.locations l, hr.jobs j</span><br><span class="line">WHERE l.city=:loc</span><br><span class="line">AND emp.manager_id=mgr.employee_id</span><br><span class="line">AND emp.department_id=d.department_id</span><br><span class="line">AND d.location_id=l.location_id</span><br><span class="line">AND emp.job_id=j.job_id;</span><br><span class="line">FUNG@linora&gt; select * from v$diag_info;</span><br></pre></td></tr></table></figure></p>
<p>未经tkprof格式化的trace文件<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PARSING IN CURSOR # 140430523695752 len=430 dep=0 uid=66 oct=3 lid=66 tim=1406340835532883 hv=2605724446 ad=&apos;8b986bb8&apos; sqlid=&apos;6fdr5n2dp0csy&apos;</span><br><span class="line">SELECT emp.last_name, emp.first_name, j.job_title, d.department_name, l.city,</span><br><span class="line">l.state_province, l.postal_code, l.street_address, emp.email,</span><br><span class="line">emp.phone_number, emp.hire_date, emp.salary, mgr.last_name</span><br><span class="line">FROM hr.employees emp, hr.employees mgr, hr.departments d, hr.locations l, hr.jobs j</span><br><span class="line">WHERE l.city=:loc</span><br><span class="line">AND emp.manager_id=mgr.employee_id</span><br><span class="line">AND emp.department_id=d.department_id</span><br><span class="line">AND d.location_id=l.location_id</span><br><span class="line">AND emp.job_id=j.job_id</span><br><span class="line">END OF STMT</span><br><span class="line">PARSE # 140430523695752:c=3000,e=3186,p=0,cr=0,cu=0,mis=1,r=0,dep=0,og=1,plh=0,tim=1406340835532850</span><br></pre></td></tr></table></figure></p>
<p>CURSOR表示游标号，len表示SQL语句长度，dep表示SQL的递归深度，如果dep=0，表示不是递归SQL，UID为users$表中的user#，通过它可以查询到是谁发起的SQL，OCT=3为sql命令的类型，3表示select操作，11g可通过select command_type,command_name from V$SQLCOMMAND;获得对应关系，c和e都表示时间，一个是cpu消耗时间，一个是Elapsed时间，都以1/100W秒（微秒）为单位。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">WAIT # 140430523695752: nam=&apos;db file sequential read&apos; ela= 9559 file#=8 block#=11515 blocks=1 obj#=84744 tim=1406340835774246</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file sequential read&apos; ela= 503 file#=8 block#=11476 blocks=1 obj#=84737 tim=1406340835774830</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file scattered read&apos; ela= 671 file#=8 block#=11477 blocks=3 obj#=84737 tim=1406340835776772</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file sequential read&apos; ela= 496 file#=8 block#=11458 blocks=1 obj#=84735 tim=1406340835777504</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file scattered read&apos; ela= 560 file#=8 block#=11459 blocks=5 obj#=84735 tim=1406340835778142</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file sequential read&apos; ela= 519 file#=8 block#=11490 blocks=1 obj#=84739 tim=1406340835779259</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file scattered read&apos; ela= 888 file#=8 block#=11491 blocks=5 obj#=84739 tim=1406340835780251</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file sequential read&apos; ela= 12191 file#=8 block#=11666 blocks=1 obj#=84747 tim=1406340835793607</span><br><span class="line">WAIT # 140430523695752: nam=&apos;db file scattered read&apos; ela= 725 file#=8 block#=11667 blocks=5 obj#=84747 tim=1406340835794438</span><br><span class="line">FETCH # 140430523695752:c=7000,e=60243,p=27,cr=19,cu=0,mis=0,r=1,dep=0,og=1,plh=2361458858,tim=1406340835794675</span><br><span class="line">WAIT # 140430523695752: nam=&apos;SQL*Net message from client&apos; ela= 458 driver id=1650815232 #bytes=1 p3=0 obj#=84747 tim=1406340835795214</span><br><span class="line">WAIT # 140430523695752: nam=&apos;SQL*Net message to client&apos; ela= 5 driver id=1650815232 #bytes=1 p3=0 obj#=84747 tim=1406340835795283</span><br><span class="line">FETCH # 140430523695752:c=0,e=69,p=0,cr=1,cu=0,mis=0,r=15,dep=0,og=1,plh=2361458858,tim=1406340835795333</span><br><span class="line">WAIT # 140430523695752: nam=&apos;SQL*Net message from client&apos; ela= 2045 driver id=1650815232 #bytes=1 p3=0 obj#=84747 tim=1406340835797425</span><br><span class="line">WAIT # 140430523695752: nam=&apos;SQL*Net message to client&apos; ela= 7 driver id=1650815232 #bytes=1 p3=0 obj#=84747 tim=1406340835797553</span><br><span class="line">FETCH # 140430523695752:c=0,e=141,p=0,cr=1,cu=0,mis=0,r=15,dep=0,og=1,plh=2361458858,tim=1406340835797621</span><br><span class="line">WAIT # 140430523695752: nam=&apos;SQL*Net message from client&apos; ela= 9520 driver id=1650815232 #bytes=1 p3=0 obj#=84747 tim=1406340835807188</span><br><span class="line">WAIT # 140430523695752: nam=&apos;SQL*Net message to client&apos; ela= 5 driver id=1650815232 #bytes=1 p3=0 obj#=84747 tim=1406340835807262</span><br><span class="line">FETCH # 140430523695752:c=0,e=149,p=0,cr=1,cu=0,mis=0,r=14,dep=0,og=1,plh=2361458858,tim=1406340835807391</span><br><span class="line">STAT # 140430523695752 id=1 cnt=45 pid=0 pos=1 obj=0 op=&apos;HASH JOIN  (cr=22 pr=27 pw=0 time=60289 us cost=10 size=2580 card=15)&apos;</span><br><span class="line">STAT # 140430523695752 id=2 cnt=45 pid=1 pos=1 obj=0 op=&apos;HASH JOIN  (cr=13 pr=15 pw=0 time=43883 us cost=8 size=2400 card=15)&apos;</span><br><span class="line">STAT # 140430523695752 id=3 cnt=45 pid=2 pos=1 obj=0 op=&apos;NESTED LOOPS  (cr=7 pr=9 pw=0 time=42041 us cost=5 size=1995 card=15)&apos;</span><br><span class="line">STAT # 140430523695752 id=4 cnt=45 pid=3 pos=1 obj=0 op=&apos;NESTED LOOPS  (cr=5 pr=5 pw=0 time=40180 us cost=5 size=1995 card=40)&apos;</span><br><span class="line">STAT # 140430523695752 id=5 cnt=1 pid=4 pos=1 obj=0 op=&apos;NESTED LOOPS  (cr=4 pr=4 pw=0 time=30076 us cost=3 size=268 card=4)&apos;</span><br><span class="line">STAT # 140430523695752 id=6 cnt=1 pid=5 pos=1 obj=84729 op=&apos;TABLE ACCESS BY INDEX ROWID LOCATIONS (cr=2 pr=2 pw=0 time=27964 us cost=2 size=48 card=1)&apos;</span><br><span class="line">STAT # 140430523695752 id=7 cnt=1 pid=6 pos=1 obj=84752 op=&apos;INDEX RANGE SCAN LOC_CITY_IX (cr=1 pr=1 pw=0 time=19682 us cost=1 size=0 card=1)&apos;</span><br><span class="line">STAT # 140430523695752 id=8 cnt=1 pid=5 pos=2 obj=84732 op=&apos;TABLE ACCESS BY INDEX ROWID DEPARTMENTS (cr=2 pr=2 pw=0 time=2081 us cost=1 size=76 card=4)&apos;</span><br><span class="line">STAT # 140430523695752 id=9 cnt=1 pid=8 pos=1 obj=84748 op=&apos;INDEX RANGE SCAN DEPT_LOCATION_IX (cr=1 pr=1 pw=0 time=407 us cost=0 size=0 card=4)&apos;</span><br><span class="line">STAT # 140430523695752 id=10 cnt=45 pid=4 pos=2 obj=84744 op=&apos;INDEX RANGE SCAN EMP_DEPARTMENT_IX (cr=1 pr=1 pw=0 time=9811 us cost=0 size=0 card=10)&apos;</span><br><span class="line">STAT # 140430523695752 id=11 cnt=45 pid=3 pos=2 obj=84737 op=&apos;TABLE ACCESS BY INDEX ROWID EMPLOYEES (cr=2 pr=4 pw=0 time=1779 us cost=1 size=264 card=4)&apos;</span><br><span class="line">STAT # 140430523695752 id=12 cnt=19 pid=2 pos=2 obj=84735 op=&apos;TABLE ACCESS FULL JOBS (cr=6 pr=6 pw=0 time=1272 us cost=3 size=513 card=19)&apos;</span><br><span class="line">STAT # 140430523695752 id=13 cnt=107 pid=1 pos=2 obj=0 op=&apos;VIEW  index$_join$_002 (cr=9 pr=12 pw=0 time=18317 us cost=2 size=1284 card=107)&apos;</span><br><span class="line">STAT # 140430523695752 id=14 cnt=107 pid=13 pos=1 obj=0 op=&apos;HASH JOIN  (cr=9 pr=12 pw=0 time=17668 us)&apos;</span><br><span class="line">STAT # 140430523695752 id=15 cnt=107 pid=14 pos=1 obj=84739 op=&apos;INDEX FAST FULL SCAN EMP_EMP_ID_PK (cr=3 pr=6 pw=0 time=2049 us cost=1 size=1284 card=107)&apos;</span><br><span class="line">STAT # 140430523695752 id=16 cnt=107 pid=14 pos=2 obj=84747 op=&apos;INDEX FAST FULL SCAN EMP_NAME_IX (cr=6 pr=6 pw=0 time=13597 us cost=1 size=1284 card=107)&apos;</span><br></pre></td></tr></table></figure></p>
<p>wait表示等待事件信息，含有等待时间，操作时间(ela,单位为微秒)，等待事件的p1，p2，p3可用v$event_name获得，像上例中的等待事件’db file sequential read’，p1=file# 8，p2=block# ，p3=blocks，即表示该操作读取的是数据文件id号为8的文件，从p2块号开始，读取了几个块。<br>fetch中，p和cr分别表示物理读和一致性读引起的buffer get，cu表示current read引起的buffer get，r表示处理的行数。<br>stat表示在执行过程中消耗的资源信息统计，从stat可以划出执行计划步骤，正常的执行计划图：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                        | Name              | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT                 |                   |    15 |  2580 |    10   (0)| 00:00:01 |</span><br><span class="line">|*  1 |  HASH JOIN                       |                   |    15 |  2580 |    10   (0)| 00:00:01 |</span><br><span class="line">|*  2 |   HASH JOIN                      |                   |    15 |  2400 |     8   (0)| 00:00:01 |</span><br><span class="line">|   3 |    NESTED LOOPS                  |                   |    15 |  1995 |     5   (0)| 00:00:01 |</span><br><span class="line">|   4 |     NESTED LOOPS                 |                   |    40 |  1995 |     5   (0)| 00:00:01 |</span><br><span class="line">|   5 |      NESTED LOOPS                |                   |     4 |   268 |     3   (0)| 00:00:01 |</span><br><span class="line">|   6 |       TABLE ACCESS BY INDEX ROWID| LOCATIONS         |     1 |    48 |     2   (0)| 00:00:01 |</span><br><span class="line">|*  7 |        INDEX RANGE SCAN          | LOC_CITY_IX       |     1 |       |     1   (0)| 00:00:01 |</span><br><span class="line">|   8 |       TABLE ACCESS BY INDEX ROWID| DEPARTMENTS       |     4 |    76 |     1   (0)| 00:00:01 |</span><br><span class="line">|*  9 |        INDEX RANGE SCAN          | DEPT_LOCATION_IX  |     4 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|* 10 |      INDEX RANGE SCAN            | EMP_DEPARTMENT_IX |    10 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|  11 |     TABLE ACCESS BY INDEX ROWID  | EMPLOYEES         |     4 |   264 |     1   (0)| 00:00:01 |</span><br><span class="line">|  12 |    TABLE ACCESS FULL             | JOBS              |    19 |   513 |     3   (0)| 00:00:01 |</span><br><span class="line">|  13 |   VIEW                           | index$_join$_002  |   107 |  1284 |     2   (0)| 00:00:01 |</span><br><span class="line">|* 14 |    HASH JOIN                     |                   |       |       |            |          |</span><br><span class="line">|  15 |     INDEX FAST FULL SCAN         | EMP_EMP_ID_PK     |   107 |  1284 |     1   (0)| 00:00:01 |</span><br><span class="line">|  16 |     INDEX FAST FULL SCAN         | EMP_NAME_IX       |   107 |  1284 |     1   (0)| 00:00:01 |</span><br><span class="line">------------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></p>
<p>stat中的id对应就是plan table中的id，cnt表示返回的rows，在这里可以看到plan table中id=0只返回了15行，而10046返回的行数是真实执行返回的行数，plan table仅仅是根据表的统计信息(直方图，动态采样)而评估的返回结果。pid表示当前行源的父节点，pos表示同级行源的不同位置，一般同级行源先执行pos较小的操作。obj代表着dba_object.object_id，op对应plan table中的operation。</p>
<h3 id="6-10053事件"><a href="#6-10053事件" class="headerlink" title="6. 10053事件"></a>6. 10053事件</h3><p>10053解析的是CBO为何选择该执行计划。<br>比如，CBO为何会选择index range scan？为何会选择table full scan？10053事件可以帮我们获取答案，10053仅有两个级别1和2，一般设置为1.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">FUNG@linora&gt; VARIABLE loc VARCHAR2(30)</span><br><span class="line">FUNG@linora&gt; EXEC :loc:=&apos;South San Francisco&apos; </span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line"></span><br><span class="line">FUNG@linora&gt; alter session set events &apos;10053 trace name context forever,level 1&apos;;</span><br><span class="line"></span><br><span class="line">Session altered.</span><br><span class="line"></span><br><span class="line">FUNG@linora&gt; SELECT emp.last_name, emp.first_name, j.job_title, d.department_name, l.city,</span><br><span class="line">  2  l.state_province, l.postal_code, l.street_address, emp.email,</span><br><span class="line">  3  emp.phone_number, emp.hire_date, emp.salary, mgr.last_name</span><br><span class="line">  4  FROM hr.employees emp, hr.employees mgr, hr.departments d, hr.locations l, hr.jobs j</span><br><span class="line">  5  WHERE l.city=:loc</span><br><span class="line">  6  AND emp.manager_id=mgr.employee_id</span><br><span class="line">  7  AND emp.department_id=d.department_id</span><br><span class="line">  8  AND d.location_id=l.location_id</span><br><span class="line">  9  AND emp.job_id=j.job_id;</span><br><span class="line">FUNG@linora&gt; alter session set events &apos;10053 trace name context off&apos;;</span><br></pre></td></tr></table></figure></p>
<p>10053事件的trace中，包含有查询相关表的信息，包括表、索引统计信息，直方图信息，Clustering Factor，单表访问路径，多表联合的方式，对于n表联合，它会采取多重方式进行评估，理论上需要进行(n-1)!次组合，但是CBO当发现下一次组合的cost比最优的要大时，它会停止分析下去。<br>对于表信息统计如下<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">***************************************</span><br><span class="line">BASE STATISTICAL INFORMATION</span><br><span class="line">***********************</span><br><span class="line">Table Stats::</span><br><span class="line">  Table: JOBS  Alias:  J</span><br><span class="line">    #Rows: 19  #Blks:  5  AvgRowLen:  33.00  ChainCnt:  0.00</span><br><span class="line">  Column (# 1): JOB_ID(</span><br><span class="line">    AvgLen: 8 NDV: 19 Nulls: 0 Density: 0.052632</span><br><span class="line">Index Stats::</span><br><span class="line">  Index: JOB_ID_PK  Col#: 1</span><br><span class="line">    LVLS: 0  #LB: 1  #DK: 19  LB/K: 1.00  DB/K: 1.00  CLUF: 1.00</span><br><span class="line">***********************</span><br><span class="line">Table Stats::</span><br><span class="line">  Table: DEPARTMENTS  Alias:  D</span><br><span class="line">    #Rows: 27  #Blks:  5  AvgRowLen:  21.00  ChainCnt:  0.00</span><br><span class="line">  Column (# 1): DEPARTMENT_ID(</span><br><span class="line">    AvgLen: 4 NDV: 27 Nulls: 0 Density: 0.037037 Min: 10 Max: 270</span><br><span class="line">  Column (# 4): LOCATION_ID(</span><br><span class="line">    AvgLen: 3 NDV: 7 Nulls: 0 Density: 0.018519 Min: 1400 Max: 2700</span><br><span class="line">    Histogram: Freq  #Bkts: 7  UncompBkts: 27  EndPtVals: 7</span><br><span class="line">Index Stats::</span><br><span class="line">  Index: DEPT_ID_PK  Col#: 1</span><br><span class="line">    LVLS: 0  #LB: 1  #DK: 27  LB/K: 1.00  DB/K: 1.00  CLUF: 1.00</span><br><span class="line">  Index: DEPT_LOCATION_IX  Col#: 4</span><br><span class="line">    LVLS: 0  #LB: 1  #DK: 7  LB/K: 1.00  DB/K: 1.00  CLUF: 1.00</span><br><span class="line">***********************</span><br></pre></td></tr></table></figure></p>
<p>rows表示CBO对这张表行数的预估，栏位信息中，NDV表示number of distinct values，Density表示密度，在索引中，有个比较关键的CLUF，表示<a href="/oracle/clustering-factor.html">Clustering Factor</a>。在D表的统计中，Column 4是含有Freq Histogram<a href="/oracle/oracle-histograms.html">Histogram</a>。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Access path analysis for LOCATIONS</span><br><span class="line">***************************************</span><br><span class="line">SINGLE TABLE ACCESS PATH </span><br><span class="line">  Single Table Cardinality Estimation for LOCATIONS[L] </span><br><span class="line">  Column (# 4): CITY(</span><br><span class="line">    AvgLen: 9 NDV: 23 Nulls: 0 Density: 0.043478</span><br><span class="line">  Table: LOCATIONS  Alias: L</span><br><span class="line">    Card: Original: 23.000000  Rounded: 1  Computed: 1.00  Non Adjusted: 1.00</span><br><span class="line">  Access Path: TableScan</span><br><span class="line">    Cost:  3.00  Resp: 3.00  Degree: 0</span><br><span class="line">      Cost_io: 3.00  Cost_cpu: 41607</span><br><span class="line">      Resp_io: 3.00  Resp_cpu: 41607</span><br><span class="line">  Access Path: index (AllEqRange)</span><br><span class="line">    Index: LOC_CITY_IX</span><br><span class="line">    resc_io: 2.00  resc_cpu: 14673</span><br><span class="line">    ix_sel: 0.043478  ix_sel_with_filters: 0.043478 </span><br><span class="line">    Cost: 2.00  Resp: 2.00  Degree: 1</span><br><span class="line">  Best:: AccessPath: IndexRange</span><br><span class="line">  Index: LOC_CITY_IX</span><br><span class="line">         Cost: 2.00  Degree: 1  Resp: 2.00  Card: 1.00  Bytes: 0</span><br></pre></td></tr></table></figure></p>
<p>对L表单路径访问中，Card: Original: 23.000000 表示L表原始记录为23行，Rounded: 1表示预估输出结果，为1条记录。CBO认为可能使用以下2种方式访问T表：<br>1.Access Path: TableScan<br>2.Access Path: index (AllEqRange)<br>其中，cost最低的为IndexRange。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">***************************************</span><br><span class="line">GENERAL PLANS</span><br><span class="line">***************************************</span><br><span class="line">Considering cardinality-based initial join order.</span><br><span class="line">Permutations for Starting Table :0</span><br><span class="line">Join order[1]:  LOCATIONS[L]# 0  JOBS[J]# 1  DEPARTMENTS[D]# 2  EMPLOYEES[EMP]# 3  EMPLOYEES[MGR]# 4</span><br><span class="line">***********************</span><br><span class="line">Best so far:  Table#: 0  cost: 2.0009  card: 1.0000  bytes: 48</span><br><span class="line">              Table#: 1  cost: 5.0033  card: 19.0000  bytes: 1425</span><br><span class="line">              Table#: 2  cost: 8.0440  card: 73.2857  bytes: 6862</span><br><span class="line">              Table#: 3  cost: 11.0873  card: 15.1429  bytes: 2400</span><br><span class="line">              Table#: 4  cost: 13.1681  card: 15.0013  bytes: 2580</span><br><span class="line">Join order[2]:  LOCATIONS[L]# 0  JOBS[J]# 1  DEPARTMENTS[D]# 2  EMPLOYEES[MGR]# 4  EMPLOYEES[EMP]# 3</span><br><span class="line">Join order aborted: cost &gt; best plan cost--CBO停止计算</span><br><span class="line">Join order[3]:  LOCATIONS[L]# 0  JOBS[J]# 1  EMPLOYEES[EMP]# 3  DEPARTMENTS[D]# 2  EMPLOYEES[MGR]# 4</span><br><span class="line">Join order[8]:  LOCATIONS[L]# 0  DEPARTMENTS[D]# 2  EMPLOYEES[EMP]# 3  JOBS[J]# 1  EMPLOYEES[MGR]# 4</span><br><span class="line">***********************</span><br><span class="line">Best so far:  Table#: 0  cost: 2.0009  card: 1.0000  bytes: 48</span><br><span class="line">              Table#: 2  cost: 3.0015  card: 3.8571  bytes: 268</span><br><span class="line">              Table#: 3  cost: 4.6329  card: 15.1429  bytes: 1995</span><br><span class="line">              Table#: 1  cost: 7.6730  card: 15.1429  bytes: 2400</span><br><span class="line">              Table#: 4  cost: 9.7539  card: 15.0013  bytes: 2580</span><br><span class="line">***************</span><br><span class="line">Now joining: EMPLOYEES[EMP]# 3</span><br><span class="line">***************</span><br><span class="line">Best:: JoinMethod: NestedLoop</span><br><span class="line">       Cost: 4.63  Degree: 1  Resp: 4.63  Card: 15.14 Bytes: 133</span><br><span class="line">***************</span><br><span class="line">Now joining: JOBS[J]# 1</span><br><span class="line">***************</span><br><span class="line">Best:: JoinMethod: Hash</span><br><span class="line">       Cost: 7.67  Degree: 1  Resp: 7.67  Card: 15.14 Bytes: 160</span><br><span class="line">***************</span><br><span class="line">Now joining: EMPLOYEES[MGR]# 4</span><br><span class="line">***************</span><br><span class="line">Best:: JoinMethod: Hash</span><br><span class="line">       Cost: 9.75  Degree: 1  Resp: 9.75  Card: 15.00 Bytes: 172</span><br></pre></td></tr></table></figure></p>
<p>以上为表的连接顺序，当遇到cost值大于最优的，CBO就会停止计算，从上面可以看出，Join 2~7都比1的COST要大，8的比1的要小。在Join order[8]中，CBO计算出与各个表连接COST最小的连接方式，最后在执行计划中体现出来。  </p>
<h3 id="7-CBO术语"><a href="#7-CBO术语" class="headerlink" title="7.CBO术语"></a>7.CBO术语</h3><p>#####Cardinality<br>Card是针对某条sql的某个具体执行步骤的执行结果所包含的记录的估算，在RAW 10046 trace文件中,STAT最后的card就表示每一个执行步骤结果集行数，而在10053 trace中，单表访问路径中包含了’Card: Original: 5.000000  Rounded: 5  Computed: 5.00  Non Adjusted: 5.00’，Orig表示CBD预估当前表总行数，Round则表示预估的返回结果四舍五入后的结果，Computed表示预估的返回结果。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 10046 raw trace</span><br><span class="line">STAT # 139958729041264 id=10 cnt=0 pid=1 pos=2 obj=84556 op=&apos;TABLE ACCESS BY INDEX ROWID DEPT (cr=0 pr=0 pw=0 time=0 us cost=1 size=13 card=1)&apos;</span><br><span class="line"># 10053 trace</span><br><span class="line">Access path analysis for SALGRADE</span><br><span class="line">***************************************</span><br><span class="line">SINGLE TABLE ACCESS PATH</span><br><span class="line">  Single Table Cardinality Estimation for SALGRADE[SALGRADE]</span><br><span class="line">  Table: SALGRADE  Alias: SALGRADE</span><br><span class="line">    Card: Original: 5.000000  Rounded: 5  Computed: 5.00  Non Adjusted: 5.00</span><br><span class="line">  Access Path: TableScan</span><br><span class="line">    Cost:  3.00  Resp: 3.00  Degree: 0</span><br><span class="line">      Cost_io: 3.00  Cost_cpu: 36557</span><br><span class="line">      Resp_io: 3.00  Resp_cpu: 36557</span><br><span class="line">  Best:: AccessPath: TableScan</span><br><span class="line">         Cost: 3.00  Degree: 1  Resp: 3.00  Card: 5.00  Bytes: 0</span><br></pre></td></tr></table></figure></p>
<p>####Selectivity<br>Selectivity=有谓词条件的返回结果记录数/未添加谓词的返回结果记录数，从定义上知道，如果sel越小，Card就越小，CBO估算的成本也就小。对于sel和card有如下关系：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Computed Card=Original * Sel</span><br></pre></td></tr></table></figure></p>
<p>####NDV<br>NDV=Number of distinct，表示表内不重复的值。如果目标列上既无直方图，也无NULL，则Sel=1/NDV。<br>To be continued!</p>
<p>Reference：<br><a href="http://www.askmaclean.com/archives/maclean-10046-sql-trace.html" target="_blank" rel="noopener">Maclean教你读Oracle 10046 SQL TRACE</a><br><a href="http://www.askmaclean.com/archives/maclean-tech-tkprof-10046.html" target="_blank" rel="noopener">Maclean教你读SQL TRACE TKProf报告</a></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/tuning/">#tuning</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/cdb-overview.html">12C CDB简介</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/manage-awr.html">管理AWR快照</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy; 2013 - 2018
                <a href="/">Fung Kong&nbsp;
                </a>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>