<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>12c使用dataguard broker配置带farsync的active dataguard - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="Oracle memoranda">



<meta name="keywords" content="oracle, database">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            12c使用dataguard broker配置带farsync的active dataguard
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-08-27T07:07:14.000Z" itemprop="datePublished">Aug 27 2019</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>   Active DataGuard far sync是12c引进的新功能。在以前的版本中，如果要做到sync同步，日志传输服务需要等待主库及远程备库均写入日志文件，然后向应用程序返回提交成功的通知。<br>   如果备库与主库物理距离增加，例如跨广域网实施零数据丢失的实时保护，这个返回确认的时间也会随之增加，数据库性能因此会受到极大影响，在距离较远的ADG同步上，sync模式也就变得有点不切实际。</p>
<h2 id="1-Far-sync-instance"><a href="#1-Far-sync-instance" class="headerlink" title="1. Far sync instance"></a>1. Far sync instance</h2><p>   Far sync instance(下文称Farsync实例)可以在跨广域网部署一个远程同步实例，这个实例只包含控制文件，spfile，密码文件和standby redo log，而不包含数据文件和联机重做日志。其在两地三中心建设中有很大的实用价值。<br>   Farsync实例通过sync传输从主库接收redo，并立即以async方式传输该redo到最多29个远程standby。<br>   Farsync实例可以为主库减轻以下负担：</p>
<ul>
<li>解析远程standby接收的归档日志的差异</li>
<li>主库仅需向远程同步实例传输一次redo，远程同步实例负责传输redo到多个目标</li>
<li>Farsync实例可以执行网络压缩，从而提高异地机房的传输效率</li>
</ul>
<h2 id="1-1-部署架构解析"><a href="#1-1-部署架构解析" class="headerlink" title="1.1 部署架构解析"></a>1.1 部署架构解析</h2><p><img src="./images/far_sync_adg1.jpg" alt="Far sync topology"></p>
<p>上图中，Farsync实例1及实例2部署在同城灾备中心，standby备库部署在异地机房，主库与farsync1通过sync实时同步，当farsync1失效时，farsync2接管farsync1进行实时同步redo；异地灾备机房同时部署一个farsync实例，在进行角色切换时，异地灾备机房同时拥有farsync实例进行实时同步。</p>
<p>创建步骤大概如下：</p>
<ul>
<li>通过rman duplicate创建standby</li>
<li>启用dataguard broker</li>
<li>通过broker启用farsync实例</li>
</ul>
<p>下面的例子中，采用OMF管理，如果非OMF管理需添加<code>db_file_name_convert</code>和<code>log_file_name_convert</code>参数.</p>
<h2 id="2-rman-duplicate前准备"><a href="#2-rman-duplicate前准备" class="headerlink" title="2. rman duplicate前准备"></a>2. rman duplicate前准备</h2><h3 id="2-1-所有节点主机名配置"><a href="#2-1-所有节点主机名配置" class="headerlink" title="2.1 所有节点主机名配置"></a>2.1 所有节点主机名配置</h3><figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.129.7	sdcdb01     # primary</span><br><span class="line">192.168.129.8	stcdb01     # standby</span><br><span class="line">192.168.129.9	sdfsdb01    # primary site farsync</span><br><span class="line">192.168.129.10	stfsdb01    # standby site farsync</span><br></pre></td></tr></table></figure>
<h3 id="2-2-主库启用force-logging"><a href="#2-2-主库启用force-logging" class="headerlink" title="2.2 主库启用force logging"></a>2.2 主库启用force logging</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">FORCE</span> <span class="hljs-keyword">LOGGING</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SWITCH</span> <span class="hljs-keyword">LOGFILE</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-主库添加standby-redo-log"><a href="#2-3-主库添加standby-redo-log" class="headerlink" title="2.3 主库添加standby redo log"></a>2.3 主库添加standby redo log</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-主库调整参数"><a href="#2-4-主库调整参数" class="headerlink" title="2.4 主库调整参数"></a>2.4 主库调整参数</h3><figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sqlplus / as sysdba &lt;&lt;EOF</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> STANDBY_FILE_MANAGEMENT=<span class="hljs-keyword">AUTO</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> archive_lag_target=<span class="hljs-number">1800</span> <span class="hljs-keyword">scope</span>=<span class="hljs-keyword">both</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> db_create_file_dest=<span class="hljs-string">'/u01/oradata'</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> db_create_online_log_dest_1=<span class="hljs-string">'/u01/oradata'</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">PLUGGABLE</span> <span class="hljs-keyword">DATABASE</span> sdpdb1 <span class="hljs-keyword">SAVE</span> STATE;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> local_listener=<span class="hljs-string">'LISTENER'</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> db_recovery_file_dest_size=<span class="hljs-number">20</span>G;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> db_recovery_file_dest=<span class="hljs-string">'/u01/app/oracle'</span>;</span><br><span class="line">exit;</span><br><span class="line">EOF&gt;&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-主备库监听设置"><a href="#2-5-主备库监听设置" class="headerlink" title="2.5 主备库监听设置"></a>2.5 主备库监听设置</h3><ul>
<li>主备库及farsync tns设置</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">SDCDB =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = sdcdb01)(PORT = 1521))</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = sdcdb)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">STCDB =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = stcdb01)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SID = sdcdb)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">SDFS01 =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = sdfsdb01)(PORT = 1521))</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = sdfs01)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">STFS01 =</span><br><span class="line">  (DESCRIPTION =</span><br><span class="line">    (ADDRESS_LIST =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = stfsdb01)(PORT = 1521))</span><br><span class="line">    )</span><br><span class="line">    (CONNECT_DATA =</span><br><span class="line">      (SERVER = DEDICATED)</span><br><span class="line">      (SERVICE_NAME = stfs01)</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<ul>
<li>主备库监听设置</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--primary</span></span><br><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = sdcdb01)(PORT = 1521))</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">SID_LIST_LISTENER =</span><br><span class="line">  (SID_LIST =</span><br><span class="line">    (SID_DESC =</span><br><span class="line">      (GLOBAL_DBNAME = sdcdb_DGMGRL)</span><br><span class="line">      (ORACLE_HOME = /u01/app/oracle/product/12.1.0)</span><br><span class="line">      (SID_NAME = sdcdb)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--standby</span></span><br><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = stcdb01)(PORT = 1521))</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">SID_LIST_LISTENER =</span><br><span class="line">  (SID_LIST =</span><br><span class="line">    (SID_DESC =</span><br><span class="line">      (GLOBAL_DBNAME = stcdb_DGMGRL)</span><br><span class="line">      (ORACLE_HOME = /u01/app/oracle/product/12.1.0)</span><br><span class="line">      (SID_NAME = sdcdb)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br></pre></td></tr></table></figure>
<p>启动监听<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsnrctl <span class="hljs-keyword">stop</span></span><br><span class="line">lsnrctl <span class="hljs-keyword">start</span></span><br></pre></td></tr></table></figure></p>
<h3 id="2-6-主库生成密码文件并传送到备库"><a href="#2-6-主库生成密码文件并传送到备库" class="headerlink" title="2.6 主库生成密码文件并传送到备库"></a>2.6 主库生成密码文件并传送到备库</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orapwd file=$ORACLE_HOME/dbs/orapw$ORACLE_SID password=manager entries=5 force=y ignorecase=y</span><br></pre></td></tr></table></figure>
<h3 id="2-7-备库创建相关目录"><a href="#2-7-备库创建相关目录" class="headerlink" title="2.7  备库创建相关目录"></a>2.7  备库创建相关目录</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /u01/oradata/sdcdb/pdbseed</span><br><span class="line">mkdir -p /u01/oradata/sdcdb/sdpdb1</span><br><span class="line">mkdir -p /u01/app/oracle/sdcdb</span><br><span class="line">mkdir -p /u01/app/oracle/fast_recovery_area/sdcdb</span><br><span class="line">mkdir -p /u01/app/oracle/admin/sdcdb/adump</span><br></pre></td></tr></table></figure>
<h3 id="2-8-备库添加pfile"><a href="#2-8-备库添加pfile" class="headerlink" title="2.8 备库添加pfile"></a>2.8 备库添加pfile</h3><p>内容如下:<br><figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.db_name=sdcdb</span><br></pre></td></tr></table></figure></p>
<h2 id="3-通过rman-duplicate创建standby"><a href="#3-通过rman-duplicate创建standby" class="headerlink" title="3. 通过rman duplicate创建standby"></a>3. 通过rman duplicate创建standby</h2><h3 id="3-1-在备库启动辅助数据库"><a href="#3-1-在备库启动辅助数据库" class="headerlink" title="3.1 在备库启动辅助数据库"></a>3.1 在备库启动辅助数据库</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STARTUP NOMOUNT PFILE='/home/oracle/stdby_pfile.ora'</span><br></pre></td></tr></table></figure>
<h3 id="3-2-备库启动rman-duplicate"><a href="#3-2-备库启动rman-duplicate" class="headerlink" title="3.2 备库启动rman duplicate"></a>3.2 备库启动rman duplicate</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rman target sys/manager@sdcdb auxiliary sys/manager@STCDB &lt;&lt;EOF</span><br><span class="line">run&#123;</span><br><span class="line">allocate channel c1 type disk;</span><br><span class="line">allocate auxiliary channel ch1 TYPE disk;</span><br><span class="line">DUPLICATE TARGET DATABASE FOR STANDBY FROM ACTIVE DATABASE DORECOVER</span><br><span class="line">spfile</span><br><span class="line"><span class="hljs-keyword">set</span> compatible=<span class="hljs-string">'12.1.0.2.0'</span></span><br><span class="line"><span class="hljs-keyword">set</span> db_unique_name=<span class="hljs-string">'stcdb'</span></span><br><span class="line">## 如果是非OMF管理</span><br><span class="line">## <span class="hljs-keyword">SET</span> db_file_name_convert=<span class="hljs-string">'/oradata'</span>,<span class="hljs-string">'/oradata_new'</span>,<span class="hljs-string">'/data'</span>,<span class="hljs-string">'/data_new'</span></span><br><span class="line">## <span class="hljs-keyword">SET</span> log_file_name_convert=<span class="hljs-string">'/oradata'</span>,<span class="hljs-string">'/oradata_new'</span>,<span class="hljs-string">'/data'</span>,<span class="hljs-string">'/data_new'</span></span><br><span class="line">nofilenamecheck;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="4-启用dgbroker"><a href="#4-启用dgbroker" class="headerlink" title="4. 启用dgbroker"></a>4. 启用dgbroker</h2><p>等待rman duplicate完成后，启用dataguard broker进行配置,从12c开始，如果是broker管理，已经不需要单独设置<code>log_archive_dest_2</code>了，如果主备库没有清除这个参数，broker会报以下错误:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: ORA-16698: LOG_ARCHIVE_DEST_n parameter <span class="hljs-keyword">set</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">object</span> <span class="hljs-keyword">to</span> be added</span><br></pre></td></tr></table></figure></p>
<h3 id="4-1-主备库同时修改"><a href="#4-1-主备库同时修改" class="headerlink" title="4.1 主备库同时修改"></a>4.1 主备库同时修改</h3><p>参数不存在则需要修改，如果参数已经存在，则可以不修改。如果是在RAC环境中，建议修改为ASM共享磁盘中。<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--RAC</span></span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> DG_BROKER_CONFIG_FILE1 = <span class="hljs-string">'+DATA/BROKER/dr1sdcdb.dat'</span> <span class="hljs-keyword">scope</span>=<span class="hljs-keyword">both</span> <span class="hljs-keyword">SID</span>=<span class="hljs-string">'*'</span>;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> DG_BROKER_CONFIG_FILE2 = <span class="hljs-string">'+DATA/BROKER/dr2sdcdb.dat'</span> <span class="hljs-keyword">scope</span>=<span class="hljs-keyword">both</span> <span class="hljs-keyword">SID</span>=<span class="hljs-string">'*'</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-2-主备库启用broker-deamon"><a href="#4-2-主备库启用broker-deamon" class="headerlink" title="4.2 主备库启用broker deamon"></a>4.2 主备库启用broker deamon</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> DG_BROKER_START=<span class="hljs-literal">TRUE</span> <span class="hljs-keyword">SCOPE</span>=<span class="hljs-keyword">BOTH</span> <span class="hljs-keyword">sid</span>=<span class="hljs-string">'*'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-broker中注册主备库"><a href="#4-3-broker中注册主备库" class="headerlink" title="4.3 broker中注册主备库"></a>4.3 broker中注册主备库</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dgmgrl sys/manager@sdcdb</span><br><span class="line">DGMGRL&gt; </span><br><span class="line"><span class="hljs-keyword">CREATE</span> CONFIGURATION sd_adg <span class="hljs-keyword">AS</span> PRIMARY <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IS</span> sdcdb <span class="hljs-keyword">CONNECT</span> IDENTIFIER <span class="hljs-keyword">IS</span> sdcdb;</span><br><span class="line"><span class="hljs-comment">--添加备库</span></span><br><span class="line">ADD DATABASE stcdb AS CONNECT IDENTIFIER IS stcdb MAINTAINED AS PHYSICAL;</span><br><span class="line"><span class="hljs-comment">--启用配置</span></span><br><span class="line">ENABLE CONFIGURATION;</span><br></pre></td></tr></table></figure>
<p>验证配置情况:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GMGRL&gt; show configuration</span><br><span class="line"></span><br><span class="line">Configuration - sd_adg</span><br><span class="line"></span><br><span class="line">  Protection Mode: MaxPerformance</span><br><span class="line">  Members:</span><br><span class="line">  sdcdb - Primary database</span><br><span class="line">    stcdb - Physical standby database</span><br><span class="line"></span><br><span class="line">Fast-<span class="hljs-keyword">Start</span> <span class="hljs-keyword">Failover</span>: DISABLED</span><br><span class="line"></span><br><span class="line">Configuration <span class="hljs-keyword">Status</span>:</span><br><span class="line"><span class="hljs-keyword">SUCCESS</span>   (<span class="hljs-keyword">status</span> <span class="hljs-keyword">updated</span> <span class="hljs-number">17</span> seconds ago)</span><br><span class="line"></span><br><span class="line">DGMGRL&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">database</span> stcdb</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Database</span> - stcdb</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">Role</span>:               <span class="hljs-keyword">PHYSICAL</span> <span class="hljs-keyword">STANDBY</span></span><br><span class="line">  Intended State:     <span class="hljs-keyword">APPLY</span>-<span class="hljs-keyword">ON</span></span><br><span class="line">  Transport Lag:      <span class="hljs-number">0</span> seconds (computed <span class="hljs-number">1</span> <span class="hljs-keyword">second</span> ago)</span><br><span class="line">  <span class="hljs-keyword">Apply</span> Lag:          <span class="hljs-number">0</span> seconds (computed <span class="hljs-number">1</span> <span class="hljs-keyword">second</span> ago)</span><br><span class="line">  Average <span class="hljs-keyword">Apply</span> Rate: <span class="hljs-number">4.00</span> KByte/s</span><br><span class="line">  <span class="hljs-built_in">Real</span> <span class="hljs-keyword">Time</span> <span class="hljs-keyword">Query</span>:    <span class="hljs-keyword">OFF</span>		# 实时查询状态为关闭</span><br><span class="line">  <span class="hljs-keyword">Instance</span>(s):</span><br><span class="line">    sdcdb</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Database</span> <span class="hljs-keyword">Status</span>:</span><br><span class="line"><span class="hljs-keyword">SUCCESS</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>主备库添加archive_lag参数</li>
</ul>
<figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt;</span><br><span class="line">edit database sdcdb <span class="hljs-keyword">set</span> property <span class="hljs-string">'ArchiveLagTarget'</span> = <span class="hljs-string">'1800'</span>;</span><br><span class="line">edit database stcdb <span class="hljs-keyword">set</span> property <span class="hljs-string">'ArchiveLagTarget'</span> = <span class="hljs-string">'1800'</span>;</span><br><span class="line"><span class="hljs-comment">--数据库中添加相应参数</span></span><br><span class="line">SQL&gt; alter system set archive_lag_target=1800 scope=both;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-备库启用实时应用"><a href="#4-4-备库启用实时应用" class="headerlink" title="4.4 备库启用实时应用"></a>4.4 备库启用实时应用</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHUTDOWN IMMEDIATE;</span><br><span class="line">STARTUP MOUNT;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">OPEN</span> <span class="hljs-keyword">READ</span> <span class="hljs-keyword">ONLY</span>;</span><br></pre></td></tr></table></figure>
<p>查询实时应用状态:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; show database stcdb</span><br><span class="line"></span><br><span class="line">Database - stcdb</span><br><span class="line"></span><br><span class="line">  Role:               PHYSICAL STANDBY</span><br><span class="line">  Intended State:     APPLY-ON</span><br><span class="line">  Transport Lag:      0 seconds (computed 0 seconds ago)</span><br><span class="line">  Apply Lag:          0 seconds (computed 0 seconds ago)</span><br><span class="line">  Average Apply Rate: 4.00 KByte/s</span><br><span class="line">  Real Time Query:    ON		# 实时查询为on</span><br><span class="line">  Instance(s):</span><br><span class="line">    sdcdb</span><br><span class="line"></span><br><span class="line">Database Status:</span><br><span class="line">SUCCESS</span><br></pre></td></tr></table></figure></p>
<h2 id="5-添加farsync"><a href="#5-添加farsync" class="headerlink" title="5. 添加farsync"></a>5. 添加farsync</h2><h3 id="5-1-添加farsync监听"><a href="#5-1-添加farsync监听" class="headerlink" title="5.1 添加farsync监听"></a>5.1 添加farsync监听</h3><ul>
<li>主库farsync监听</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = sdfsdb01 )(PORT = 1521))</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">SID_LIST_LISTENER=</span><br><span class="line">        (SID_LIST=</span><br><span class="line">                (SID_DESC=</span><br><span class="line">                        (SID_NAME=sdfs01)</span><br><span class="line">                        (ORACLE_HOME=/u01/app/oracle/product/12.1.0)</span><br><span class="line">                        (GLOBAL_DBNAME=sdfs01)</span><br><span class="line">                )</span><br><span class="line">                (SID_DESC=</span><br><span class="line">                        (SID_NAME=sdfs01)</span><br><span class="line">                        (ORACLE_HOME=/u01/app/oracle/product/12.1.0)</span><br><span class="line">                        (GLOBAL_DBNAME=sdfs01_DGMGRL)</span><br><span class="line">                )</span><br><span class="line">                (SID_DESC=</span><br><span class="line">                        (SID_NAME=sdfs01)</span><br><span class="line">                        (ORACLE_HOME=/u01/app/oracle/product/12.1.0)</span><br><span class="line">                        (GLOBAL_DBNAME=sdfs01_DGB)</span><br><span class="line">                )</span><br><span class="line">        )</span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br><span class="line">ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON</span><br><span class="line">VALID_NODE_CHECKING_REGISTRATION_LISTENER=SUBNET</span><br></pre></td></tr></table></figure>
<ul>
<li>备库farsync监听</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">LISTENER =</span><br><span class="line">  (DESCRIPTION_LIST =</span><br><span class="line">    (DESCRIPTION =</span><br><span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = stfsdb01 )(PORT = 1521))</span><br><span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">SID_LIST_LISTENER=</span><br><span class="line">        (SID_LIST=</span><br><span class="line">                (SID_DESC=</span><br><span class="line">                        (SID_NAME=stfs01)</span><br><span class="line">                        (ORACLE_HOME=/u01/app/oracle/product/12.1.0)</span><br><span class="line">                        (GLOBAL_DBNAME=stfs01)</span><br><span class="line">                )</span><br><span class="line">                (SID_DESC=</span><br><span class="line">                        (SID_NAME=stfs01)</span><br><span class="line">                        (ORACLE_HOME=/u01/app/oracle/product/12.1.0)</span><br><span class="line">                        (GLOBAL_DBNAME=stfs01_DGMGRL)</span><br><span class="line">                )</span><br><span class="line">                (SID_DESC=</span><br><span class="line">                        (SID_NAME=stfs01)</span><br><span class="line">                        (ORACLE_HOME=/u01/app/oracle/product/12.1.0)</span><br><span class="line">                        (GLOBAL_DBNAME=stfs01_DGB)</span><br><span class="line">                )</span><br><span class="line">        )</span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br><span class="line">ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON</span><br><span class="line">VALID_NODE_CHECKING_REGISTRATION_LISTENER=SUBNET</span><br></pre></td></tr></table></figure>
<h3 id="5-2-主库创建farsync所需文件"><a href="#5-2-主库创建farsync所需文件" class="headerlink" title="5.2 主库创建farsync所需文件"></a>5.2 主库创建farsync所需文件</h3><p><strong>两个farsync同时执行以下操作</strong></p>
<ul>
<li>主库创建farsync控制文件，传输到两个farsync节点，并且修改成相应的名字</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FAR</span> <span class="hljs-keyword">SYNC</span> <span class="hljs-keyword">INSTANCE</span> <span class="hljs-keyword">CONTROLFILE</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">'/home/oracle/controlsdfs01.ctl'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>主库创建farsync实例所需pfile，且修改相关参数</li>
</ul>
<p>以主库farsync实例为例, broker管理farsync仍然不需要<code>log_archive_dest_2/3</code>参数:<br><figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">*.archive_lag_target=1800</span><br><span class="line">*.audit_file_dest='/u01/app/oracle/admin/sdcdb/adump'</span><br><span class="line">*.audit_trail='db'</span><br><span class="line">*.compatible='12.1.0.2.0'</span><br><span class="line">*.control_files='/u01/oradata/sdcdb/control01.ctl','/u01/app/oracle/fast_recovery_area/sdcdb/control02.ctl'</span><br><span class="line">*.db_block_size=8192</span><br><span class="line">*.db_create_file_dest='/u01/oradata'</span><br><span class="line">*.db_create_online_log_dest_1='/u01/oradata'</span><br><span class="line">*.db_domain=''</span><br><span class="line">*.db_name='sdcdb'</span><br><span class="line">*.db_unique_name='sdfs01'              #新增加参数</span><br><span class="line">*.db_recovery_file_dest_size=21474836480</span><br><span class="line">*.db_recovery_file_dest='/u01/app/oracle'</span><br><span class="line">*.dg_broker_start=TRUE</span><br><span class="line">*.diagnostic_dest='/u01/app/oracle'</span><br><span class="line">*.dispatchers='(PROTOCOL=TCP) (SERVICE=sdcdbXDB)'</span><br><span class="line">*.enable_pluggable_database=true</span><br><span class="line">*.log_archive_format='%t_%s_%r.dbf'</span><br><span class="line">*.log_archive_max_processes=4</span><br><span class="line">*.log_archive_min_succeed_dest=1</span><br><span class="line">*.open_cursors=300</span><br><span class="line">*.pga_aggregate_target=4096m</span><br><span class="line">*.processes=300</span><br><span class="line">*.remote_login_passwordfile='EXCLUSIVE'</span><br><span class="line">*.sga_target=12288m</span><br><span class="line">*.standby_file_management='AUTO'</span><br><span class="line">*.undo_tablespace='UNDOTBS1'</span><br></pre></td></tr></table></figure></p>
<p>两个farsync实例创建spfile:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">create</span> <span class="hljs-keyword">spfile</span> <span class="hljs-keyword">from</span> pfile=<span class="hljs-string">'/home/oracle/pfile_farsync.ora'</span>;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>主库传输密码文件到两个farsync节点</p>
</li>
<li><p>Farsync节点创建相关目录</p>
</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /u01/oradata/sdcdb/pdbseed</span><br><span class="line">mkdir -p /u01/oradata/sdcdb/sdpdb1</span><br><span class="line">mkdir -p /u01/oradata/SDCDB</span><br><span class="line">mkdir -p /u01/app/oracle/sdcdb</span><br><span class="line">mkdir -p /u01/app/oracle/fast_recovery_area/sdcdb</span><br><span class="line">mkdir -p /u01/app/oracle/admin/sdcdb/adump</span><br></pre></td></tr></table></figure>
<ul>
<li>mount farsync实例</li>
</ul>
<figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; startup mount pfile='/home/oracle/pfile_farsync.ora';</span><br></pre></td></tr></table></figure>
<h3 id="5-3-Broker添加farsync实例"><a href="#5-3-Broker添加farsync实例" class="headerlink" title="5.3 Broker添加farsync实例"></a>5.3 Broker添加farsync实例</h3><p>主库执行:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dgmgrl sys/manager</span><br><span class="line">add FAR_SYNC sdfs01 as connect identifier is sdfs01;</span><br><span class="line">add FAR_SYNC stfs01 as connect identifier is stfs01;</span><br><span class="line"><span class="hljs-comment">--主库指定redo路由</span></span><br><span class="line">edit database sdcdb <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">'(LOCAL : sdfs01 SYNC)'</span>;</span><br><span class="line"><span class="hljs-comment">--主库farsyn指定redo路由</span></span><br><span class="line">edit far_sync sdfs01 <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">'(sdcdb : stcdb ASYNC)'</span>;</span><br><span class="line"><span class="hljs-comment">--备库指定redo路由</span></span><br><span class="line">edit database stcdb <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">'(LOCAL : stfs01 SYNC)'</span>;</span><br><span class="line"><span class="hljs-comment">--备库farsync指定redo路由</span></span><br><span class="line">edit far_sync stfs01 <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">'(stcdb : sdcdb ASYNC)'</span>;</span><br></pre></td></tr></table></figure></p>
<p>按照本文图中的架构，如果主库有两个farsync，其中一个为备用fasync，可参照以下设定：<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--optional,如果主库有两个farsync(12.1.0.2)</span></span><br><span class="line">EDIT DATABASE sdcdb <span class="hljs-keyword">SET</span> PROPERTY RedoRoutes = <span class="hljs-string">'(LOCAL : sdfs01 SYNC ALT=(sdfs02 ASYNC FALLBACK))'</span>;</span><br><span class="line"><span class="hljs-comment">--12.2设定priority</span></span><br><span class="line">EDIT DATABASE sdcdb <span class="hljs-keyword">SET</span> PROPERTY RedoRoutes = <span class="hljs-string">'(LOCAL : ( sdfs01 SYNC PRIORITY=1, sdfs02 ASYNC PRIORITY=2 ) )'</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-4-修改同步模式及保护级别"><a href="#5-4-修改同步模式及保护级别" class="headerlink" title="5.4 修改同步模式及保护级别"></a>5.4 修改同步模式及保护级别</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EDIT far_sync sdfs01 <span class="hljs-keyword">SET</span> PROPERTY LogXptMode=<span class="hljs-string">'SYNC'</span>;</span><br><span class="line">EDIT far_sync stfs01 <span class="hljs-keyword">SET</span> PROPERTY LogXptMode=<span class="hljs-string">'SYNC'</span>;</span><br><span class="line">edit database sdcdb <span class="hljs-keyword">set</span> property LogXptMode=<span class="hljs-string">'SYNC'</span>;</span><br><span class="line">edit database stcdb <span class="hljs-keyword">set</span> property LogXptMode=<span class="hljs-string">'SYNC'</span>;</span><br><span class="line">EDIT CONFIGURATION <span class="hljs-keyword">SET</span> <span class="hljs-keyword">PROTECTION</span> <span class="hljs-keyword">MODE</span> <span class="hljs-keyword">AS</span> MAXAVAILABILITY;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-启用配置并且检查结果"><a href="#5-5-启用配置并且检查结果" class="headerlink" title="5.5 启用配置并且检查结果"></a>5.5 启用配置并且检查结果</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">enable configuration</span><br><span class="line"><span class="hljs-keyword">show</span> <span class="hljs-keyword">database</span> verbose sdcdb statusreport</span><br><span class="line"><span class="hljs-keyword">show</span> configuration [verbose]</span><br><span class="line"><span class="hljs-keyword">show</span> far_sync verbose sdfs01 [statusreport]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DGMGRL&gt; <span class="hljs-keyword">show</span> configuration</span><br><span class="line"></span><br><span class="line">Configuration - sd_adg</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">Protection</span> <span class="hljs-keyword">Mode</span>: MaxAvailability</span><br><span class="line">  Members:</span><br><span class="line">  sdcdb  - Primary <span class="hljs-keyword">database</span></span><br><span class="line">    sdfs01 - <span class="hljs-keyword">Far</span> <span class="hljs-keyword">sync</span> <span class="hljs-keyword">instance</span></span><br><span class="line">      stcdb  - <span class="hljs-keyword">Physical</span> <span class="hljs-keyword">standby</span> <span class="hljs-keyword">database</span></span><br><span class="line"></span><br><span class="line">  Members <span class="hljs-keyword">Not</span> Receiving <span class="hljs-keyword">Redo</span>:</span><br><span class="line">  stfs01 - <span class="hljs-keyword">Far</span> <span class="hljs-keyword">sync</span> <span class="hljs-keyword">instance</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Fast</span>-<span class="hljs-keyword">Start</span> <span class="hljs-keyword">Failover</span>: DISABLED</span><br><span class="line"></span><br><span class="line">Configuration <span class="hljs-keyword">Status</span>:</span><br><span class="line"><span class="hljs-keyword">SUCCESS</span>   (<span class="hljs-keyword">status</span> <span class="hljs-keyword">updated</span> <span class="hljs-number">28</span> seconds ago)</span><br></pre></td></tr></table></figure>
<p>同时也可以查看备库切换后的配置信息:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; show configuration when primary is stcdb</span><br><span class="line"></span><br><span class="line">Configuration when stcdb is primary - sd_adg</span><br><span class="line"></span><br><span class="line">  Members:</span><br><span class="line">  stcdb  - Primary database</span><br><span class="line">    stfs01 - Far sync instance</span><br><span class="line">      sdcdb  - Physical standby database</span><br><span class="line"></span><br><span class="line">  Members Not Receiving Redo:</span><br><span class="line">  sdfs01 - Far sync instance</span><br></pre></td></tr></table></figure></p>
<p>查询主备库归档情况:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--主库</span></span><br><span class="line">SQL&gt; col DESTINATION for a30</span><br><span class="line">col DEST_NAME for a50</span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span> pagesize <span class="hljs-number">200</span></span><br><span class="line"><span class="hljs-keyword">SELECT</span> DEST_NAME,<span class="hljs-keyword">STATUS</span>,DESTINATION,TRANSMIT_MODE <span class="hljs-keyword">FROM</span> V$ARCHIVE_DEST <span class="hljs-keyword">WHERE</span> DESTINATION <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">DEST_NAME					   STATUS	      DESTINATION		     TRANSMIT_MODE</span><br><span class="line"><span class="hljs-comment">-------------------------------------------------- ------------------ ------------------------------ ------------------------</span></span><br><span class="line">LOG_ARCHIVE_DEST_1				   VALID	      USE_DB_RECOVERY_FILE_DEST      SYNCHRONOUS</span><br><span class="line">LOG_ARCHIVE_DEST_2				   VALID	      sdfs01			     PARALLELSYNC</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">--far sync</span></span><br><span class="line">SQL&gt; col DESTINATION for a30</span><br><span class="line">col DEST_NAME for a50</span><br><span class="line"><span class="hljs-keyword">set</span> line <span class="hljs-number">200</span> pagesize <span class="hljs-number">200</span></span><br><span class="line"><span class="hljs-keyword">SELECT</span> DEST_NAME,<span class="hljs-keyword">STATUS</span>,DESTINATION,TRANSMIT_MODE <span class="hljs-keyword">FROM</span> V$ARCHIVE_DEST <span class="hljs-keyword">WHERE</span> DESTINATION <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">SQL&gt; SQL&gt; SQL&gt;</span><br><span class="line">DEST_NAME					   STATUS	      DESTINATION		     TRANSMIT_MODE</span><br><span class="line"><span class="hljs-comment">-------------------------------------------------- ------------------ ------------------------------ ------------------------</span></span><br><span class="line">LOG_ARCHIVE_DEST_1				   VALID	      USE_DB_RECOVERY_FILE_DEST      SYNCHRONOUS</span><br><span class="line">LOG_ARCHIVE_DEST_2				   VALID	      stcdb			     ASYNCHRONOUS</span><br><span class="line">STANDBY_ARCHIVE_DEST				   VALID	      USE_DB_RECOVERY_FILE_DEST      SYNCHRONOUS</span><br></pre></td></tr></table></figure></p>
<h2 id="6-主备库角色切换"><a href="#6-主备库角色切换" class="headerlink" title="6. 主备库角色切换"></a>6. 主备库角色切换</h2><h3 id="6-1-validate-database"><a href="#6-1-validate-database" class="headerlink" title="6.1 validate database"></a>6.1 validate database</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validate database sdcdb</span><br><span class="line">validate database stcdb</span><br><span class="line">validate far_sync sdfs01</span><br><span class="line">validate far_sync stfs01</span><br></pre></td></tr></table></figure>
<h3 id="6-2-switchover-to-standby"><a href="#6-2-switchover-to-standby" class="headerlink" title="6.2 switchover to standby"></a>6.2 switchover to standby</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; switchover to stcdb</span><br><span class="line">Performing switchover NOW, please wait...</span><br><span class="line">Operation requires a connection to instance "sdcdb" on database "stcdb"</span><br><span class="line">Connecting to instance "sdcdb"...</span><br><span class="line">Connected as SYSDBA.</span><br><span class="line">New primary database "stcdb" is opening...</span><br><span class="line">Operation requires <span class="hljs-keyword">start</span> up <span class="hljs-keyword">of</span> <span class="hljs-keyword">instance</span> <span class="hljs-string">"sdcdb"</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">database</span> <span class="hljs-string">"sdcdb"</span></span><br><span class="line"><span class="hljs-keyword">Starting</span> <span class="hljs-keyword">instance</span> <span class="hljs-string">"sdcdb"</span>...</span><br><span class="line"><span class="hljs-keyword">ORACLE</span> <span class="hljs-keyword">instance</span> started.</span><br><span class="line"><span class="hljs-keyword">Database</span> mounted.</span><br><span class="line"><span class="hljs-keyword">Database</span> opened.</span><br><span class="line"><span class="hljs-keyword">Switchover</span> succeeded, <span class="hljs-keyword">new</span> primary <span class="hljs-keyword">is</span> <span class="hljs-string">"stcdb"</span></span><br></pre></td></tr></table></figure>
<p>切换完成后查看状态:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; show configuration</span><br><span class="line"></span><br><span class="line">Configuration - sd_adg</span><br><span class="line"></span><br><span class="line">  Protection Mode: MaxAvailability</span><br><span class="line">  Members:</span><br><span class="line">  stcdb  - Primary database</span><br><span class="line">    stfs01 - Far sync instance</span><br><span class="line">      sdcdb  - Physical standby database</span><br><span class="line"></span><br><span class="line">  Members Not Receiving Redo:</span><br><span class="line">  sdfs01 - Far sync instance</span><br><span class="line"></span><br><span class="line">Fast-<span class="hljs-keyword">Start</span> <span class="hljs-keyword">Failover</span>: DISABLED</span><br><span class="line"></span><br><span class="line">Configuration <span class="hljs-keyword">Status</span>:</span><br><span class="line"><span class="hljs-keyword">SUCCESS</span>   (<span class="hljs-keyword">status</span> <span class="hljs-keyword">updated</span> <span class="hljs-number">9</span> seconds ago)</span><br></pre></td></tr></table></figure></p>
<h2 id="7-Failover测试"><a href="#7-Failover测试" class="headerlink" title="7. Failover测试"></a>7. Failover测试</h2><h2 id="7-1-故障切换"><a href="#7-1-故障切换" class="headerlink" title="7.1 故障切换"></a>7.1 故障切换</h2><p>当前主库为stcdb,切换到sdcdb<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; failover to sdcdb</span><br><span class="line">Performing failover NOW, please wait...</span><br><span class="line">Failover succeeded, new primary is "sdcdb"</span><br></pre></td></tr></table></figure></p>
<p>切换后的状态:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; show configuration</span><br><span class="line"></span><br><span class="line">Configuration - sd_adg</span><br><span class="line"></span><br><span class="line">  Protection Mode: MaxAvailability</span><br><span class="line">  Members:</span><br><span class="line">  sdcdb  - Primary database</span><br><span class="line">    sdfs01 - Far sync instance</span><br><span class="line">      stcdb  - Physical standby database (disabled)</span><br><span class="line">        ORA-16661: the standby database needs to be reinstated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Members Not Receiving Redo:</span><br><span class="line">  stfs01 - Far sync instance</span><br><span class="line"></span><br><span class="line">Fast-<span class="hljs-keyword">Start</span> <span class="hljs-keyword">Failover</span>: DISABLED</span><br><span class="line"></span><br><span class="line">Configuration <span class="hljs-keyword">Status</span>:</span><br><span class="line"><span class="hljs-keyword">SUCCESS</span>   (<span class="hljs-keyword">status</span> <span class="hljs-keyword">updated</span> <span class="hljs-number">89</span> seconds ago)</span><br><span class="line"></span><br><span class="line">DGMGRL&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">database</span> stcdb</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Database</span> - stcdb</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">Role</span>:               <span class="hljs-keyword">PHYSICAL</span> <span class="hljs-keyword">STANDBY</span></span><br><span class="line">  Intended State:     <span class="hljs-keyword">APPLY</span>-<span class="hljs-keyword">ON</span></span><br><span class="line">  Transport Lag:      (<span class="hljs-keyword">unknown</span>)</span><br><span class="line">  <span class="hljs-keyword">Apply</span> Lag:          (<span class="hljs-keyword">unknown</span>)</span><br><span class="line">  Average <span class="hljs-keyword">Apply</span> Rate: (<span class="hljs-keyword">unknown</span>)</span><br><span class="line">  <span class="hljs-built_in">Real</span> <span class="hljs-keyword">Time</span> <span class="hljs-keyword">Query</span>:    <span class="hljs-keyword">OFF</span></span><br><span class="line">  <span class="hljs-keyword">Instance</span>(s):</span><br><span class="line">    sdcdb</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Database</span> <span class="hljs-keyword">Status</span>:</span><br><span class="line">ORA<span class="hljs-number">-16661</span>: the <span class="hljs-keyword">standby</span> <span class="hljs-keyword">database</span> needs <span class="hljs-keyword">to</span> be reinstated</span><br><span class="line"></span><br><span class="line">DGMGRL&gt; <span class="hljs-keyword">show</span> <span class="hljs-keyword">database</span> sdcdb</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Database</span> - sdcdb</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">Role</span>:               PRIMARY</span><br><span class="line">  Intended State:     TRANSPORT-<span class="hljs-keyword">ON</span></span><br><span class="line">  <span class="hljs-keyword">Instance</span>(s):</span><br><span class="line">    sdcdb</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">Database</span> <span class="hljs-keyword">Warning</span>(s):</span><br><span class="line">    ORA<span class="hljs-number">-16629</span>: <span class="hljs-keyword">database</span> reports a different <span class="hljs-keyword">protection</span> <span class="hljs-keyword">level</span> <span class="hljs-keyword">from</span> the <span class="hljs-keyword">protection</span> <span class="hljs-keyword">mode</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">Database</span> <span class="hljs-keyword">Status</span>:</span><br><span class="line"><span class="hljs-keyword">WARNING</span></span><br></pre></td></tr></table></figure></p>
<h2 id="7-2-故障切换后的ADG还原"><a href="#7-2-故障切换后的ADG还原" class="headerlink" title="7.2 故障切换后的ADG还原"></a>7.2 故障切换后的ADG还原</h2><ul>
<li>重启旧primary(stcdb)到mount状态</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">startup mount</span><br><span class="line">dgmgrl sys/manager</span><br><span class="line">reinstate database stcdb</span><br></pre></td></tr></table></figure>
<p><strong>如果原来数据库没有开启<code>flashback</code>功能，则failover之后需要重建standby</strong>:<br><figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; reinstate database stcdb</span><br><span class="line">ORA-16795: the standby database needs to be re-created</span><br><span class="line"></span><br><span class="line">Configuration details cannot be determined by DGMGRL</span><br><span class="line">DGMGRL&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="7-3-重建standby"><a href="#7-3-重建standby" class="headerlink" title="7.3 重建standby"></a>7.3 重建standby</h2><p>Failover后broker中重新保存着主备库信息，因此需要先移除再重建。<br>由于数据库当前保护模式及redorouter的关系，移除standby过程出现以下错误:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL&gt; REMOVE DATABASE stcdb</span><br><span class="line">Error: ORA-16691: cannot remove a configuration member that is specified in a RedoRoutes property</span><br></pre></td></tr></table></figure></p>
<p>解决方式：<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">edit database sdcdb <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">''</span>;</span><br><span class="line">edit far_sync sdfs01 <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">''</span>;</span><br><span class="line">edit database stcdb <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">''</span>;</span><br><span class="line">edit far_sync stfs01 <span class="hljs-keyword">set</span> property redoroutes=<span class="hljs-string">''</span>;</span><br><span class="line">EDIT CONFIGURATION <span class="hljs-keyword">SET</span> <span class="hljs-keyword">PROTECTION</span> <span class="hljs-keyword">MODE</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">'MaxPerformance'</span>;</span><br></pre></td></tr></table></figure></p>
<p>之后再重建.</p>
<h2 id="8-错误排查"><a href="#8-错误排查" class="headerlink" title="8. 错误排查"></a>8. 错误排查</h2><h3 id="8-1-Far-sync-standby-redo-log-issue"><a href="#8-1-Far-sync-standby-redo-log-issue" class="headerlink" title="8.1 Far sync standby redo log issue"></a>8.1 Far sync standby redo log issue</h3><p>show far_sync出现以下错误</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Far Sync Instance Warnings(s):</span><br><span class="line"> ORA-16857: standby disconnected from redo source for longer than specified threshold</span><br><span class="line"> ORA-16789: standby redo logs configured incorrectly</span><br></pre></td></tr></table></figure>
<p>检查farsync实例日志：<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Errors in file /u01/app/oracle/diag/rdbms/sdfs01/sdcdb/trace/sdcdb_rsm0_22604.trc:</span><br><span class="line">ORA-00313: open failed for members of log group 4 of thread 0</span><br><span class="line">ORA-00312: online log 4 thread 0: '/u01/oradata/SDCDB/onlinelog/o1_mf_4_gp9tllq3_.log'</span><br><span class="line">ORA-27037: unable to obtain file status</span><br><span class="line">Linux-x86_64 Error: 2: No such file or directory</span><br><span class="line">Additional information: 3</span><br></pre></td></tr></table></figure></p>
<p><strong>解决方法：</strong><br>Farsync实例重新添加standby log:<br><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select group# from v$standby_log;</span><br><span class="line"></span><br><span class="line">    GROUP#</span><br><span class="line"><span class="hljs-comment">----------</span></span><br><span class="line">	 4</span><br><span class="line">	 5</span><br><span class="line">	 6</span><br><span class="line">	 7</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">clear</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">4</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">clear</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">5</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">clear</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">6</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">clear</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">4</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">5</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">6</span>;</span><br><span class="line"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">drop</span> <span class="hljs-keyword">logfile</span> <span class="hljs-keyword">group</span> <span class="hljs-number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br><span class="line"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">STANDBY</span> <span class="hljs-keyword">LOGFILE</span> <span class="hljs-keyword">SIZE</span> <span class="hljs-number">2048</span>M;</span><br></pre></td></tr></table></figure></p>
<h2 id="8-2-ORA-16629"><a href="#8-2-ORA-16629" class="headerlink" title="8.2 ORA-16629"></a>8.2 ORA-16629</h2><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: ORA-16629: database reports a different protection level from the protection mode</span><br></pre></td></tr></table></figure>
<p>主备库切换完成后提示以上错误，一般这种原因是由于配置中的保护模式与数据库中的保护模式不一致导致的.</p>
<ul>
<li>如果不介意保护模式降低，可以修改为最大性能模式</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EDIT CONFIGURATION <span class="hljs-keyword">SET</span> <span class="hljs-keyword">PROTECTION</span> <span class="hljs-keyword">MODE</span> <span class="hljs-keyword">AS</span> <span class="hljs-string">'MaxPerformance'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>或者，修改切换后的主库的日志模式</li>
</ul>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edit database stcdb <span class="hljs-keyword">set</span> property LogXptMode=<span class="hljs-string">'SYNC'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>或者，重新re-enable configuration</li>
</ul>
<p>在数据库配置正确下，出现这种错误，极可能是切换后日志传输进程被deffer掉了.重新re-enable下：</p>
<figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">--查询状态, 如果protection_level为`RESYNCHRONIZATION`,则重新re-enable</span></span><br><span class="line"><span class="hljs-keyword">select</span> database_role,protection_mode,protection_level <span class="hljs-keyword">from</span> v$<span class="hljs-keyword">database</span>;</span><br><span class="line">disable configuration</span><br><span class="line">enable configuration</span><br></pre></td></tr></table></figure>
<p>Reference:<br><a href="https://www.oracle.com/technetwork/cn/database/availability/farsync-2267608-zhs.pdf" target="_blank" rel="noopener">Oracle Active Data Guard 远程同步任意距离的零数据丢失保护</a><br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_adf.ctrl-state=7wsv4rt6w_4&amp;id=2179719.1&amp;_afrLoop=537365316317898" target="_blank" rel="noopener">Data Guard 12C 新特性：Far Sync Standby (Doc ID 2179719.1)</a><br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_adf.ctrl-state=uk3wj4zhg_57&amp;id=2179701.1&amp;_afrLoop=39455409197626" target="_blank" rel="noopener">12c 的 Cascaded Standby 数据库 (Doc ID 2179701.1)</a><br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_adf.ctrl-state=hhfr07gj3_4&amp;id=2440140.1&amp;_afrLoop=431028118858464" target="_blank" rel="noopener">使用DGMGRL(Dataguard Broker 命令行)执行12c Dataguard Swithover的最佳实践 (Doc ID 2440140.1)</a><br><a href="https://docs.oracle.com/database/121/DGBKR/cli.htm#DGBKR495" target="_blank" rel="noopener">Scenarios Using the DGMGRL Command-Line Interface</a></p>
<p><strong>EOF</strong></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/broker/">#broker</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/dataguard/">#dataguard</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/how-to/">#how to</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/restore-standby-service-by-rman-incremental-backup.html">利用rman增量备份恢复adg gap</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/dbbp-bundle-patch-installed-in-the-cdb-but-not-in-the-pdb.html">dbbp bundle patch installed in the cdb but not in the pdb</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy;  <a href="/">Kyun Kong&nbsp;</a>
                2013 - 2019
            </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>
-->

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>