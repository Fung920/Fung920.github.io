<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>ASM utilities - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="ASM Utilities,kfed,kfod,AMDU">



<meta name="keywords" content="ASM">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            ASM utilities
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2015-06-24T03:19:54.000Z" itemprop="datePublished">Jun 24 2015</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>Oracle自带的ASM类似OS级别的LVM，由于Oracle本身对其进行了封装，在一定程度上来讲，对维护人员就提高了要求。Oracle提供了一系列的工具能对ASM磁盘进行管理。<br><a id="more"></a></p>
<h3 id="1-ASMCMD"><a href="#1-ASMCMD" class="headerlink" title="1. ASMCMD"></a>1. ASMCMD</h3><p>ASM由Oracle进行封装，在OS级别，我们无法访问ASM磁盘组，Oracle提供了<code>asmcmd</code>这个工具，它包含了部分类似OS级别的操作，如ls，du，cp(11g)等。在11g里面，这个工具比之前版本增强了很多。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--查找磁盘组信息，包括没有被mount的磁盘组</span><br><span class="line">[grid@orl6:/home/grid]$ crsctl stat res -t</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">NAME           TARGET  STATE        SERVER                   STATE_DETAILS       </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Resources</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ora.DATA.dg</span><br><span class="line">               OFFLINE OFFLINE      orl6                                         </span><br><span class="line">ora.DATA1.dg</span><br><span class="line">               ONLINE  ONLINE       orl6                                         </span><br><span class="line">[grid@orl6:/home/grid]$ asmcmd lsdg -g  --discovery </span><br><span class="line">Inst_ID  State       Type    Rebal  Sector  Block       AU  Total_MB  Free_MB  Req_mir_free_MB  Usable_file_MB  Offline_disks  Voting_files  Name</span><br><span class="line">      1  DISMOUNTED          N           0   4096        0         0        0                0               0              0             N  DATA/</span><br><span class="line">      1  MOUNTED     EXTERN  N         512   4096  1048576     20480    16970                0           16970              0             N  DATA1/</span><br><span class="line">--检测ASM磁盘状态,仅被mount的磁盘能被检测</span><br><span class="line">[grid@orl6:/home/grid]$ asmcmd lsdsk -k -g</span><br><span class="line">Inst_ID  Total_MB  Free_MB  OS_MB  Name        Failgroup   Failgroup_Type  Library  Label  UDID  Product  Redund   Path</span><br><span class="line">      1     20480    16970  20480  DATA1_0000  DATA1_0000  REGULAR         System                         UNKNOWN  /dev/asmdisk1</span><br><span class="line">--检测候选磁盘状态</span><br><span class="line">[grid@orl6:/home/grid]$ asmcmd lsdsk -k -g --candidate</span><br><span class="line">Inst_ID  Total_MB  Free_MB  OS_MB  Name        Failgroup   Failgroup_Type  Library  Label  UDID  Product  Redund   Path</span><br><span class="line">      1         0        0  12288                          REGULAR         System                         UNKNOWN  /dev/asmdisk3</span><br></pre></td></tr></table></figure></p>
<p>–连接到ASM实例的客户端信息<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ asmcmd lsct</span><br><span class="line">DB_Name  Status     Software_Version  Compatible_version  Instance_Name  Disk_Group</span><br><span class="line">kyun     CONNECTED        11.2.0.4.0          11.2.0.4.0  kyun           DATA1     </span><br><span class="line">kyun     CONNECTED        11.2.0.4.0          11.2.0.4.0  kyun           DATA      </span><br><span class="line">--ASM中被打开文件句柄的文件</span><br><span class="line">[grid@orl6:/home/grid]$ asmcmd lsof</span><br><span class="line">DB_Name  Instance_Name  Path                                           </span><br><span class="line">kyun     kyun           +data/kyun/datafile/tt01.256.883261951         </span><br><span class="line">kyun     kyun           +data1/kyun/controlfile/current.256.858438947  </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/data.274.859116297        </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/demotsdata.270.858444769  </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/demotsidx.271.858444795   </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/example.264.858439059     </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/fung.267.858444647        </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/perf.268.858444681        </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/sysaux.261.858438997      </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/system.260.858438969      </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/test.269.858444735        </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/undotbs2.277.860582391    </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/undotbs3.278.860582395    </span><br><span class="line">kyun     kyun           +data1/kyun/datafile/users.265.858439071       </span><br><span class="line">kyun     kyun           +data1/kyun/onlinelog/group_1.257.858438949    </span><br><span class="line">kyun     kyun           +data1/kyun/onlinelog/group_2.258.858438955    </span><br><span class="line">kyun     kyun           +data1/kyun/onlinelog/group_3.259.858438959    </span><br><span class="line">kyun     kyun           +data1/kyun/tempfile/temp.263.858439035</span><br></pre></td></tr></table></figure></p>
<p>11G新增cp命令<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[grid@linora:/tmp]$ asmcmd find +data1/ *.dbf |xargs -i asmcmd cp &#123;&#125; /tmp</span><br><span class="line">copying +data1/kyun/arch/1_56_858438943.dbf -&gt; /tmp/1_56_858438943.dbf</span><br><span class="line">copying +data1/kyun/arch/1_57_858438943.dbf -&gt; /tmp/1_57_858438943.dbf</span><br><span class="line">copying +data1/kyun/arch/1_58_858438943.dbf -&gt; /tmp/1_58_858438943.dbf</span><br></pre></td></tr></table></figure></p>
<p>其他详细的用法请参照<code>asmcmd help</code>。</p>
<h3 id="2-KFOD"><a href="#2-KFOD" class="headerlink" title="2. KFOD"></a>2. KFOD</h3><p>Kernal Files OSM Disk, OSM表示Order and Service Management。这个工具是在OS级别Discover Disk的。具体的用法参照kfod -h。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--Discover Disks</span><br><span class="line">[grid@orl6:/home/grid]$ kfod status=TRUE asm_diskstring=&apos;/dev/asmdisk*&apos; disk=all dscvgroup=TRUE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"> Disk          Size Header    Path                                     Disk Group   User     Group   </span><br><span class="line">================================================================================</span><br><span class="line">   1:      20480 Mb MEMBER    /dev/asmdisk1                            DATA1        grid     oinstall</span><br><span class="line">   2:      15584 Mb MEMBER    /dev/asmdisk2                            DATA         grid     oinstall</span><br><span class="line">   3:      12288 Mb CANDIDATE /dev/asmdisk3                            #            grid     oinstall</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">ORACLE_SID ORACLE_HOME                                                          </span><br><span class="line">================================================================================</span><br><span class="line">      +ASM /u01/app/11gr2/grid                                                  </span><br><span class="line">[grid@orl6:/home/grid]$ kfod op=groups</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Group          Size          Free Redundancy Name           </span><br><span class="line">================================================================================</span><br><span class="line">   1:      20480 Mb      16970 Mb     EXTERN DATA1          </span><br><span class="line">   2:      15584 Mb      15431 Mb     EXTERN DATA</span><br></pre></td></tr></table></figure></p>
<h3 id="3-KFED"><a href="#3-KFED" class="headerlink" title="3. KFED"></a>3. KFED</h3><p>Kfed，全称为Kernal Files metadata EDitor。顾名思义，它是可以分析ASM磁盘头信息的，其最大的作用是能修正corrupt的ASM metadata。在11g中，这个工具随着GI的安装自动安装，但是在以前的版本中，kfed需要通过编译才能使用，如：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--Linux编译kfed工具before 11g</span><br><span class="line">cd $ORACLE_HOME/rdbms/lib</span><br><span class="line">make -f ins_rdbms.mk ikfed</span><br></pre></td></tr></table></figure></p>
<p>这个工具的使用帮助可以直接在grid用户下执行kfed即可。</p>
<h4 id="3-1-kfed-read"><a href="#3-1-kfed-read" class="headerlink" title="3.1 kfed read"></a>3.1 kfed read</h4><p>kfed read命令能读取单独一个ASM块。对于kfed read的语法如下：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kfed read [aun=ii aus=jj blkn=kk dev=]asm_disk_name</span><br></pre></td></tr></table></figure></p>
<p>其中，aun表示从哪个AU(Allocation Unit)开始读取，默认为AU0，或者是ASM磁盘最开始的地方；aus表示AU大小，默认为1048576，即1M，如果ASM diskgroup使用的不是默认的AU size，请指定此大小；blkn读取第几个块，默认为0，即AU的第一个block。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[grid@node1:/home/grid]$ kfed read aun=0 aus=1048576 blkn=0 dev=/dev/asm-diskc</span><br><span class="line">--以上命令等同于kfed read /dev/asm-diskc</span><br><span class="line">--kfbh=kernal file block header</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 aus=1048576 blkn=0 dev=/dev/asmdisk1</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01				</span><br><span class="line">			--系统endian，1为little，0为big</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD	</span><br><span class="line">			--块类型，这里表示file header，文件头</span><br><span class="line">kfbh.datfmt:                          1 ; 0x003: 0x01</span><br><span class="line">kfbh.block.blk:                       0 ; 0x004: blk=0				</span><br><span class="line">			--当前块位置</span><br><span class="line">kfbh.block.obj:              2147483648 ; 0x008: disk=0</span><br><span class="line">kfbh.check:                  3459712326 ; 0x00c: 0xce370546</span><br><span class="line">kfbh.fcn.base:                     7316 ; 0x010: 0x00001c94</span><br><span class="line">kfbh.fcn.wrap:                        0 ; 0x014: 0x00000000</span><br><span class="line">kfbh.spare1:                          0 ; 0x018: 0x00000000</span><br><span class="line">kfbh.spare2:                          0 ; 0x01c: 0x00000000</span><br><span class="line">kfdhdb.driver.provstr:         ORCLDISK ; 0x000: length=8			</span><br><span class="line">			--ORCLDISK+[ASM Disk Name]表示使用ASMLIB，只有ORCLDISK表示没有使用ASMLIB</span><br><span class="line">kfdhdb.driver.reserved[0]:            0 ; 0x008: 0x00000000</span><br><span class="line">kfdhdb.driver.reserved[1]:            0 ; 0x00c: 0x00000000</span><br><span class="line">kfdhdb.driver.reserved[2]:            0 ; 0x010: 0x00000000</span><br><span class="line">kfdhdb.driver.reserved[3]:            0 ; 0x014: 0x00000000</span><br><span class="line">kfdhdb.driver.reserved[4]:            0 ; 0x018: 0x00000000</span><br><span class="line">kfdhdb.driver.reserved[5]:            0 ; 0x01c: 0x00000000</span><br><span class="line">kfdhdb.compat:                186646528 ; 0x020: 0x0b200000</span><br><span class="line">			--打开本磁盘组所需的ASM最小版本，b2=11.2</span><br><span class="line">kfdhdb.dsknum:                        0 ; 0x024: 0x0000</span><br><span class="line">kfdhdb.grptyp:                        1 ; 0x026: KFDGTP_EXTERNAL</span><br><span class="line">			--group redundancy type</span><br><span class="line">kfdhdb.hdrsts:                        3 ; 0x027: KFDHDR_MEMBER</span><br><span class="line">			--ASM disk header status，v$asm_disk.header_status</span><br><span class="line">kfdhdb.dskname:              DATA1_0000 ; 0x028: length=10</span><br><span class="line">			--ASM disk name</span><br><span class="line">kfdhdb.grpname:                   DATA1 ; 0x048: length=5</span><br><span class="line">			--ASM disk group name</span><br><span class="line">kfdhdb.fgname:               DATA1_0000 ; 0x068: length=10</span><br><span class="line">			--ASM failure group name</span><br><span class="line">kfdhdb.capname:                         ; 0x088: length=0</span><br><span class="line">kfdhdb.crestmp.hi:             33007118 ; 0x0a8: HOUR=0xe DAYS=0x10 MNTH=0x9 YEAR=0x7de</span><br><span class="line">kfdhdb.crestmp.lo:           2136205312 ; 0x0ac: USEC=0x0 MSEC=0xfa SECS=0x35 MINS=0x1f</span><br><span class="line">kfdhdb.mntstmp.hi:             33020693 ; 0x0b0: HOUR=0x15 DAYS=0x18 MNTH=0x6 YEAR=0x7df</span><br><span class="line">kfdhdb.mntstmp.lo:            446956544 ; 0x0b4: USEC=0x0 MSEC=0x101 SECS=0x2a MINS=0x6</span><br><span class="line">			--以上为四个时间，asm磁盘加入磁盘组的日期时间和最后被mount日期的时间</span><br><span class="line">kfdhdb.secsize:                     512 ; 0x0b8: 0x0200</span><br><span class="line">kfdhdb.blksize:                    4096 ; 0x0ba: 0x1000</span><br><span class="line">			--ASM Metadata Block size，为4K</span><br><span class="line">kfdhdb.ausize:                  1048576 ; 0x0bc: 0x00100000</span><br><span class="line">			--ASM AU大小</span><br><span class="line">kfdhdb.mfact:                    113792 ; 0x0c0: 0x0001bc80</span><br><span class="line">kfdhdb.dsksize:                   20480 ; 0x0c4: 0x00005000</span><br><span class="line">			--ASM磁盘大小，此处为20G</span><br><span class="line">kfdhdb.pmcnt:                         2 ; 0x0c8: 0x00000002</span><br><span class="line">kfdhdb.fstlocn:                       1 ; 0x0cc: 0x00000001</span><br><span class="line">kfdhdb.altlocn:                       2 ; 0x0d0: 0x00000002</span><br><span class="line">kfdhdb.f1b1locn:                      2 ; 0x0d4: 0x00000002</span><br><span class="line">kfdhdb.redomirrors[0]:                0 ; 0x0d8: 0x0000</span><br><span class="line">kfdhdb.redomirrors[1]:                0 ; 0x0da: 0x0000</span><br><span class="line">kfdhdb.redomirrors[2]:                0 ; 0x0dc: 0x0000</span><br><span class="line">kfdhdb.redomirrors[3]:                0 ; 0x0de: 0x0000</span><br><span class="line">kfdhdb.dbcompat:              168820736 ; 0x0e0: 0x0a100000</span><br><span class="line">			--打开磁盘组所需的数据库实例最小版本，a1=10.1</span><br><span class="line">kfdhdb.grpstmp.hi:             33007118 ; 0x0e4: HOUR=0xe DAYS=0x10 MNTH=0x9 YEAR=0x7de</span><br><span class="line">kfdhdb.grpstmp.lo:           2136086528 ; 0x0e8: USEC=0x0 MSEC=0x86 SECS=0x35 MINS=0x1f</span><br><span class="line">			--以上两个items表示磁盘组创建时间</span><br><span class="line">kfdhdb.vfstart:                       0 ; 0x0ec: 0x00000000</span><br><span class="line">kfdhdb.vfend:                         0 ; 0x0f0: 0x00000000</span><br><span class="line">kfdhdb.spfile:                       58 ; 0x0f4: 0x0000003a</span><br><span class="line">			--ASM Spfile的AU Number，11.2以后支持，此处表示spfile存放在当前磁盘的第58AU上。</span><br><span class="line">kfdhdb.spfflg:                        1 ; 0x0f8: 0x00000001</span><br><span class="line">kfdhdb.ub4spare[0]:                   0 ; 0x0fc: 0x00000000</span><br><span class="line">kfdhdb.ub4spare[1]:                   0 ; 0x100: 0x00000000</span><br><span class="line">...</span><br><span class="line">kfdhdb.acdb.aba.seq:                  0 ; 0x1d4: 0x00000000</span><br><span class="line">kfdhdb.acdb.aba.blk:                  0 ; 0x1d8: 0x00000000</span><br><span class="line">kfdhdb.acdb.ents:                     0 ; 0x1dc: 0x0000</span><br><span class="line">kfdhdb.acdb.ub2spare:                 0 ; 0x1de: 0x0000</span><br></pre></td></tr></table></figure></p>
<p>如果需要将输出保存到一个文件中，则使用text关键字，屏幕则不会输出:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 aus=1048576 blkn=0 dev=/dev/asmdisk1 text=/tmp/kfed.txt</span><br><span class="line">[grid@orl6:/home/grid]$ more /tmp/kfed.txt </span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD</span><br><span class="line">kfbh.datfmt:                          1 ; 0x003: 0x01</span><br><span class="line">kfbh.block.blk:                       0 ; 0x004: blk=0</span><br><span class="line">kfbh.block.obj:              2147483648 ; 0x008: disk=0</span><br><span class="line">kfbh.check:                  3459712326 ; 0x00c: 0xce370546</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h4 id="3-2-kfed备份修复ASM磁盘"><a href="#3-2-kfed备份修复ASM磁盘" class="headerlink" title="3.2 kfed备份修复ASM磁盘"></a>3.2 kfed备份修复ASM磁盘</h4><p>kred中可以看出部分基本信息，比如kfbh.type为KFBTYP_DISKHEAD表示这个块是file header，kfdhdb.secsize,kfdhdb.blksize,kfdhdb.ausize分别表示sector size，block size和AU size。本例中AU大小为1M，块大小为4096，即4K。因此，每个AU最多有1m/4k = 256个块。</p>
<p>#####备份磁盘信息<br>手动备份磁盘头信息可采用kfed或者dd：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read /dev/asmdisk1 aun=0 blkn=0 text=./au1.header</span><br><span class="line">[grid@orl6:/home/grid]$ dd if=/dev/asmdisk1 of=./au1_bak.header  bs=4096 count=1</span><br></pre></td></tr></table></figure></p>
<p>模拟破坏磁盘头<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ dd if=/dev/zero of=/dev/asmdisk1  bs=4096 count=1</span><br></pre></td></tr></table></figure></p>
<p>用kfed read查看此块(au0 block 0)：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 blkn=0 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          0 ; 0x000: 0x00</span><br><span class="line">kfbh.hard:                            0 ; 0x001: 0x00</span><br><span class="line">kfbh.type:                            0 ; 0x002: KFBTYP_INVALID</span><br><span class="line">kfbh.datfmt:                          0 ; 0x003: 0x00</span><br><span class="line">kfbh.block.blk:                       0 ; 0x004: blk=0</span><br><span class="line">kfbh.block.obj:                       0 ; 0x008: file=0</span><br><span class="line">kfbh.check:                           0 ; 0x00c: 0x00000000</span><br><span class="line">kfbh.fcn.base:                        0 ; 0x010: 0x00000000</span><br><span class="line">kfbh.fcn.wrap:                        0 ; 0x014: 0x00000000</span><br><span class="line">kfbh.spare1:                          0 ; 0x018: 0x00000000</span><br><span class="line">kfbh.spare2:                          0 ; 0x01c: 0x00000000</span><br><span class="line">7F5687C67400 00000000 00000000 00000000 00000000  [................]</span><br><span class="line">  Repeat 255 times</span><br><span class="line">KFED-00322: Invalid content encountered during block traversal: [kfbtTraverseBlock][Invalid OSM block type][][0]</span><br></pre></td></tr></table></figure></p>
<p>已经报错了，同时，kfbh.type也变成了KFBTYP_INVALID。进行修复动作：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed repair /dev/asmdisk1</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 blkn=0 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD</span><br><span class="line">kfbh.datfmt:                          1 ; 0x003: 0x01</span><br><span class="line">kfbh.block.blk:                       0 ; 0x004: blk=0</span><br><span class="line">kfbh.block.obj:              2147483648 ; 0x008: disk=0</span><br><span class="line">kfbh.check:                  3459712326 ; 0x00c: 0xce370546</span><br><span class="line">kfbh.fcn.base:                     7316 ; 0x010: 0x00001c94</span><br><span class="line">kfbh.fcn.wrap:                        0 ; 0x014: 0x00000000</span><br><span class="line">kfbh.spare1:                          0 ; 0x018: 0x00000000</span><br><span class="line">kfbh.spare2:                          0 ; 0x01c: 0x00000000</span><br><span class="line">kfdhdb.driver.provstr:         ORCLDISK ; 0x000: length=8</span><br></pre></td></tr></table></figure></p>
<p>通过kfed repair，kfbh.type已经变成KFBTYP_DISKHEAD,说明此block恢复正常了。<br>采用kfed write进行修复：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ dd if=/dev/zero of=/dev/asmdisk1  bs=4096 count=1</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB) copied, 0.00122345 s, 3.3 MB/s</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 blkn=0 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          0 ; 0x000: 0x00</span><br><span class="line">kfbh.hard:                            0 ; 0x001: 0x00</span><br><span class="line">kfbh.type:                            0 ; 0x002: KFBTYP_INVALID</span><br><span class="line">[grid@orl6:/home/grid]$ kfed write aun=0 blkn=0 dev=/dev/asmdisk1 text=./au1.header chksum=yes</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 blkn=0 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD</span><br></pre></td></tr></table></figure></p>
<p>采用dd进行修复：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ dd if=./au1_bak.header  bs=4096  count=1 of=/dev/asmdisk1  bs=4096 count=1</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB) copied, 0.00149188 s, 2.7 MB/s</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 blkn=0 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，kfed repair仅能修复au0，后面的au，repair无效。请看下例：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--以AU1为例，破坏前先备份此AU数据。</span><br><span class="line">[grid@orl6:/home/grid]$ dd if=/dev/asmdisk1 of=./au1_bak  bs=4096 count=1 seek=510</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read /dev/asmdisk1 aun=1 blkn=254 text=au1.bak</span><br><span class="line">--开始破坏</span><br><span class="line">[grid@orl6:/home/grid]$ dd if=/dev/zero of=/dev/asmdisk1  bs=4096 count=1 seek=510</span><br></pre></td></tr></table></figure></p>
<p>确认此block状态<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read /dev/asmdisk1 aun=1 blkn=254 |more</span><br><span class="line">kfbh.endian:                          0 ; 0x000: 0x00</span><br><span class="line">kfbh.hard:                            0 ; 0x001: 0x00</span><br><span class="line">kfbh.type:                            0 ; 0x002: KFBTYP_INVALID</span><br></pre></td></tr></table></figure></p>
<p>尝试使用repair修复：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed repair /dev/asmdisk1 </span><br><span class="line">KFED-00320: Invalid block num1 = [0], num2 = [1], error = [endian_kfbh]</span><br></pre></td></tr></table></figure></p>
<p>尝试用dd修复：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ dd if=./au1_bak of=/dev/asmdisk1  bs=4096 count=1  seek=510</span><br></pre></td></tr></table></figure></p>
<p>查看修复结果：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read /dev/asmdisk1 aun=1 blkn=254 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD</span><br></pre></td></tr></table></figure></p>
<p>此外，还可以使用kfed write进行修复，和dd修复差不多，都要有之前的备份信息。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--备份</span><br><span class="line">kfed read /dev/asmdisk1 aun=1 blkn=254 text=./au1.text</span><br><span class="line">--破坏</span><br><span class="line">dd if=/dev/zero of=/dev/asmdisk1  bs=4096 count=1 seek=510</span><br><span class="line">--修复</span><br><span class="line">kfed write aun=1 blkn=254 dev=/dev/asmdisk1 text=./au1.text chksum=yes</span><br></pre></td></tr></table></figure></p>
<h4 id="3-3-ASM磁盘头的自动备份"><a href="#3-3-ASM磁盘头的自动备份" class="headerlink" title="3.3 ASM磁盘头的自动备份"></a>3.3 ASM磁盘头的自动备份</h4><p>对于ASM disk Header，在版本11.1.0.7以后，Oracle会自动备份一个相同的disk Header到AU1上倒数第二个块上，块的位置根据AU的大小不同而异，这个Block Number的计算可以参照以下脚本(由于ASM的默认块大小为4K，因此在1M的AU中，1024K/4K=256个block，从0开始计算，倒数第二个即为254)。在10.2.0.5版本中，ASM disk header的自动备份也已经开始存储，11gr2和10.2.0.5的备份有些许的区别，10.2.0.5中，block 0和block 254是完全一致的，包括block Number，而在11gr2中，block Number是不一致的，且Checksum值在11gr2中也是不相同的。在恢复的时候或许有点区别。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ cat asm_dsk_hdr_bk.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">echo -n &quot;Enter the value of ASM Disk:&quot;</span><br><span class="line">read ASM_DISK</span><br><span class="line">ausize=`kfed read $ASM_DISK | grep ausize | tr -s &apos; &apos; | cut -d&apos; &apos; -f2`</span><br><span class="line">blksize=`kfed read $ASM_DISK | grep blksize | tr -s &apos; &apos; | cut -d&apos; &apos; -f2`</span><br><span class="line">let n=$ausize/$blksize-2</span><br><span class="line">echo &quot;ASM Disk Header is in Block:$n&quot;</span><br></pre></td></tr></table></figure></p>
<h5 id="10-2-0-5-ASM-Disk-Header自动备份"><a href="#10-2-0-5-ASM-Disk-Header自动备份" class="headerlink" title="10.2.0.5 ASM Disk Header自动备份"></a>10.2.0.5 ASM Disk Header自动备份</h5><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[oracle@ora10g:/home/oracle/asm]$ ./asm_hdr_blk.sh </span><br><span class="line">Enter the value of ASM Disk:/dev/oracleasm/disks/DATA1</span><br><span class="line">The NO. of ASM Header Block is:254</span><br><span class="line">[oracle@ora10g:/home/oracle/asm]$ kfed read aun=1 blkn=254 dev=/dev/oracleasm/disks/DATA1 \</span><br><span class="line">text=./orig_block.txt</span><br><span class="line">[oracle@ora10g:/home/oracle/asm]$ kfed read aun=0 blkn=0 dev=/dev/oracleasm/disks/DATA1 \</span><br><span class="line">text=./orig_block.txt</span><br><span class="line">[oracle@ora10g:/home/oracle/asm]$ diff orig_block.txt bak_block.txt </span><br><span class="line">[oracle@ora10g:/home/oracle/asm]$ more bak_block.txt </span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            1 ; 0x002: KFBTYP_DISKHEAD</span><br><span class="line">kfbh.datfmt:                          1 ; 0x003: 0x01</span><br><span class="line">kfbh.block.blk:                       0 ; 0x004: T=0 NUMB=0x0--哪怕是备份的块，其块号和原始块号都是一样的</span><br><span class="line">kfbh.block.obj:              2147483648 ; 0x008: TYPE=0x8 NUMB=0x0</span><br><span class="line">kfbh.check:                   880638603 ; 0x00c: 0x347d7a8b --用于块一致性检查的校验和也相同</span><br></pre></td></tr></table></figure>
<h5 id="11gr2-ASM-Disk-Header自动备份"><a href="#11gr2-ASM-Disk-Header自动备份" class="headerlink" title="11gr2 ASM Disk Header自动备份"></a>11gr2 ASM Disk Header自动备份</h5><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read aun=0 blkn=0 dev=/dev/asmdisk1 text=./orgi_blk</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=1 blkn=254 dev=/dev/asmdisk1 text=./bak_blk</span><br><span class="line">[grid@orl6:/home/grid]$ diff orgi_blk bak_blk </span><br><span class="line">5c5</span><br><span class="line">&lt; kfbh.block.blk:                       0 ; 0x004: blk=0</span><br><span class="line">---</span><br><span class="line">&gt; kfbh.block.blk:                     254 ; 0x004: blk=254</span><br><span class="line">7c7</span><br><span class="line">&lt; kfbh.check:                  1002445176 ; 0x00c: 0x3bc01978</span><br><span class="line">---</span><br><span class="line">&gt; kfbh.check:                  1002445190 ; 0x00c: 0x3bc01986</span><br></pre></td></tr></table></figure>
<p>可以看到，在11gr2中，上述两个地方都是不相同的。因此，在AU1上的第254个Block将会是Au0，Block 0的备份，两个块的内容基本是相同的。在ASM实例上，可用以下命令检测DG的disk header备份信息是否一致,检查结果会出现在alert.log里面：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter diskgroup data1 check </span><br><span class="line">NOTE: starting check of diskgroup DATA1</span><br><span class="line">Thu Jun 25 12:22:08 2015</span><br><span class="line">GMON checking disk 0 for group 1 at 9 for pid 17, osid 22337</span><br><span class="line">SUCCESS: check of diskgroup DATA1 found no errors</span><br><span class="line">SUCCESS: alter diskgroup data1 check</span><br></pre></td></tr></table></figure></p>
<p>注意:AU1最后一个block是磁盘心跳：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read aun=1 blkn=255 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                           19 ; 0x002: KFBTYP_HBEAT</span><br><span class="line">kfbh.datfmt:                          2 ; 0x003: 0x02</span><br><span class="line">kfbh.block.blk:                     511 ; 0x004: blk=511</span><br><span class="line">kfbh.block.obj:              2147483648 ; 0x008: disk=0</span><br><span class="line">kfbh.check:                  2462310944 ; 0x00c: 0x92c3e220</span><br><span class="line">kfbh.fcn.base:                        0 ; 0x010: 0x00000000</span><br><span class="line">kfbh.fcn.wrap:                        0 ; 0x014: 0x00000000</span><br><span class="line">kfbh.spare1:                          0 ; 0x018: 0x00000000</span><br><span class="line">kfbh.spare2:                          0 ; 0x01c: 0x00000000</span><br><span class="line">kfdpHbeatB.instance:                  1 ; 0x000: 0x00000001</span><br><span class="line">kfdpHbeatB.ts.hi:              33020716 ; 0x004: HOUR=0xc DAYS=0x19 MNTH=0x6 YEAR=0x7df</span><br><span class="line">kfdpHbeatB.ts.lo:            1435727872 ; 0x008: USEC=0x0 MSEC=0xde SECS=0x19 MINS=0x15</span><br><span class="line">kfdpHbeatB.rnd[0]:            148639519 ; 0x00c: 0x08dc0f1f</span><br><span class="line">kfdpHbeatB.rnd[1]:           4128301322 ; 0x010: 0xf610e10a</span><br><span class="line">kfdpHbeatB.rnd[2]:           1569681180 ; 0x014: 0x5d8f6f1c</span><br><span class="line">kfdpHbeatB.rnd[3]:           3891741690 ; 0x018: 0xe7f743fa</span><br></pre></td></tr></table></figure></p>
<h3 id="4-AMDU–ASM-Metadata-Dump-Utility"><a href="#4-AMDU–ASM-Metadata-Dump-Utility" class="headerlink" title="4. AMDU–ASM Metadata Dump Utility"></a>4. AMDU–ASM Metadata Dump Utility</h3><p>AMDU在磁盘组无法挂载的时候，是一个很好的抽取数据攻击。磁盘组是否mounted跟amdu并没有关系，amdu可以处理dismounted状态的磁盘组。其主要功能是从ASM disk中抽取metadata。这个工具是11g以后的，10g如果要用到可以到MOS上去下载。AMDU的用法帮助可以使用<code>amdu help=y</code>查看。<br>amdu可以查看磁盘组详细的信息，如：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ amdu -diskstring &apos;/dev/asm*&apos; -dump &apos;DATA1&apos;</span><br></pre></td></tr></table></figure></p>
<p>下面模拟ASM磁盘组无法挂载的情况下抽取ASM里面相关的文件，如数据文件、控制文件，甚至参数文件。<br>在上述的条件下，我们首先要确认各种文件的file number，这些文件的file number及alias都是存储ASM中，因此，首先要确认ASM Alias在哪个AU，而指向alias 所在的AU为file directory。而在ASM AU分布中，AU0和AU1为physical metadata，ASM的File directory在AU2，block 6上，首先通过file directory找出alias所在AU。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ kfed read aun=2 blkn=6 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                            4 ; 0x002: KFBTYP_FILEDIR</span><br><span class="line">...</span><br><span class="line">kfffde[0].xptr.au:                   48 ; 0x4a0: 0x00000030</span><br><span class="line">..</span><br></pre></td></tr></table></figure></p>
<p>xptr.au即alias directory所在的au,从blkn=0开始查找，本例中：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#spfile的file number</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=48 blkn=3 dev=/dev/asmdisk1 |more</span><br><span class="line">kfade[5].name:           spfilekyun.ora ; 0x1b0: length=14		</span><br><span class="line">kfade[5].fnum:                      266 ; 0x1e0: 0x0000010a		</span><br><span class="line">#controlfile的file number</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=48 blkn=4 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                           11 ; 0x002: KFBTYP_ALIASDIR</span><br><span class="line">...</span><br><span class="line">...kfade[0].name:                  Current ; 0x034: length=7</span><br><span class="line">kfade[0].fnum:                      256 ; 0x064: 0x00000100		</span><br><span class="line">...</span><br><span class="line">#online redo log的file number</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=48 blkn=5 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                           11 ; 0x002: KFBTYP_ALIASDIR</span><br><span class="line">...</span><br><span class="line">kfade[0].name:                  group_1 ; 0x034: length=7</span><br><span class="line">kfade[0].fnum:                      257 ; 0x064: 0x00000101</span><br><span class="line">...</span><br><span class="line">kfade[1].name:                  group_2 ; 0x080: length=7</span><br><span class="line">kfade[1].fnum:                      258 ; 0x0b0: 0x00000102</span><br><span class="line">...</span><br><span class="line">kfade[2].name:                  group_3 ; 0x0cc: length=7</span><br><span class="line">kfade[2].fnum:                      259 ; 0x0fc: 0x00000103		--online redo log的file number</span><br><span class="line">...</span><br><span class="line">#Tablespace的file number</span><br><span class="line">[grid@orl6:/home/grid]$ kfed read aun=48 blkn=6 dev=/dev/asmdisk1 |more</span><br><span class="line">kfbh.endian:                          1 ; 0x000: 0x01</span><br><span class="line">kfbh.hard:                          130 ; 0x001: 0x82</span><br><span class="line">kfbh.type:                           11 ; 0x002: KFBTYP_ALIASDIR</span><br><span class="line">...</span><br><span class="line">kfade[0].name:                   SYSTEM ; 0x034: length=6</span><br><span class="line">kfade[0].fnum:                      260 ; 0x064: 0x00000104</span><br><span class="line">...</span><br><span class="line">kfade[1].name:                   SYSAUX ; 0x080: length=6</span><br><span class="line">kfade[1].fnum:                      261 ; 0x0b0: 0x00000105</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>通过kfed得到file number，然后使用amdu进行抽取即可。在实际环境中，spfile和control file的file number其实是可以通过alert日志得到相关的信息的，有了control file，即可以读取datafile，从<code>v$datafile</code>中可以获取datafile的file number。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#使用amdu抽取spfile</span><br><span class="line">[grid@orl6:/home/grid]$ amdu -diskstring=&apos;/dev/asmdisk1&apos; -extract DATA1.266 -nodir -noreport -output kyun.spfile.266</span><br><span class="line">[grid@orl6:/home/grid]$ strings kyun.spfile.266 </span><br><span class="line">kyun.__db_cache_size=364904448</span><br><span class="line">kyun.__java_pool_size=4194304</span><br><span class="line">kyun.__large_pool_size=8388608</span><br><span class="line">kyun.__oracle_base=&apos;/u01/app/oracle&apos;#ORACLE_BASE set from environment</span><br><span class="line">kyun.__pga_aggregate_target=322961408</span><br><span class="line">kyun.__sga_target=515899392</span><br><span class="line">kyun.__shared_io_pool_size=0</span><br><span class="line">kyun.__shared_pool_size=130023424</span><br><span class="line">kyun.__streams_pool_size=0</span><br><span class="line">*.audit_file_dest=&apos;/u01/app/oracle/admin/kyun/adump&apos;</span><br><span class="line">*.audit_trail=&apos;db&apos;</span><br><span class="line">*.compatible=&apos;11.2.0.4.0&apos;</span><br><span class="line">*.control_files=&apos;+DATA1/kyun/controlfile/current.256.858438947&apos;</span><br><span class="line">*.db_block_size=8192</span><br><span class="line">*.db_create_file_dest=&apos;+DATA1&apos;</span><br><span class="line">*.db_domain=&apos;&apos;</span><br><span class="line">*.db_name=&apos;kyun&apos;</span><br><span class="line">*.diagnostic_dest=&apos;/u01/app/oracle&apos;</span><br><span class="line">*.dispatchers=&apos;(PROTOCOL=TCP) (SERVICE=kyunXDB)&apos;</span><br><span class="line">*.log_archive_dest_1=&apos;location=+DATA1/kyun/arch&apos;</span><br><span class="line">*.memory_target=838860800</span><br><span class="line">*.open_cursors=300</span><br><span class="line">*.processes=150</span><br><span class="line">*.remote_login_passwordfile=&apos;EXCLUSIVE&apos;</span><br><span class="line">*.undo_tablespace=&apos;UNDOTBS1&apos;</span><br></pre></td></tr></table></figure></p>
<p>修改control_files路径，启动数据库至mount状态，查询数据文件，同样抽取出数据文件，通过rename或者重建控制文件即可把库拉起来。</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[grid@orl6:/home/grid]$ amdu -dis=&apos;/dev/asm*&apos; -extract DATA1.267 -nodir -noreport -output fung.267.dbf</span><br><span class="line">[grid@orl6:/home/grid]$ dbv</span><br><span class="line">dbv   dbvO  </span><br><span class="line">[grid@orl6:/home/grid]$ dbv file=fung.267.dbf </span><br><span class="line"></span><br><span class="line">DBVERIFY: Release 11.2.0.4.0 - Production on Thu Jun 25 13:14:43 2015</span><br><span class="line"></span><br><span class="line">Copyright (c) 1982, 2011, Oracle and/or its affiliates.  All rights reserved.</span><br><span class="line"></span><br><span class="line">DBVERIFY - Verification starting : FILE = /home/grid/fung.267.dbf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DBVERIFY - Verification complete</span><br><span class="line"></span><br><span class="line">Total Pages Examined         : 37376</span><br><span class="line">Total Pages Processed (Data) : 24705</span><br><span class="line">Total Pages Failing   (Data) : 0</span><br><span class="line">Total Pages Processed (Index): 5545</span><br><span class="line">Total Pages Failing   (Index): 0</span><br><span class="line">Total Pages Processed (Other): 771</span><br><span class="line">Total Pages Processed (Seg)  : 0</span><br><span class="line">Total Pages Failing   (Seg)  : 0</span><br><span class="line">Total Pages Empty            : 6355</span><br><span class="line">Total Pages Marked Corrupt   : 0</span><br><span class="line">Total Pages Influx           : 0</span><br><span class="line">Total Pages Encrypted        : 0</span><br><span class="line">Highest block SCN            : 748761 (0.748761)</span><br></pre></td></tr></table></figure>
<p>Reference:<br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?id=1485597.1" target="_blank" rel="noopener">ID 1485597.1</a>  </p>
<p><br><br><b>EOF</b><br><br></p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/ASM/">#ASM</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/mhvtl-and-nbu.html">MHVTL and NBU</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/multipath-with-udev.html">Multipath with udev in RHEL6</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy; 2013 - 2018
                <a href="/">Fung Kong&nbsp;
                </a>
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
    </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>