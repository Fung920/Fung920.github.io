<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>如何获得SQL的执行计划 - My Wiki</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="怎么查看SQL的执行计划">



<meta name="keywords" content="Oracle执行计划">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Wiki
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            如何获得SQL的执行计划
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2014-08-20T13:52:36.000Z" itemprop="datePublished">Aug 20 2014</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            19 minutes read (About 2823 words)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>Oracle中的执行计划显示在执行一条SQL语句时必须执行的详细步骤，通常以表格形式呈现，但其实是树形结构。查看Oracle中的执行计划一般有以下几种方法(包括但不限于)。<br><a id="more"></a></p>
<h3 id="1-explain-plan"><a href="#1-explain-plan" class="headerlink" title="1. explain plan"></a>1. explain plan</h3><p><code>explain plan</code>只显示一条SQL的执行计划，但不会真正去执行它。当使用此命令生成执行计划后，还需要调用<code>dbms_xplan</code>包去查看相关内容。在TOAD或者PL/SQL Developer查看的执行计划，其实也就是explain plan的变体，因此，有可能是不准确的执行计划。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SH@linora&gt; explain plan for </span><br><span class="line">  2  SELECT /*+ gather_plan_statistics */ --显示统计信息，相当于开启参数statistics_level=all;</span><br><span class="line">  3  p.prod_name as product, sum(s.quantity_sold) as units </span><br><span class="line">  4  FROM sales s, products p</span><br><span class="line">  5  WHERE s.prod_id =p.prod_id</span><br><span class="line">  6  GROUP BY p.prod_name;</span><br><span class="line">Explained.</span><br><span class="line">SH@linora&gt; select * from table(dbms_xplan.display());</span><br><span class="line">PLAN_TABLE_OUTPUT</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">Plan hash value: 504757596</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation               | Name     | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT        |          |    71 |  3337 |   589  (12)| 00:00:08 |       |       |</span><br><span class="line">|   1 |  HASH GROUP BY          |          |    71 |  3337 |   589  (12)| 00:00:08 |       |       |</span><br><span class="line">|*  2 |   HASH JOIN             |          |    72 |  3384 |   588  (12)| 00:00:08 |       |       |</span><br><span class="line">|   3 |    VIEW                 | VW_GBC_5 |    72 |  1224 |   585  (12)| 00:00:08 |       |       |</span><br><span class="line">|   4 |     HASH GROUP BY       |          |    72 |   504 |   585  (12)| 00:00:08 |       |       |</span><br><span class="line">|   5 |      PARTITION RANGE ALL|          |   918K|  6281K|   533   (3)| 00:00:07 |     1 |    28 |</span><br><span class="line">|   6 |       TABLE ACCESS FULL | SALES    |   918K|  6281K|   533   (3)| 00:00:07 |     1 |    28 |</span><br><span class="line">|   7 |    TABLE ACCESS FULL    | PRODUCTS |    72 |  2160 |     3   (0)| 00:00:01 |       |       |</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line">   2 - access(&quot;ITEM_1&quot;=&quot;P&quot;.&quot;PROD_ID&quot;)</span><br><span class="line">19 rows selected.</span><br></pre></td></tr></table></figure></p>
<p><code>explain plan</code>其实是将Oracle所产生的执行计划步骤写入PLAN_TABLE$，此表是一个全局临时表，因此，各个session只能看到自己执行的SQL所产生的执行计划。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; set long 9999</span><br><span class="line">SYS@linora&gt; set pagesize 9999</span><br><span class="line">SYS@linora&gt; select dbms_metadata.get_ddl(&apos;TABLE&apos;,&apos;PLAN_TABLE$&apos;,&apos;SYS&apos;) from dual;</span><br><span class="line">DBMS_METADATA.GET_DDL(&apos;TABLE&apos;,&apos;PLAN_TABLE$&apos;,&apos;SYS&apos;)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">  CREATE GLOBAL TEMPORARY TABLE &quot;SYS&quot;.&quot;PLAN_TABLE$&quot;</span><br><span class="line">   (    &quot;STATEMENT_ID&quot; VARCHAR2(30),</span><br><span class="line">        &quot;PLAN_ID&quot; NUMBER,</span><br><span class="line">        &quot;TIMESTAMP&quot; DATE,</span><br><span class="line">        &quot;REMARKS&quot; VARCHAR2(4000),</span><br><span class="line">        &quot;OPERATION&quot; VARCHAR2(30),</span><br><span class="line">        &quot;OPTIONS&quot; VARCHAR2(255),</span><br><span class="line">        &quot;OBJECT_NODE&quot; VARCHAR2(128),</span><br><span class="line">        &quot;OBJECT_OWNER&quot; VARCHAR2(30),</span><br><span class="line">        &quot;OBJECT_NAME&quot; VARCHAR2(30),</span><br><span class="line">        &quot;OBJECT_ALIAS&quot; VARCHAR2(65),</span><br><span class="line">        &quot;OBJECT_INSTANCE&quot; NUMBER(*,0),</span><br><span class="line">        &quot;OBJECT_TYPE&quot; VARCHAR2(30),</span><br><span class="line">        &quot;OPTIMIZER&quot; VARCHAR2(255),</span><br><span class="line">        &quot;SEARCH_COLUMNS&quot; NUMBER,</span><br><span class="line">        &quot;ID&quot; NUMBER(*,0),</span><br><span class="line">        &quot;PARENT_ID&quot; NUMBER(*,0),</span><br><span class="line">        &quot;DEPTH&quot; NUMBER(*,0),</span><br><span class="line">        &quot;POSITION&quot; NUMBER(*,0),</span><br><span class="line">        &quot;COST&quot; NUMBER(*,0),</span><br><span class="line">        &quot;CARDINALITY&quot; NUMBER(*,0),</span><br><span class="line">        &quot;BYTES&quot; NUMBER(*,0),</span><br><span class="line">        &quot;OTHER_TAG&quot; VARCHAR2(255),</span><br><span class="line">        &quot;PARTITION_START&quot; VARCHAR2(255),</span><br><span class="line">        &quot;PARTITION_STOP&quot; VARCHAR2(255),</span><br><span class="line">        &quot;PARTITION_ID&quot; NUMBER(*,0),</span><br><span class="line">        &quot;OTHER&quot; LONG,</span><br><span class="line">        &quot;OTHER_XML&quot; CLOB,</span><br><span class="line">        &quot;DISTRIBUTION&quot; VARCHAR2(30),</span><br><span class="line">        &quot;CPU_COST&quot; NUMBER(*,0),</span><br><span class="line">        &quot;IO_COST&quot; NUMBER(*,0),</span><br><span class="line">        &quot;TEMP_SPACE&quot; NUMBER(*,0),</span><br><span class="line">        &quot;ACCESS_PREDICATES&quot; VARCHAR2(4000),</span><br><span class="line">        &quot;FILTER_PREDICATES&quot; VARCHAR2(4000),</span><br><span class="line">        &quot;PROJECTION&quot; VARCHAR2(4000),</span><br><span class="line">        &quot;TIME&quot; NUMBER(*,0),</span><br><span class="line">        &quot;QBLOCK_NAME&quot; VARCHAR2(30)</span><br><span class="line">   ) ON COMMIT PRESERVE ROWS</span><br></pre></td></tr></table></figure></p>
<h3 id="2-dbms-xplan"><a href="#2-dbms-xplan" class="headerlink" title="2. dbms_xplan"></a>2. dbms_xplan</h3><p>dbms_xplan有好几种调用方法，以下仅列出常用的三种方法(后面两种适合数据库在10g及以上的版本)：</p>
<p><li>display–输出plan table内容</li></p>
<p><li>display_cursor–用于显示内存中的SQL执行计划</li></p>
<p><li>display_awr–输出AWR中的历史SQL执行计划</li></p>
<h4 id="2-1-DISPLAY"><a href="#2-1-DISPLAY" class="headerlink" title="2.1 DISPLAY"></a>2.1 DISPLAY</h4><p>语法：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DBMS_XPLAN.DISPLAY(</span><br><span class="line">   table_name    IN  VARCHAR2  DEFAULT &apos;PLAN_TABLE&apos;,</span><br><span class="line">   statement_id  IN  VARCHAR2  DEFAULT  NULL, </span><br><span class="line">   format        IN  VARCHAR2  DEFAULT  &apos;TYPICAL&apos;,</span><br><span class="line">   filter_preds  IN  VARCHAR2 DEFAULT NULL);</span><br></pre></td></tr></table></figure></p>
<p>不加任何参数：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; EXPLAIN PLAN FOR</span><br><span class="line">  2  SELECT * FROM emp e, dept d</span><br><span class="line">  3     WHERE e.deptno = d.deptno</span><br><span class="line">  4     AND e.ename=&apos;benoit&apos;;</span><br><span class="line">Explained.</span><br><span class="line">SCOTT@linora&gt; SET LINESIZE 130</span><br><span class="line">SCOTT@linora&gt; SET PAGESIZE 0</span><br><span class="line">SCOTT@linora&gt; SELECT * FROM table(DBMS_XPLAN.DISPLAY);</span><br><span class="line">Plan hash value: 3625962092</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|   1 |  NESTED LOOPS                |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|   2 |   NESTED LOOPS               |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL         | EMP     |     1 |    38 |     3   (0)| 00:00:01 |</span><br><span class="line">|*  4 |    INDEX UNIQUE SCAN         | PK_DEPT |     1 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|   5 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     1 |    20 |     1   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line">   3 - filter(&quot;E&quot;.&quot;ENAME&quot;=&apos;benoit&apos;)</span><br><span class="line">   4 - access(&quot;E&quot;.&quot;DEPTNO&quot;=&quot;D&quot;.&quot;DEPTNO&quot;)</span><br><span class="line">18 rows selected.</span><br></pre></td></tr></table></figure></p>
<p>添加ADVANCED参数(显示所有信息)：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt;   SELECT * FROM table(DBMS_XPLAN.DISPLAY(&apos;&apos;,&apos;&apos;,&apos;ADVANCED&apos;));</span><br><span class="line">Plan hash value: 3625962092</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|   1 |  NESTED LOOPS                |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|   2 |   NESTED LOOPS               |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL         | EMP     |     1 |    38 |     3   (0)| 00:00:01 |</span><br><span class="line">|*  4 |    INDEX UNIQUE SCAN         | PK_DEPT |     1 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|   5 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     1 |    20 |     1   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">Query Block Name / Object Alias (identified by operation id):</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">   1 - SEL$1</span><br><span class="line">   3 - SEL$1 / E@SEL$1</span><br><span class="line">   4 - SEL$1 / D@SEL$1</span><br><span class="line">   5 - SEL$1 / D@SEL$1</span><br><span class="line">Outline Data</span><br><span class="line">-------------</span><br><span class="line">  /*+</span><br><span class="line">      BEGIN_OUTLINE_DATA</span><br><span class="line">      NLJ_BATCHING(@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      USE_NL(@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      LEADING(@&quot;SEL$1&quot; &quot;E&quot;@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      INDEX(@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot; (&quot;DEPT&quot;.&quot;DEPTNO&quot;))</span><br><span class="line">      FULL(@&quot;SEL$1&quot; &quot;E&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      OUTLINE_LEAF(@&quot;SEL$1&quot;)</span><br><span class="line">      ALL_ROWS</span><br><span class="line">      DB_VERSION(&apos;11.2.0.4&apos;)</span><br><span class="line">      OPTIMIZER_FEATURES_ENABLE(&apos;11.2.0.4&apos;)</span><br><span class="line">      IGNORE_OPTIM_EMBEDDED_HINTS</span><br><span class="line">      END_OUTLINE_DATA</span><br><span class="line">  */</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line">   3 - filter(&quot;E&quot;.&quot;ENAME&quot;=&apos;benoit&apos;)</span><br><span class="line">   4 - access(&quot;E&quot;.&quot;DEPTNO&quot;=&quot;D&quot;.&quot;DEPTNO&quot;)</span><br><span class="line">Column Projection Information (identified by operation id):</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">   1 - (#keys=0) &quot;E&quot;.&quot;EMPNO&quot;[NUMBER,22], &quot;E&quot;.&quot;ENAME&quot;[VARCHAR2,10],</span><br><span class="line">       &quot;E&quot;.&quot;JOB&quot;[VARCHAR2,9], &quot;E&quot;.&quot;MGR&quot;[NUMBER,22], &quot;E&quot;.&quot;HIREDATE&quot;[DATE,7],</span><br><span class="line">       &quot;E&quot;.&quot;SAL&quot;[NUMBER,22], &quot;E&quot;.&quot;COMM&quot;[NUMBER,22], &quot;E&quot;.&quot;DEPTNO&quot;[NUMBER,22],</span><br><span class="line">       &quot;D&quot;.&quot;DEPTNO&quot;[NUMBER,22], &quot;D&quot;.&quot;DNAME&quot;[VARCHAR2,14], &quot;D&quot;.&quot;LOC&quot;[VARCHAR2,13]</span><br><span class="line">   2 - (#keys=0) &quot;E&quot;.&quot;EMPNO&quot;[NUMBER,22], &quot;E&quot;.&quot;ENAME&quot;[VARCHAR2,10],</span><br><span class="line">       &quot;E&quot;.&quot;JOB&quot;[VARCHAR2,9], &quot;E&quot;.&quot;MGR&quot;[NUMBER,22], &quot;E&quot;.&quot;HIREDATE&quot;[DATE,7],</span><br><span class="line">       &quot;E&quot;.&quot;SAL&quot;[NUMBER,22], &quot;E&quot;.&quot;COMM&quot;[NUMBER,22], &quot;E&quot;.&quot;DEPTNO&quot;[NUMBER,22],</span><br><span class="line">       &quot;D&quot;.ROWID[ROWID,10], &quot;D&quot;.&quot;DEPTNO&quot;[NUMBER,22]</span><br><span class="line">   3 - &quot;E&quot;.&quot;EMPNO&quot;[NUMBER,22], &quot;E&quot;.&quot;ENAME&quot;[VARCHAR2,10], &quot;E&quot;.&quot;JOB&quot;[VARCHAR2,9],</span><br><span class="line">       &quot;E&quot;.&quot;MGR&quot;[NUMBER,22], &quot;E&quot;.&quot;HIREDATE&quot;[DATE,7], &quot;E&quot;.&quot;SAL&quot;[NUMBER,22],</span><br><span class="line">       &quot;E&quot;.&quot;COMM&quot;[NUMBER,22], &quot;E&quot;.&quot;DEPTNO&quot;[NUMBER,22]</span><br><span class="line">   4 - &quot;D&quot;.ROWID[ROWID,10], &quot;D&quot;.&quot;DEPTNO&quot;[NUMBER,22]</span><br><span class="line">   5 - &quot;D&quot;.&quot;DNAME&quot;[VARCHAR2,14], &quot;D&quot;.&quot;LOC&quot;[VARCHAR2,13]</span><br><span class="line">61 rows selected.</span><br></pre></td></tr></table></figure></p>
<p>DISPLAY仅仅针对预估的执行计划，而不是真实的执行计划，尤其当SQL语句包含绑定变量时。</p>
<h4 id="2-2-DISPLAY-CURSOR"><a href="#2-2-DISPLAY-CURSOR" class="headerlink" title="2.2 DISPLAY_CURSOR"></a>2.2 DISPLAY_CURSOR</h4><p>语法：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DBMS_XPLAN.DISPLAY_CURSOR(</span><br><span class="line">   sql_id        IN  VARCHAR2  DEFAULT  NULL,</span><br><span class="line">   child_number  IN  NUMBER    DEFAULT  NULL, </span><br><span class="line">   format        IN  VARCHAR2  DEFAULT  &apos;TYPICAL&apos;);</span><br></pre></td></tr></table></figure></p>
<p>DISPLAY_CURSOR是显示内存中的执行计划，只要目标SQL的执行计划所在的child cursor还在shared pool中，就可以使用display_cursor来查看：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; SELECT /*+ display_cursor_example */ * FROM emp e, dept d</span><br><span class="line">  2  WHERE e.deptno = d.deptno</span><br><span class="line">  3  AND e.ename=&apos;SCOTT&apos;;</span><br><span class="line">SCOTT@linora&gt; select sql_text,sql_id,hash_value,child_number from v$sql</span><br><span class="line">  2  where sql_text like &apos;SELECT /*+ display_cursor_example */%&apos;;</span><br><span class="line">SQL_TEXT                                                     SQL_ID        HASH_VALUE CHILD_NUMBER</span><br><span class="line">------------------------------------------------------------ ------------- ---------- ------------</span><br><span class="line">SELECT /*+ display_cursor_example */ * FROM emp e, dept d WH 7p8g08wnrjn43  695783555            0</span><br><span class="line">ERE e.deptno = d.deptno AND e.ename=&apos;SCOTT&apos;</span><br></pre></td></tr></table></figure></p>
<p>查看此语句的执行计划：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; set pagesize 9999</span><br><span class="line">SCOTT@linora&gt; col PLAN_TABLE_OUTPUT for a100</span><br><span class="line">SCOTT@linora&gt; select * from table(dbms_xplan.display_cursor(&apos;7p8g08wnrjn43&apos;,&apos;0&apos;,&apos;advanced&apos;));</span><br><span class="line">PLAN_TABLE_OUTPUT</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">SQL_ID  7p8g08wnrjn43, child number 0</span><br><span class="line">-------------------------------------</span><br><span class="line">SELECT /*+ display_cursor_example */ * FROM emp e, dept d WHERE</span><br><span class="line">e.deptno = d.deptno AND e.ename=&apos;SCOTT&apos;</span><br><span class="line"></span><br><span class="line">Plan hash value: 3625962092</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |       |       |     4 (100)|          |</span><br><span class="line">|   1 |  NESTED LOOPS                |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|   2 |   NESTED LOOPS               |         |     1 |    58 |     4   (0)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL         | EMP     |     1 |    38 |     3   (0)| 00:00:01 |</span><br><span class="line">|*  4 |    INDEX UNIQUE SCAN         | PK_DEPT |     1 |       |     0   (0)|          |</span><br><span class="line">|   5 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     1 |    20 |     1   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">Query Block Name / Object Alias (identified by operation id):</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">   1 - SEL$1</span><br><span class="line">   3 - SEL$1 / E@SEL$1</span><br><span class="line">   4 - SEL$1 / D@SEL$1</span><br><span class="line">   5 - SEL$1 / D@SEL$1</span><br><span class="line">Outline Data</span><br><span class="line">------------</span><br><span class="line">  /*+</span><br><span class="line">      BEGIN_OUTLINE_DATA</span><br><span class="line">      IGNORE_OPTIM_EMBEDDED_HINTS</span><br><span class="line">      OPTIMIZER_FEATURES_ENABLE(&apos;11.2.0.4&apos;)</span><br><span class="line">      DB_VERSION(&apos;11.2.0.4&apos;)</span><br><span class="line">      ALL_ROWS</span><br><span class="line">      OUTLINE_LEAF(@&quot;SEL$1&quot;)</span><br><span class="line">      FULL(@&quot;SEL$1&quot; &quot;E&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      INDEX(@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot; (&quot;DEPT&quot;.&quot;DEPTNO&quot;))</span><br><span class="line">      LEADING(@&quot;SEL$1&quot; &quot;E&quot;@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      USE_NL(@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      NLJ_BATCHING(@&quot;SEL$1&quot; &quot;D&quot;@&quot;SEL$1&quot;)</span><br><span class="line">      END_OUTLINE_DATA</span><br><span class="line">  */</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line">   3 - filter(&quot;E&quot;.&quot;ENAME&quot;=&apos;SCOTT&apos;)</span><br><span class="line">   4 - access(&quot;E&quot;.&quot;DEPTNO&quot;=&quot;D&quot;.&quot;DEPTNO&quot;)</span><br><span class="line">Column Projection Information (identified by operation id):</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">   1 - &quot;E&quot;.&quot;EMPNO&quot;[NUMBER,22], &quot;E&quot;.&quot;ENAME&quot;[VARCHAR2,10], &quot;E&quot;.&quot;JOB&quot;[VARCHAR2,9],</span><br><span class="line">       &quot;E&quot;.&quot;MGR&quot;[NUMBER,22], &quot;E&quot;.&quot;HIREDATE&quot;[DATE,7], &quot;E&quot;.&quot;SAL&quot;[NUMBER,22],</span><br><span class="line">       &quot;E&quot;.&quot;COMM&quot;[NUMBER,22], &quot;E&quot;.&quot;DEPTNO&quot;[NUMBER,22], &quot;D&quot;.&quot;DEPTNO&quot;[NUMBER,22],</span><br><span class="line">       &quot;D&quot;.&quot;DNAME&quot;[VARCHAR2,14], &quot;D&quot;.&quot;LOC&quot;[VARCHAR2,13]</span><br><span class="line">   2 - &quot;E&quot;.&quot;EMPNO&quot;[NUMBER,22], &quot;E&quot;.&quot;ENAME&quot;[VARCHAR2,10], &quot;E&quot;.&quot;JOB&quot;[VARCHAR2,9],</span><br><span class="line">       &quot;E&quot;.&quot;MGR&quot;[NUMBER,22], &quot;E&quot;.&quot;HIREDATE&quot;[DATE,7], &quot;E&quot;.&quot;SAL&quot;[NUMBER,22],</span><br><span class="line">       &quot;E&quot;.&quot;COMM&quot;[NUMBER,22], &quot;E&quot;.&quot;DEPTNO&quot;[NUMBER,22], &quot;D&quot;.ROWID[ROWID,10],</span><br><span class="line">       &quot;D&quot;.&quot;DEPTNO&quot;[NUMBER,22]</span><br><span class="line">   3 - &quot;E&quot;.&quot;EMPNO&quot;[NUMBER,22], &quot;E&quot;.&quot;ENAME&quot;[VARCHAR2,10], &quot;E&quot;.&quot;JOB&quot;[VARCHAR2,9],</span><br><span class="line">       &quot;E&quot;.&quot;MGR&quot;[NUMBER,22], &quot;E&quot;.&quot;HIREDATE&quot;[DATE,7], &quot;E&quot;.&quot;SAL&quot;[NUMBER,22],</span><br><span class="line">       &quot;E&quot;.&quot;COMM&quot;[NUMBER,22], &quot;E&quot;.&quot;DEPTNO&quot;[NUMBER,22]</span><br><span class="line">   4 - &quot;D&quot;.ROWID[ROWID,10], &quot;D&quot;.&quot;DEPTNO&quot;[NUMBER,22]</span><br><span class="line">   5 - &quot;D&quot;.&quot;DNAME&quot;[VARCHAR2,14], &quot;D&quot;.&quot;LOC&quot;[VARCHAR2,13]</span><br><span class="line"></span><br><span class="line">67 rows selected.</span><br></pre></td></tr></table></figure></p>
<p>如果display_cursor不添加前面两个参数，则表示查看刚刚执行过的SQL的执行计划。如：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; SELECT * FROM emp e, dept d WHERE e.deptno = d.deptno;</span><br><span class="line">SCOTT@linora&gt; select * from table(dbms_xplan.display_cursor(&apos;&apos;,&apos;&apos;,&apos;advanced&apos;));</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-DISPLAY-AWR"><a href="#2-3-DISPLAY-AWR" class="headerlink" title="2.3 DISPLAY_AWR"></a>2.3 DISPLAY_AWR</h4><p>语法：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DBMS_XPLAN.DISPLAY_AWR( </span><br><span class="line">   sql_id            IN      VARCHAR2,</span><br><span class="line">   plan_hash_value   IN      NUMBER DEFAULT NULL,</span><br><span class="line">   db_id             IN      NUMBER DEFAULT NULL,</span><br><span class="line">   format            IN      VARCHAR2 DEFAULT TYPICAL);</span><br></pre></td></tr></table></figure></p>
<p>如果某一条语句的执行计划已经从shared pool清除了，那么此时想要查看此SQL的执行计划，就只能从display_awr中查看了，通过display_awr获取的SQL执行计划来自dba_hist_sql_plan，但display_awr不能查看执行步骤中对应的谓词条件！<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; SELECT * FROM emp e, dept d WHERE e.deptno = d.deptno;</span><br><span class="line">SCOTT@linora&gt; select sql_text,sql_id,hash_value,child_number from v$sql</span><br><span class="line">  2  where sql_text like &apos;SELECT * FROM emp%&apos;;</span><br><span class="line">SQL_TEXT                                                     SQL_ID        HASH_VALUE CHILD_NUMBER</span><br><span class="line">------------------------------------------------------------ ------------- ---------- ------------</span><br><span class="line">SELECT * FROM emp e, dept d WHERE e.deptno = d.deptno        8mfyh7m4tph6q 3461957154            0</span><br><span class="line"></span><br><span class="line">SCOTT@linora&gt; exec dbms_workload_repository.create_snapshot();</span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line"></span><br><span class="line">SCOTT@linora&gt; alter system flush shared_pool;</span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line">SCOTT@linora&gt; select * from table(dbms_xplan.display_cursor(&apos;8mfyh7m4tph6q&apos;,&apos;0&apos;,&apos;advanced&apos;));</span><br><span class="line">PLAN_TABLE_OUTPUT</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">SQL_ID: 8mfyh7m4tph6q, child number: 0 cannot be found</span><br><span class="line"></span><br><span class="line">SCOTT@linora&gt; select * from table(dbms_xplan.display_awr(&apos;8mfyh7m4tph6q&apos;));</span><br><span class="line">PLAN_TABLE_OUTPUT</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">SQL_ID 8mfyh7m4tph6q</span><br><span class="line">--------------------</span><br><span class="line">SELECT * FROM emp e, dept d WHERE e.deptno = d.deptno</span><br><span class="line">Plan hash value: 844388907</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |       |       |     6 (100)|          |</span><br><span class="line">|   1 |  MERGE JOIN                  |         |    14 |   812 |     6  (17)| 00:00:01 |</span><br><span class="line">|   2 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     4 |    80 |     2   (0)| 00:00:01 |</span><br><span class="line">|   3 |    INDEX FULL SCAN           | PK_DEPT |     4 |       |     1   (0)| 00:00:01 |</span><br><span class="line">|   4 |   SORT JOIN                  |         |    14 |   532 |     4  (25)| 00:00:01 |</span><br><span class="line">|   5 |    TABLE ACCESS FULL         | EMP     |    14 |   532 |     3   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，如果某目标SQL的执行计划已经不在shared pool中了，SQL的执行计划已经被Oracle捕获并且存储到了AWR的Repository中，才可以使用display_awr，且版本是10g以上；如果是9i，则需要部署statspack，且采集的level必须大于6才可查看历史SQL的执行计划。</p>
<h3 id="3-auto-trace"><a href="#3-auto-trace" class="headerlink" title="3. auto trace"></a>3. auto trace</h3><p>语法：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; set autotrace -h</span><br><span class="line">Usage: SET AUTOT[RACE] &#123;OFF | ON | TRACE[ONLY]&#125; [EXP[LAIN]] [STAT[ISTICS]]</span><br></pre></td></tr></table></figure></p>
<p><li><code>set autot on/off</code>在当前sessions完全打开/关闭autotrace，同时输出结果及执行计划和资源消耗</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; set autot on</span><br><span class="line">SCOTT@linora&gt; SELECT e.ename,e.job,e.sal,d.dname FROM emp e, dept d </span><br><span class="line">WHERE e.deptno = d.deptno and e.ename=&apos;SCOTT&apos;;</span><br><span class="line"></span><br><span class="line">ENAME      JOB              SAL DNAME</span><br><span class="line">---------- --------- ---------- --------------</span><br><span class="line">SCOTT      ANALYST         3000 RESEARCH</span><br><span class="line"></span><br><span class="line">Execution Plan</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">Plan hash value: 3625962092</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|   1 |  NESTED LOOPS                |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|   2 |   NESTED LOOPS               |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL         | EMP     |     1 |    21 |     3   (0)| 00:00:01 |</span><br><span class="line">|*  4 |    INDEX UNIQUE SCAN         | PK_DEPT |     1 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|   5 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     1 |    13 |     1   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line">   3 - filter(&quot;E&quot;.&quot;ENAME&quot;=&apos;SCOTT&apos;)</span><br><span class="line">   4 - access(&quot;E&quot;.&quot;DEPTNO&quot;=&quot;D&quot;.&quot;DEPTNO&quot;)</span><br><span class="line">Statistics</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">          0  recursive calls</span><br><span class="line">          0  db block gets</span><br><span class="line">          9  consistent gets</span><br><span class="line">          0  physical reads</span><br><span class="line">          0  redo size</span><br><span class="line">        743  bytes sent via SQL*Net to client</span><br><span class="line">        519  bytes received via SQL*Net from client</span><br><span class="line">          2  SQL*Net roundtrips to/from client</span><br><span class="line">          0  sorts (memory)</span><br><span class="line">          0  sorts (disk)</span><br><span class="line">          1  rows processed</span><br></pre></td></tr></table></figure></p>
<p><li><code>set autot trace</code>只输出目标SQL执行计划和资源消耗，对于SQL执行结果则只显示执行结果的数量</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; set autot trace</span><br><span class="line">SCOTT@linora&gt; SELECT e.ename,e.job,e.sal,d.dname FROM emp e, dept d </span><br><span class="line">WHERE e.deptno = d.deptno and e.ename=&apos;SCOTT&apos;;</span><br><span class="line"></span><br><span class="line">Execution Plan</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">Plan hash value: 3625962092</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|   1 |  NESTED LOOPS                |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|   2 |   NESTED LOOPS               |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL         | EMP     |     1 |    21 |     3   (0)| 00:00:01 |</span><br><span class="line">|*  4 |    INDEX UNIQUE SCAN         | PK_DEPT |     1 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|   5 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     1 |    13 |     1   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line">   3 - filter(&quot;E&quot;.&quot;ENAME&quot;=&apos;SCOTT&apos;)</span><br><span class="line">   4 - access(&quot;E&quot;.&quot;DEPTNO&quot;=&quot;D&quot;.&quot;DEPTNO&quot;)</span><br><span class="line">Statistics</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">          0  recursive calls</span><br><span class="line">          0  db block gets</span><br><span class="line">          9  consistent gets</span><br><span class="line">          0  physical reads</span><br><span class="line">          0  redo size</span><br><span class="line">        743  bytes sent via SQL*Net to client</span><br><span class="line">        519  bytes received via SQL*Net from client</span><br><span class="line">          2  SQL*Net roundtrips to/from client</span><br><span class="line">          0  sorts (memory)</span><br><span class="line">          0  sorts (disk)</span><br><span class="line">          1  rows processed</span><br></pre></td></tr></table></figure></p>
<p><li><code>set autot trace exp</code>只输出SQL执行计划，而不会显示目标SQL的执行结果和资源消耗</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; set autot trace exp</span><br><span class="line">SCOTT@linora&gt; SELECT e.ename,e.job,e.sal,d.dname FROM emp e, dept d </span><br><span class="line">WHERE e.deptno = d.deptno and e.ename=&apos;SCOTT&apos;;</span><br><span class="line"></span><br><span class="line">Execution Plan</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">Plan hash value: 3625962092</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">| Id  | Operation                    | Name    | Rows  | Bytes | Cost (%CPU)| Time     |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">|   0 | SELECT STATEMENT             |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|   1 |  NESTED LOOPS                |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|   2 |   NESTED LOOPS               |         |     1 |    34 |     4   (0)| 00:00:01 |</span><br><span class="line">|*  3 |    TABLE ACCESS FULL         | EMP     |     1 |    21 |     3   (0)| 00:00:01 |</span><br><span class="line">|*  4 |    INDEX UNIQUE SCAN         | PK_DEPT |     1 |       |     0   (0)| 00:00:01 |</span><br><span class="line">|   5 |   TABLE ACCESS BY INDEX ROWID| DEPT    |     1 |    13 |     1   (0)| 00:00:01 |</span><br><span class="line">----------------------------------------------------------------------------------------</span><br><span class="line">Predicate Information (identified by operation id):</span><br><span class="line">---------------------------------------------------</span><br><span class="line">   3 - filter(&quot;E&quot;.&quot;ENAME&quot;=&apos;SCOTT&apos;)</span><br><span class="line">   4 - access(&quot;E&quot;.&quot;DEPTNO&quot;=&quot;D&quot;.&quot;DEPTNO&quot;)</span><br></pre></td></tr></table></figure></p>
<p><li><code>set autot trace stat</code>只输出SQL执行结果资源消耗，而不显示执行计划</li><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SCOTT@linora&gt; set autot trace stat</span><br><span class="line">SCOTT@linora&gt; SELECT e.ename,e.job,e.sal,d.dname FROM emp e, dept d </span><br><span class="line">WHERE e.deptno = d.deptno and e.ename=&apos;SCOTT&apos;;</span><br><span class="line"></span><br><span class="line">Statistics</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">          0  recursive calls</span><br><span class="line">          0  db block gets</span><br><span class="line">          9  consistent gets</span><br><span class="line">          0  physical reads</span><br><span class="line">          0  redo size</span><br><span class="line">        743  bytes sent via SQL*Net to client</span><br><span class="line">        519  bytes received via SQL*Net from client</span><br><span class="line">          2  SQL*Net roundtrips to/from client</span><br><span class="line">          0  sorts (memory)</span><br><span class="line">          0  sorts (disk)</span><br><span class="line">          1  rows processed</span><br></pre></td></tr></table></figure></p>
<h3 id="4-10046事件"><a href="#4-10046事件" class="headerlink" title="4. 10046事件"></a>4. 10046事件</h3><p>请参照前文<a href="/oracle-trace.html">Oracle追踪SQL的方法</a> 10046及tkprof的相关介绍。</p>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h3><p>在以上四种方法中，都可以看到SQL的执行计划，但除了10046外，其他方法获得的执行计划，都有可能是不准确的。因此，如果要获得SQL的真实执行计划，最好使用10046事件进行跟踪(SQL_TRACE也是10046的一个级别)。</p>
<h4 id="explain-plan"><a href="#explain-plan" class="headerlink" title="explain plan"></a>explain plan</h4><p>对于此方法而言，目标SQL根本就没有被执行过，因此，该执行计划极有可能是不准确的，特别是含有绑定变量的情况下，针对于bind peeking，Oracle可能会根据绑定变量窥视进行执行计划的调整。</p>
<h4 id="dbms-xplan"><a href="#dbms-xplan" class="headerlink" title="dbms_xplan"></a>dbms_xplan</h4><p>除了dbms_xplan.display执行计划可能不准确外，dbms_xplan.display_awr，dbms_xplan.display_cursor都是准确的执行计划，因为后面两个都表示目标SQL被真正执行过。</p>
<h4 id="set-autotrace"><a href="#set-autotrace" class="headerlink" title="set autotrace"></a>set autotrace</h4><p>autotrace设置为on或者traceonly时，目标SQL已经被实际执行过了，但当使用set autot trace exp时，如果执行的是select语句，则该SQL不会被Oracle执行，如果是DML修改，此时的SQL是会被实际执行的。虽然使用auto trace on/traceonly目标SQL都会被执行，但是用这种方法得到的执行计划还有可能是不准确的，因为使用auto trace命令所显示的执行计划都是源于explain plan的调用，跟TOAD和PL/SQL Developer一样。<br> <code><b>要获得真实的执行计划，尽量采用10046事件或者dbms_xplan.display_cursor！！！</b></code>  </p>
<p> Reference:<br><a href="http://www.dbsnake.net/books" target="_blank" rel="noopener">基于Oracle的SQL优化</a>  </p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/tuning/">#tuning</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/oracle/db-file-multiblock-read-count.html">DB_FILE_MULTIBLOCK_READ_COUNT</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/oracle/table-join-type.html">Oracle表连接类型</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2018 Kong&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>