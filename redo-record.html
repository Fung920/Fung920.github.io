<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>重做记录 - My Notebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">


<meta name="description" content="重做记录详解">



<meta name="keywords" content="redo record">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro|Calibri|Ubuntu">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

<link rel="stylesheet" href="/css/style.css">

<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    

    


</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    My Notebook
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/">Home</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            重做记录
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2014-08-24T01:58:33.000Z" itemprop="datePublished">Aug 24 2014</time>
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/oracle/">oracle</a>
                    <span id="busuanzi_container_page_nv">
Viewed <span id="busuanzi_value_page_nv"></span> times.
</span>

        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <p>大师Jonathan Lewis在《Oracle Core》提到Oracle的一个重要特性，就是在Oracle 6中首次提出的change vector，即改变向量。改变向量是描述数据块变化的机制，是redo和undo的核心。<br><a id="more"></a><br>关于数据改变的方法，大师在《Oracle Core》描述如下：</p>
<p><li>创建一个重做改变向量，描述如何往undo块插入一条undo记录</li></p>
<p><li>创建一个重做改变向量，描述数据块的改变</li></p>
<p><li>合并这两个重做记录为一条日志记录，并写到重做日志缓冲区</li></p>
<p><li>向undo块插入undo记录</li></p>
<p><li>改变数据块中的数据</li><br>在理解重做记录和改变向量之前，需要理解SCN、数据块版本号和RBA等概念。</p>
<h3 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1. 基本概念"></a>1. 基本概念</h3><h4 id="1-1-SCN"><a href="#1-1-SCN" class="headerlink" title="1.1 SCN"></a>1.1 SCN</h4><p>SCN是Oracle的内部时钟机制，SCN由两部分共6字节组成，4字节为base(底值)，2字节为Wrap(进位值)。当前的base随时间的流逝和变更操作的执行而递增，在用尽之后开始循环，此时wrap递增。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--查询SCN的方法</span><br><span class="line">SYS@linora&gt; select current_scn from v$database</span><br><span class="line">  2  union all</span><br><span class="line">  3  select dbms_flashback.get_system_change_number from dual;</span><br><span class="line"></span><br><span class="line">CURRENT_SCN</span><br><span class="line">-----------</span><br><span class="line">    3107373</span><br><span class="line">    3107373</span><br></pre></td></tr></table></figure></p>
<p>如果之前数据库是干净关闭的，mount状态下查看控制文件和数据文件头部信息的SCN，可以发现这两者的值是一样的：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">--dump控制文件的scn</span><br><span class="line">SYS@linora&gt; alter session set events &apos;immediate trace name controlf level 8&apos;;</span><br><span class="line">Session altered.</span><br><span class="line">--Trace 文件内容</span><br><span class="line">Database checkpoint: Thread=1 scn: 0x0000.002ded1f--Database checkpoint scn</span><br><span class="line">...</span><br><span class="line">Controlfile Checkpointed at scn:  0x0000.002de9f1 08/22/2014 14:36:37 -- controlfile checkpoint scn</span><br><span class="line">...</span><br><span class="line">***************************************************************************</span><br><span class="line">DATA FILE RECORDS</span><br><span class="line">***************************************************************************</span><br><span class="line"> (size = 520, compat size = 520, section max = 100, section in-use = 10,</span><br><span class="line">  last-recid= 161, old-recno = 0, last-recno = 0)</span><br><span class="line"> (extent = 1, blkno = 11, numrecs = 100)</span><br><span class="line">DATA FILE # 1:</span><br><span class="line">  name # 4: /oradata/datafile/linora/system01.dbf</span><br><span class="line">Checkpoint cnt:539 scn: 0x0000.002ded1f 08/22/2014 14:46:09 -- datafile checkpoint scn in controflile </span><br><span class="line">...</span><br><span class="line">DATA FILE # 2:</span><br><span class="line">  name # 5: /oradata/datafile/linora/sysaux01.dbf</span><br><span class="line">creation size=76800 block size=8192 status=0xe head=5 tail=5 dup=1</span><br><span class="line"> tablespace 1, index=2 krfil=2 prev_file=0</span><br><span class="line"> unrecoverable scn: 0x0000.00000000 01/01/1988 00:00:00</span><br><span class="line"> Checkpoint cnt:534 scn: 0x0000.002ded1f 08/22/2014 14:46:09</span><br><span class="line">--尝试在mount状态下dump数据文件和数据文件头，发现和控制文件dump的scn是一致的</span><br><span class="line">SYS@linora&gt; alter session set events &apos;immediate trace name file_hdrs level 8&apos;;</span><br><span class="line">Session altered.</span><br><span class="line">DATA FILE # 1:</span><br><span class="line">  name # 4: /oradata/datafile/linora/system01.dbf</span><br><span class="line">creation size=89600 block size=8192 status=0xe head=4 tail=4 dup=1</span><br><span class="line"> tablespace 0, index=1 krfil=1 prev_file=0</span><br><span class="line"> unrecoverable scn: 0x0000.00000000 01/01/1988 00:00:00</span><br><span class="line"> Checkpoint cnt:539 scn: 0x0000.002ded1f 08/22/2014 14:46:09</span><br><span class="line"> Stop scn: 0x0000.002ded1f 08/22/2014 14:46:09</span><br><span class="line"> ...</span><br><span class="line">DATA FILE # 2:</span><br><span class="line">  name # 5: /oradata/datafile/linora/sysaux01.dbf</span><br><span class="line">creation size=76800 block size=8192 status=0xe head=5 tail=5 dup=1</span><br><span class="line"> tablespace 1, index=2 krfil=2 prev_file=0</span><br><span class="line"> unrecoverable scn: 0x0000.00000000 01/01/1988 00:00:00</span><br><span class="line"> Checkpoint cnt:534 scn: 0x0000.002ded1f 08/22/2014 14:46:09</span><br><span class="line"> Stop scn: 0x0000.002ded1f 08/22/2014 14:46:09</span><br></pre></td></tr></table></figure></p>
<p>SCN是以scn: 0x0000.002ded1f存储在dump文件中，可以通过函数转换成16进制：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select to_number(&apos;2ded1f&apos;,&apos;xxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;2DED1F&apos;,&apos;XXXXXX&apos;)</span><br><span class="line">----------------------------</span><br><span class="line">                     3009823</span><br></pre></td></tr></table></figure></p>
<h4 id="1-2-数据块版本"><a href="#1-2-数据块版本" class="headerlink" title="1.2 数据块版本"></a>1.2 数据块版本</h4><p>当同一个SCN包含多条重做记录时候，说明有一个以上的操作分配到了同样的SCN，此时，引入一个SUBSCN，如&#39;SCN: 0x0000.002de89d SUBSCN:  1&#39;，当修改完成后，SCN和SUBSCN会被保存在被修改的数据块的头部，占用7字节，但此时SUBSCN变为SEQ，SCN+SEQ就是数据块版本号：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; ALTER SYSTEM DUMP LOGFILE &apos;/oradata/datafile/linora/redo02.log&apos;;</span><br><span class="line">System altered.</span><br><span class="line">--redo record头部信息</span><br><span class="line">REDO RECORD - Thread:1 RBA: 0x000097.00000002.0010 LEN: 0x026c VLD: 0x05</span><br><span class="line">SCN: 0x0000.002de89d SUBSCN:  1 08/22/2014 14:22:02 --修改前版本号</span><br></pre></td></tr></table></figure></p>
<h4 id="1-3-RBA"><a href="#1-3-RBA" class="headerlink" title="1.3 RBA"></a>1.3 RBA</h4><p>RBA全称为Redo Byte Address，其作用类似rowid对于表的作用。即重做日志中的物理地址，RBA由四部分组成：日志线程号、日志序列号、日志文件块号和日志文件块字节偏移量，共10字节。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; ALTER SYSTEM DUMP LOGFILE &apos;/oradata/datafile/linora/redo02.log&apos;;</span><br><span class="line">System altered.</span><br><span class="line">SYS@linora&gt; select value from v$diag_info where name=&apos;Default Trace File&apos;;</span><br><span class="line">--Trace文件部分信息</span><br><span class="line">DUMP OF REDO FROM FILE &apos;/oradata/datafile/linora/redo02.log&apos;</span><br><span class="line">REDO RECORD - Thread:1 RBA: 0x00009a.00000002.0010 LEN: 0x0080 VLD: 0x06</span><br><span class="line">SCN: 0x0000.002f0ea5 SUBSCN:  1 08/23/2014 22:56:28</span><br></pre></td></tr></table></figure></p>
<p>可以看到，在dump文件中，RBA以RBA: 0x00009a.00000002.0010的形式存在，其含义为Thread 1，log sequence=154的redo log的第2个块中的第16字节处，对于16进制转换，参照如下方法，文件结尾后面总结了一些比较常用的进制转换方法。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select to_number(&apos;9a&apos;,&apos;xxxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;9A&apos;,&apos;XXXXXXX&apos;)</span><br><span class="line">-------------------------</span><br><span class="line">                      154</span><br></pre></td></tr></table></figure></p>
<h3 id="2-重做记录"><a href="#2-重做记录" class="headerlink" title="2. 重做记录"></a>2. 重做记录</h3><p>本例以修改hr.empployees中员工号为100的薪资(修改后薪水为原来的120%)为例，来简单探索重做记录和改变向量。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--先查看当前记录所在行的物理地址和原来的薪水</span><br><span class="line">SYS@linora&gt; select rowid,salary,first_name,last_name</span><br><span class="line">  2  from hr.employees where employee_id=100;</span><br><span class="line">ROWID                  SALARY FIRST_NAME           LAST_NAME</span><br><span class="line">------------------ ---------- -------------------- -------------------------</span><br><span class="line">AAAUsBAAIAAACzUAAA      24000 Steven               King</span><br></pre></td></tr></table></figure></p>
<p>rowid以Base64的形式出现，该结构前6位代表segment_id—AAAUsB(84737)，随后三位代表数据文件号—AAI(8)，接下来的6位代表数据块编号—AAACzU(11476)，最后三位代表行号—AAA(0)。 因此，在上述结果中，emp id=100的员工其数据存在的物理位置为：存储在第8号文件的第11476块上第0行(关于ROWID的说明请参照<a href="/what-is-rowid.html">Oracle ROWID学习</a>)。使用dbms_rowid函数查看：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; SELECT DBMS_ROWID.ROWID_OBJECT(rowid) &quot;OBJECT&quot;,</span><br><span class="line">  2  DBMS_ROWID.ROWID_RELATIVE_FNO(rowid) &quot;FILE&quot;,</span><br><span class="line">  3  DBMS_ROWID.ROWID_BLOCK_NUMBER(rowid) &quot;BLOCK&quot;,</span><br><span class="line">  4  DBMS_ROWID.ROWID_ROW_NUMBER(rowid) &quot;ROW&quot;</span><br><span class="line">  5  FROM hr.employees where employee_id=100;</span><br><span class="line">    OBJECT       FILE      BLOCK        ROW</span><br><span class="line">---------- ---------- ---------- ----------</span><br><span class="line">     84737          8      11476          0</span><br></pre></td></tr></table></figure></p>
<p>由于redo log包含的范围比较广，因此在dump日志文件的时候可基于scn值去dump相关时间段的内容(其他方式的dump，如基于DBA，请参照文章结尾)：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; set serverout on</span><br><span class="line">SYS@linora&gt; declare</span><br><span class="line">  2       SCN1 number;</span><br><span class="line">  3       SCN2 number;</span><br><span class="line">  4      begin</span><br><span class="line">  5          select current_scn into SCN1 from v$database;</span><br><span class="line">  6          dbms_output.put_line(&apos;Before Updata SCN: &apos;||SCN1);</span><br><span class="line">  7          update hr.employees set salary=salary*1.2 where employee_id=100;</span><br><span class="line">  8         commit;</span><br><span class="line">  9         select current_scn into SCN2 from v$database;</span><br><span class="line"> 10         dbms_output.put_line(&apos;After Update SCN: &apos;||SCN2);</span><br><span class="line"> 11  end;</span><br><span class="line"> 12  /</span><br><span class="line">Before Updata SCN: 3109548</span><br><span class="line">After Update SCN: 3109551</span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure></p>
<p>查找当前日志文件所在路径：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; col member for a50</span><br><span class="line">SYS@linora&gt; select member,sequence# from v$logfile a,v$log b</span><br><span class="line">  2  where b.group#=a.group#</span><br><span class="line">  3  and b.status=&apos;CURRENT&apos;;</span><br><span class="line">MEMBER                                              SEQUENCE#</span><br><span class="line">-------------------------------------------------- ----------</span><br><span class="line">/oradata/datafile/linora/redo03.log                       155</span><br></pre></td></tr></table></figure></p>
<p>dump相关日志文件：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; alter system dump logfile &apos;/oradata/datafile/linora/redo03.log&apos; scn min 3109548 scn max 3109551;</span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-头部信息"><a href="#2-1-头部信息" class="headerlink" title="2.1 头部信息"></a>2.1 头部信息</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REDO RECORD - Thread:1 RBA: 0x00009b.00002c33.0010 LEN: 0x0278 VLD: 0x05</span><br><span class="line">SCN: 0x0000.002f72ac SUBSCN:  1 08/24/2014 17:14:38</span><br><span class="line">(LWN RBA: 0x00009b.00002c33.0010 LEN: 0002 NST: 0001 SCN: 0x0000.002f72ab)</span><br></pre></td></tr></table></figure>
<p>重做记录头部信息包含了以下信息：RBA，数据块版本号等。以上信息表明重做记录的头部信息记录在Thread 1，log sequence#为155上(和之前查询的结果一致)的第11315块上的第16字节处。当前数据块版本号：SCN: 0x0000.002f72ac SUBSCN:  1，转换如下：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select to_number(&apos;9b&apos;,&apos;xxxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;9B&apos;,&apos;XXXXXXX&apos;)</span><br><span class="line">-------------------------</span><br><span class="line">                      155</span><br><span class="line">SYS@linora&gt; select to_number(&apos;2c33&apos;,&apos;xxxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;2C33&apos;,&apos;XXXXXXX&apos;)</span><br><span class="line">---------------------------</span><br><span class="line">                      11315</span><br><span class="line">SYS@linora&gt; select to_number(&apos;10&apos;,&apos;xxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;10&apos;,&apos;XXXXXX&apos;)</span><br><span class="line">------------------------</span><br><span class="line">                      16</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-CHANGE-1"><a href="#2-2-CHANGE-1" class="headerlink" title="2.2 CHANGE # 1"></a>2.2 CHANGE # 1</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE # 1 TYP:0 CLS:23 AFN:3 DBA:0x00c000b0 OBJ:4294967295 SCN:0x0000.002f724b SEQ:1 OP:5.2 ENC:0 RBL:0</span><br><span class="line">ktudh redo: slt: 0x0004 sqn: 0x00000530 flg: 0x000a siz: 184 fbi: 0</span><br><span class="line">            uba: 0x00c0cc3e.00f6.01    pxid:  0x0000.000.00000000</span><br></pre></td></tr></table></figure>
<p>第一个改变向量是记录了如何对3号文件的176块进行修改，该数据块是undo segment头部，地址由AFN绝对文件号(对应v$datafile.file#)和DBA(Data Block Address)表示。当前数据块版本号为：SCN:0x0000.002f724b SEQ:1，修改数据后此数据块的版本号为:SCN: 0x0000.002f72ac SUBSCN:  1 (来自重做记录头部信息)。其中DBA包括文件编号和数据块编号，长度为4字节，使用dbms_utility可以进行转换：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select to_number(&apos;c000b0&apos;,&apos;xxxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;C000B0&apos;,&apos;XXXXXXX&apos;)</span><br><span class="line">-----------------------------</span><br><span class="line">                     12583088</span><br><span class="line">SYS@linora&gt; select dbms_utility.data_block_address_file(12583088) as rfile,</span><br><span class="line">dbms_utility.data_block_address_block(12583088) as block from dual;</span><br><span class="line">     RFILE      BLOCK</span><br><span class="line">---------- ----------</span><br><span class="line">         3        176</span><br></pre></td></tr></table></figure></p>
<p>通过AFN和DBA查找对象：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; col tablespace_name for a20 </span><br><span class="line">SYS@linora&gt; col segment_type for a10 </span><br><span class="line">SYS@linora&gt; col segment_name for a20 </span><br><span class="line">SYS@linora&gt; col owner for a8 </span><br><span class="line">SYS@linora&gt; SELECT tablespace_name, segment_type, owner, segment_name </span><br><span class="line">  2  FROM dba_extents </span><br><span class="line">  3  WHERE file_id = &amp;fileid </span><br><span class="line">  4  and &amp;blockid between block_id AND block_id + blocks - 1;</span><br><span class="line">Enter value for fileid: 3</span><br><span class="line">old   3: WHERE file_id = &amp;fileid</span><br><span class="line">new   3: WHERE file_id = 3</span><br><span class="line">Enter value for blockid: 176</span><br><span class="line">old   4: and &amp;blockid between block_id AND block_id + blocks - 1</span><br><span class="line">new   4: and 176 between block_id AND block_id + blocks - 1</span><br><span class="line"></span><br><span class="line">TABLESPACE_NAME      SEGMENT_TY OWNER    SEGMENT_NAME</span><br><span class="line">-------------------- ---------- -------- --------------------</span><br><span class="line">UNDOTBS1             TYPE2 UNDO SYS      _SYSSMU4_3538150892$</span><br></pre></td></tr></table></figure></p>
<p>很明显，当前矢量修改的是undo segment &#39;_SYSSMU4_3538150892$&#39;。修改undo segment的目的是创建事务表。这是因为update命令发起了事务，Oracle必须为每个事务分配undo segment，在undo segment中创建一张事务表，该表用来保存事务产生的旧数据，用于支持事务的回滚和查询的一致性读。一个事务产生的所有旧数据都存放在同一个事务表中，一个undo segment又可以包含多个事务表。</p>
<h4 id="2-3-CHANGE-2"><a href="#2-3-CHANGE-2" class="headerlink" title="2.3 CHANGE # 2"></a>2.3 CHANGE # 2</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CHANGE # 2 TYP:1 CLS:24 AFN:3 DBA:0x00c0cc3e OBJ:4294967295 SCN:0x0000.002f72ac SEQ:1 OP:5.1 ENC:0 RBL:0</span><br><span class="line">ktudb redo: siz: 184 spc: 0 flg: 0x000a seq: 0x00f6 rec: 0x01</span><br><span class="line">            xid:  0x0004.004.00000530  </span><br><span class="line">ktubl redo: slt: 4 rci: 0 opc: 11.1 [objn: 84737 objd: 84737 tsn: 8]</span><br><span class="line">Undo type:  Regular undo        Begin trans    Last buffer split:  No </span><br><span class="line">Temp Object:  No </span><br><span class="line">Tablespace Undo:  No </span><br><span class="line">             0x00000000  prev ctl uba: 0x00c0cc3d.00f6.22 </span><br><span class="line">prev ctl max cmt scn:  0x0000.002f6e01  prev tx cmt scn:  0x0000.002f6e0a </span><br><span class="line">txn start scn:  0xffff.ffffffff  logon user: 0  prev brb: 12635193  prev bcl: 0 BuExt idx: 0 flg2: 0</span><br><span class="line">KDO undo record:</span><br><span class="line">KTB Redo </span><br><span class="line">op: 0x04  ver: 0x01  </span><br><span class="line">compat bit: 4 (post-11) padding: 1</span><br><span class="line">op: L  itl: xid:  0x000a.020.00000513 uba: 0x00c003fe.00d2.01</span><br><span class="line">                      flg: C---    lkc:  0     scn: 0x0000.002f0291</span><br><span class="line">KDO Op code: URP row dependencies Disabled --Operation Code为Update</span><br><span class="line">  xtype: XA flags: 0x00000000  bdba: 0x02002cd4  hdba: 0x02002cd2 --bdba:正在更新的块的地址 hdba:该对象段头块地址</span><br><span class="line">itli: 2  ispac: 0  maxfr: 4858 --itli：事务槽，即第二个事务槽</span><br><span class="line">tabn: 0 slot: 0(0x0) flag: 0x2c lock: 0 ckix: 0 </span><br><span class="line">ncol: 11 nnew: 1 size: 0 	--size：表示存储数据是否改变，如果原来是三位，后面增加了一位，则size：1</span><br><span class="line">col  7: [ 3]  c3 03 29 --update前的数据</span><br></pre></td></tr></table></figure>
<p>第一个矢量负责创建事务表，第二个则负责在事务表中创建具体的撤销数据，以上信息记录了如何对AFN=3，DBA:0x00c0cc3e(52286号)的数据块进行修改。在tabn中，slot：0(0x0)表示数据块中的第一行被update命令修改，col 7: [ 3] c3 03 29表示改行的第8个字段，在update前是16进制c30329，长度3字节，可以通过dump查看：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select dump(24000,16) from dual;</span><br><span class="line">DUMP(24000,16)</span><br><span class="line">--------------------</span><br><span class="line">Typ=2 Len=3: c3,3,29</span><br></pre></td></tr></table></figure></p>
<h4 id="2-4-CHANGE-3"><a href="#2-4-CHANGE-3" class="headerlink" title="2.4 CHANGE # 3"></a>2.4 CHANGE # 3</h4><p>前两个变更矢量只是表明undo record该如何生成，尚未提及100号员工所在的数据块—8号文件11476块如何修改，这是CHANGE # 3的任务。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CHANGE # 3 TYP:2 CLS:1 AFN:8 DBA:0x02002cd4 OBJ:84737 SCN:0x0000.002f7210 SEQ:1 OP:11.5 ENC:0 RBL:0</span><br><span class="line">KTB Redo </span><br><span class="line">op: 0x11  ver: 0x01  </span><br><span class="line">compat bit: 4 (post-11) padding: 1</span><br><span class="line">op: F  xid:  0x0004.004.00000530    uba: 0x00c0cc3e.00f6.01</span><br><span class="line">Block cleanout record, scn:  0x0000.002f72ac ver: 0x01 opt: 0x02, entries follow...</span><br><span class="line">  itli: 1  flg: 2  scn: 0x0000.002f7210</span><br><span class="line">KDO Op code: URP row dependencies Disabled</span><br><span class="line">  xtype: XA flags: 0x00000000  bdba: 0x02002cd4  hdba: 0x02002cd2</span><br><span class="line">itli: 2  ispac: 0  maxfr: 4858</span><br><span class="line">tabn: 0 slot: 0(0x0) flag: 0x2c lock: 2 ckix: 0</span><br><span class="line">ncol: 11 nnew: 1 size: 0</span><br><span class="line">col  7: [ 3]  c3 03 59  --修改后的数据</span><br></pre></td></tr></table></figure></p>
<p>第一行记录了AFN和DBA，tabn记录了slot(行)及最后以后记录了col(字段)，因此，这个矢量才是update的真正目的。将8号文件11476块的第一行(slot 0)的第八个字段(col 7)修改为c30359，这个16进制的转换涉及到Oracle存储Number类型的内部原理，可参照老盖的Blog:<a href="http://www.eygle.com/archives/2005/12/how_oracle_stor.html" target="_blank" rel="noopener">How Oracle Store Number internal</a>，根据老盖的介绍作一个简要的说明： 由于[ 3]是表示以三位存储这个16进制，因此，需要分开c3-03-59分别转换成10进制：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select to_number(&apos;c3&apos;,&apos;xxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;C3&apos;,&apos;XXXXXX&apos;)</span><br><span class="line">------------------------</span><br><span class="line">                     195</span><br><span class="line">SYS@linora&gt; select to_number(&apos;59&apos;,&apos;xxxxxx&apos;) from dual;</span><br><span class="line">TO_NUMBER(&apos;59&apos;,&apos;XXXXXX&apos;)</span><br><span class="line">------------------------</span><br><span class="line">                      89</span><br></pre></td></tr></table></figure></p>
<p>因此，实际存储则为十进制:195,3,89，按照老盖的说明： 指数：195-193=2，为正数，数字1：3-1 = 21002-0 20000 ，数字2: 89 -1 =881001-0 8800 。因此，这个Number类型的值为20000+8800=28800跟我们预期的结果一致！使用dump函数dump一下28800的16进制和10进制：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--16进制</span><br><span class="line">SYS@linora&gt; select dump(28800,16) from dual;</span><br><span class="line">DUMP(28800,16)</span><br><span class="line">--------------------</span><br><span class="line">Typ=2 Len=3: c3,3,59</span><br><span class="line">--10进制</span><br><span class="line">SYS@linora&gt; select dump(28800,10) from dual;</span><br><span class="line">DUMP(28800,10)</span><br><span class="line">---------------------</span><br><span class="line">Typ=2 Len=3: 195,3,89</span><br></pre></td></tr></table></figure></p>
<p>用其他函数验证(dump逆函数)：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--16进制转10进制</span><br><span class="line">SYS@linora&gt; select utl_raw.cast_to_number(&apos;c30359&apos;) from dual;</span><br><span class="line">UTL_RAW.CAST_TO_NUMBER(&apos;C30359&apos;)</span><br><span class="line">--------------------------------</span><br><span class="line">                           28800</span><br><span class="line">--10进制转16进制</span><br><span class="line">SYS@linora&gt; select utl_raw.cast_from_number(&apos;28800&apos;) value from dual;</span><br><span class="line">VALUE</span><br><span class="line">------------------------------</span><br><span class="line">C30359</span><br></pre></td></tr></table></figure></p>
<h4 id="2-5-CHANGE-4"><a href="#2-5-CHANGE-4" class="headerlink" title="2.5 CHANGE # 4"></a>2.5 CHANGE # 4</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CHANGE # 4 MEDIA RECOVERY MARKER SCN:0x0000.00000000 SEQ:0 OP:5.19 ENC:0</span><br><span class="line">session number   = 261</span><br><span class="line">serial  number   = 119</span><br><span class="line">current username = SYS</span><br><span class="line">login   username = SYS</span><br><span class="line">client info      = </span><br><span class="line">OS username      = oracle</span><br><span class="line">Machine name     = linora</span><br><span class="line">OS terminal      = pts/1</span><br><span class="line">OS process id    = 2215</span><br><span class="line">OS program name  = sqlplus@linora (TNS V1-V3)</span><br><span class="line">transaction name = </span><br><span class="line">version 186647552</span><br><span class="line">audit sessionid 4294967295</span><br><span class="line">Client Id  =</span><br></pre></td></tr></table></figure>
<p>第四个改变向量没有说明任何更改意图，其作用包括提供恢复操作完结点，提供有限的事后审计。<br>上述update命令的目的是修改8号文件的11476块(CHANGE # 3)，但是要先在CHANGE # 1中往undo segment即3号文件(undotbs01.bdf)176号数据块注册事务表，并在事务表的的3号文件52286块保存undo data以保证读一致性及回滚，因此，在Oracle数据库中，最简单的DML指令至少要修改三个数据块。</p>
<h3 id="3-OP-Code说明"><a href="#3-OP-Code说明" class="headerlink" title="3. OP Code说明"></a>3. OP Code说明</h3><p>在以上的重做记录分析中，存在着一个重要的操作代码，OP=Operation Code，代表了操作的类型：<br><img src="/images/op1.png" alt="OP Code"><br>对于DML事务，Level为11，具体操作代码：<br><img src="/images/op2.png" alt="DML OP"><br>对于UNDO的操作，其代码如下所示：<br><img src="/images/op3.png" alt="UNDO OP"><br>因此，在CHANGE # 1 OP=5.2，表示更新undo segment头部信息，CHANGE # 2 OP=5.1表示undo segment头部信息，CHANGE # 3 OP=11.5表示更新操作。</p>
<h3 id="4-相关dump-redo方法"><a href="#4-相关dump-redo方法" class="headerlink" title="4. 相关dump redo方法"></a>4. 相关dump redo方法</h3><p>archive log属于redo的离线，因此dump archived log语法和redo一样，参照MOS：1031381.6<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--dump redo header</span><br><span class="line">alter session set events &apos;immediate trace name redohdr level 10&apos;;</span><br><span class="line">Session altered.</span><br><span class="line">--dump an entire redo file </span><br><span class="line">alter system dump logfile &apos;/oradata/datafile/linora/redo03.log&apos;;</span><br><span class="line">--dump redo base on DBA</span><br><span class="line">	--10g及以上版本：</span><br><span class="line">	ALTER SYSTEM DUMP LOGFILE &apos;/oradata/datafile/linora/redo03.log&apos; DBA MIN 5 31125 DBA MAX 5 31150;</span><br><span class="line">	--9i版本：</span><br><span class="line">	ALTER SYSTEM DUMP LOGFILE &apos;/oradata/datafile/linora/redo03.log&apos; DBA MIN 5 . 31125 DBA MAX 5 . 31150;</span><br><span class="line">--dump redo base on RBA</span><br><span class="line">ALTER SYSTEM DUMP LOGFILE &apos;/oradata/datafile/linora/redo03.log&apos; RBA MIN 2050 . 13255 RBA MAX 2255 . 15555;</span><br><span class="line">--dump redo base on SCN</span><br><span class="line">alter system dump logfile &apos;/oradata/datafile/linora/redo03.log&apos; scn min 3109548 scn max 3109551;</span><br><span class="line">--dump redo base on time</span><br><span class="line">ALTER SYSTEM DUMP LOGFILE &apos;/oradata/datafile/linora/redo03.log&apos; TIME MIN 299425687 TIME MAX 299458800;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-相关函数简单说明"><a href="#5-相关函数简单说明" class="headerlink" title="5. 相关函数简单说明"></a>5. 相关函数简单说明</h3><h4 id="5-1-dump"><a href="#5-1-dump" class="headerlink" title="5.1 dump"></a>5.1 dump</h4><p>Oracle通过相应的数据库内部算法转换来进行数据存储，dump函数能查看数据在Oracle内部存储内容。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--用法：DUMP(expr[,number_format[,start_position][,length]]) </span><br><span class="line">--用法说明： dump(col_name,8|10|16|17) ,其中8|10|16|17 为number_format，分别为8进制，</span><br><span class="line">--10进制（默认值），16进制，单字符。</span><br><span class="line">SYS@linora&gt; select dump(24000,10) from dual;</span><br><span class="line">DUMP(24000,10)</span><br><span class="line">---------------------</span><br><span class="line">Typ=2 Len=3: 195,3,41</span><br><span class="line">SYS@linora&gt; select dump(24000,16) from dual;</span><br><span class="line">DUMP(24000,16)</span><br><span class="line">--------------------</span><br><span class="line">Typ=2 Len=3: c3,3,29</span><br></pre></td></tr></table></figure></p>
<h4 id="5-2-utl-raw"><a href="#5-2-utl-raw" class="headerlink" title="5.2 utl_raw"></a>5.2 utl_raw</h4><p>对于dump出来的内容，通常不能直观的了解到想要的信息，可以通过utl_raw来实现。以dump hr.employees员工号100所在数据块为例，来说明此函数的用法。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--查询数据所在DBA</span><br><span class="line">SYS@linora&gt; SELECT DBMS_ROWID.ROWID_OBJECT(rowid) &quot;OBJECT&quot;,</span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(rowid) &quot;FILE&quot;,</span><br><span class="line">  2    3  DBMS_ROWID.ROWID_BLOCK_NUMBER(rowid) &quot;BLOCK&quot;,</span><br><span class="line">  4  DBMS_ROWID.ROWID_ROW_NUMBER(rowid) &quot;ROW&quot;</span><br><span class="line">  5  FROM hr.employees where employee_id=100;</span><br><span class="line"></span><br><span class="line">    OBJECT       FILE      BLOCK        ROW</span><br><span class="line">---------- ---------- ---------- ----------</span><br><span class="line">     84737          8      11476          0</span><br><span class="line">SYS@linora&gt; alter system dump datafile 8 block 11476;</span><br><span class="line">System altered.</span><br><span class="line">SYS@linora&gt; @trace</span><br><span class="line">VALUE</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">/u01/app/oracle/diag/rdbms/linora/linora/trace/linora_ora_3141.trc</span><br></pre></td></tr></table></figure></p>
<p>查看trace文件信息：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--表结构数据类型</span><br><span class="line">SYS@linora&gt; desc hr.employees</span><br><span class="line"> Name                              Null?    Type</span><br><span class="line"> --------------------------------- -------- ------------------</span><br><span class="line"> EMPLOYEE_ID                       NOT NULL NUMBER(6)</span><br><span class="line"> FIRST_NAME                                 VARCHAR2(20)</span><br><span class="line"> LAST_NAME                         NOT NULL VARCHAR2(25)</span><br><span class="line"> EMAIL                             NOT NULL VARCHAR2(25)</span><br><span class="line"> PHONE_NUMBER                               VARCHAR2(20)</span><br><span class="line"> HIRE_DATE                         NOT NULL DATE</span><br><span class="line"> JOB_ID                            NOT NULL VARCHAR2(10)</span><br><span class="line"> SALARY                                     NUMBER(8,2)</span><br><span class="line"> COMMISSION_PCT                             NUMBER(2,2)</span><br><span class="line"> MANAGER_ID                                 NUMBER(6)</span><br><span class="line"> DEPARTMENT_ID                              NUMBER(4)</span><br><span class="line">--此块中的row=0行信息，即我们查询的员工号=100的数据存储</span><br><span class="line">block_row_dump:</span><br><span class="line">tab 0, row 0, @0x3c3</span><br><span class="line">tl: 62 fb: --H-FL-- lb: 0x2  cc: 11</span><br><span class="line">col  0: [ 2]  c2 02</span><br><span class="line">col  1: [ 6]  53 74 65 76 65 6e</span><br><span class="line">col  2: [ 4]  4b 69 6e 67</span><br><span class="line">col  3: [ 5]  53 4b 49 4e 47</span><br><span class="line">col  4: [12]  35 31 35 2e 31 32 33 2e 34 35 36 37</span><br><span class="line">col  5: [ 7]  78 67 06 11 01 01 01</span><br><span class="line">col  6: [ 7]  41 44 5f 50 52 45 53</span><br><span class="line">col  7: [ 3]  c3 03 59</span><br><span class="line">col  8: *NULL*</span><br><span class="line">col  9: *NULL*</span><br><span class="line">col 10: [ 2]  c1 5b</span><br></pre></td></tr></table></figure></p>
<p>我们找其中几个字段进行转换：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select employee_id,LAST_NAME,SALARY from hr.employees where employee_id=100;</span><br><span class="line">EMPLOYEE_ID LAST_NAME                     SALARY</span><br><span class="line">----------- ------------------------- ----------</span><br><span class="line">        100 King                           28800</span><br></pre></td></tr></table></figure></p>
<p>#####employee_id<br>此字段为col 0，类型为Number，在数据库里面存储为&#39;c2 02&#39;，用函数转换一下：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SYS@linora&gt; select utl_raw.cast_to_number(&apos;c202&apos;) employee_id from dual;</span><br><span class="line">EMPLOYEE_ID</span><br><span class="line">-----------</span><br><span class="line">        100</span><br></pre></td></tr></table></figure></p>
<p>上面的写法，当utl_raw.cast_to_number()引号中的内容多时，用起来不方便。可以加个replace()函数，处理起来便于阅读。<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--replace函数用法：replace(&apos;exp1&apos;,&apos;exp2&apos;,&apos;exp3&apos;)从exp1中找出exp2字符串，用exp3代替</span><br><span class="line">select utl_raw.cast_to_number(replace(&apos;c2 02&apos;,&apos; &apos;)) v from dual;</span><br></pre></td></tr></table></figure></p>
<p>#####LAST_NAME<br>此字段存储于表中的第三个栏位，即col 2，类型为varchar2，存储数据为&#39;4b 69 6e 67&#39;，使用函数进行转换：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--转换为字符串</span><br><span class="line">SYS@linora&gt; select utl_raw.cast_to_varchar2(replace(&apos;4b 69 6e 67&apos;,&apos; &apos;)) last_name from dual;</span><br><span class="line">LAST_NAME</span><br><span class="line">----------</span><br><span class="line">King</span><br></pre></td></tr></table></figure></p>
<p>#####SALARY<br>此字段存储与表的第八个字段，即col 7，类型为Number，存储数据为&#39;c3 03 59&#39;，使用函数进行转换：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--转换为10进制数字</span><br><span class="line">SYS@linora&gt; select utl_raw.cast_to_number(replace(&apos;c3 03 59&apos;,&apos; &apos;)) SAL from dual;</span><br><span class="line">       SAL</span><br><span class="line">----------</span><br><span class="line">     28800</span><br></pre></td></tr></table></figure></p>
<p>同时，utl_raw还存在cast_from_number，此函数用法有点类似dump：<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--由数字转换为16进制</span><br><span class="line">SYS@linora&gt; select utl_raw.cast_from_number(28800) SAL from dual;</span><br><span class="line">SAL</span><br><span class="line">--------------------</span><br><span class="line">C30359</span><br></pre></td></tr></table></figure></p>
<p>Reference:<br>《深入浅出Oracle》--盖国强<br>《Oracle Core-Essential Internals for DBAs and Developers》--Jonathan Lewis<br>《临危不惧-Oracle 11g数据库恢复技术》--包光磊</p>

    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/internal/">#internal</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/rac-private-network-loss.html">心跳丢失引起RAC节点不断重启</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/db-file-multiblock-read-count.html">DB_FILE_MULTIBLOCK_READ_COUNT</a>
            
        </span>
    </div>
    
</article>





    </div>
</section>

    <footer class="footer footer-padding">
    <div class="container content">
            <div class="column is-narrow has-text-centered is-size-7-mobile">
                &copy;  <a href="/">Kyun Kong&nbsp;</a>
                2013 - 2019
            </div>
    </div>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>
-->

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("en-AU");
</script>


    
    
    
    
    
    

    


<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
    
</body>
</html>